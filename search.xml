<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Java 语法糖</title>
    <url>/1899/11/30/0000-00-00%20Java%20%E8%AF%AD%E6%B3%95%E7%B3%96/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="Java-语法糖"><a href="#Java-语法糖" class="headerlink" title="Java 语法糖"></a><strong>Java 语法糖</strong></h1><p>[TOC]</p>
<h2 id="Java8"><a href="#Java8" class="headerlink" title="Java8"></a>Java8</h2><p>​    <a href="https://www.runoob.com/java/java8-new-features.html">https://www.runoob.com/java/java8-new-features.html</a></p>
<h2 id="Java9"><a href="#Java9" class="headerlink" title="Java9"></a>Java9</h2><p>​    <a href="https://www.runoob.com/java/java9-new-features.html">https://www.runoob.com/java/java9-new-features.html</a></p>
<h3 id="改进的-try-with-resources"><a href="#改进的-try-with-resources" class="headerlink" title="改进的 try-with-resources"></a>改进的 try-with-resources</h3><p>try-with-resources 是 JDK 7 中一个新的异常处理机制，它能够很容易地关闭在 try-catch 语句块中使用的资源。所谓的资源（resource）是指在程序完成后，必须关闭的对象。try-with-resources 语句确保了每个资源在语句结束时关闭。所有实现了 java.lang.AutoCloseable 接口（其中，它包括实现了 java.io.Closeable 的所有对象），可以使用作为资源。</p>
<p>try-with-resources 声明在 JDK 9 已得到改进。如果你已经有一个资源是 final 或等效于 final 变量,您可以在 try-with-resources 语句中使用该变量，而无需在 try-with-resources 语句中声明一个新变量。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BufferedReader br = <span class="keyword">new</span> BufferedReader(inputString);</span><br><span class="line"><span class="keyword">try</span> (BufferedReader br1 = br) &#123;</span><br><span class="line">	<span class="keyword">return</span> br1.readLine();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BufferedReader br = <span class="keyword">new</span> BufferedReader(inputString);</span><br><span class="line"><span class="keyword">try</span> (br) &#123;</span><br><span class="line">	<span class="keyword">return</span> br.readLine();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Java10"><a href="#Java10" class="headerlink" title="Java10"></a>Java10</h2><h3 id="var-局部变量类型推断（JEP-286）"><a href="#var-局部变量类型推断（JEP-286）" class="headerlink" title="var 局部变量类型推断（JEP 286）"></a>var 局部变量类型推断（JEP 286）</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> numbers = List.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>); <span class="comment">// inferred value ArrayList&lt;String&gt;</span></span><br><span class="line"><span class="comment">// Index of Enhanced For Loop</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> number : numbers) &#123;</span><br><span class="line">    System.out.println(number);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Local variable declared in a loop</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; numbers.size(); i++) &#123;</span><br><span class="line">    System.out.println(numbers.get(i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    </p>
<h2 id="Java14"><a href="#Java14" class="headerlink" title="Java14"></a><strong>Java14</strong></h2><h3 id="instanceof-模式匹配"><a href="#instanceof-模式匹配" class="headerlink" title="instanceof 模式匹配        "></a><strong>instanceof 模式匹配</strong>        <!--14预览 15正式--></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">demo</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;            	<span class="comment">// comparison</span></span><br><span class="line">        String s = (String) obj;              	<span class="comment">// New variable &amp; explicit casting</span></span><br><span class="line">        System.out.println(s.toUpperCase());  	<span class="comment">// access member</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简写后</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">demo</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String s) &#123;            	<span class="comment">// comparison</span></span><br><span class="line">        System.out.println(s.toUpperCase());  	<span class="comment">// access member</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (obj <span class="keyword">instanceof</span> Keyboard other &amp;&amp; </span><br><span class="line">		model.equals(other.model) &amp;&amp; </span><br><span class="line">		price == other.price);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="Records"><a href="#Records" class="headerlink" title="Records    "></a><strong>Records</strong>    <!--预览--></h3><p>我们先来看看现在我们如何声明一个数据类：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Range</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    private final int min;</span><br><span class="line">    private final int max;</span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="title">Range</span>(<span class="params">int min, int max</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.min = min;</span><br><span class="line">        <span class="built_in">this</span>.max = max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int <span class="function"><span class="title">getMin</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> min;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int <span class="function"><span class="title">getMax</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean <span class="function"><span class="title">equals</span>(<span class="params"><span class="built_in">Object</span> o</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        Range range = (Range) o;</span><br><span class="line">        <span class="keyword">return</span> min == range.min &amp;&amp; max == range.max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int <span class="function"><span class="title">hashCode</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(min, max);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">toString</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Range&#123;&quot;</span> +</span><br><span class="line">          <span class="string">&quot;min=&quot;</span> + min +</span><br><span class="line">          <span class="string">&quot;, max=&quot;</span> + max +</span><br><span class="line">          <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看看这个类的特点：</p>
<ul>
<li>没有无参构造方法，需要初始化时对成员变量赋值</li>
<li>成员变量只有 <strong>getter</strong> 方法。</li>
<li>覆写了 超类 <code>Object</code> 的 <code>equals</code> 、<code>hashCode</code>、<code>toString</code> 方法。</li>
</ul>
<p>虽然我们可以借助于第三方框架或者 <strong>IDE</strong> 很容易编写这些样板代码，但是总归要写这些样板代码不是吗?</p>
<p>上面的冗长的代码在 <strong>Java 14</strong> 中我们可以这么写：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">public record <span class="function"><span class="title">Range</span>(<span class="params">int min, int max</span>)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>没错就是这个简单！这个语法糖是不是有 “卧槽” 的感觉？我们声明这种类使用 <strong>record</strong> 标识（目前不知道 record 会不会上升到关键字的高度）。当你用 <strong>record</strong> 声明一个类时，该类将自动拥有以下功能：</p>
<ul>
<li>获取成员变量的简单方法，以上面代码为例 <code>min()</code> 和 <code>max()</code> 。注意区别于我们平常<strong>getter</strong>的写法。</li>
<li>一个 <code>equals</code> 方法的实现，执行比较时会比较该类的所有成员属性</li>
<li>重写 <code>equals</code> 当然要重写 <code>hashCode</code></li>
<li>一个可以打印该类所有成员属性的 <code>toString</code> 方法。</li>
<li>请注意只会有一个构造方法。</li>
</ul>
<p>因为这个特性是 <strong>preview feature</strong>，默认情况下是无法编译和执行的。同样以上面为例我们需要执行：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$ javac -d classes --enable-preview --release <span class="number">14</span> Range.java</span><br><span class="line">$ java -classpath classes --enable-preview Range</span><br></pre></td></tr></table></figure>

<p>在 <strong>Jshell</strong> 中运行</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">jshell&gt; Range r = <span class="keyword">new</span> Range(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">r ==&gt; Range[min=<span class="number">10</span>, max=<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">jshell&gt; r.min()</span><br><span class="line">$<span class="number">5</span> ==&gt; <span class="number">10</span></span><br><span class="line"></span><br><span class="line">jshell&gt; r.toString()</span><br><span class="line">$<span class="number">6</span> ==&gt; <span class="string">&quot;Range[min=10, max=20]&quot;</span></span><br><span class="line"></span><br><span class="line">jshell&gt; r</span><br><span class="line">r ==&gt; Range[min=<span class="number">10</span>, max=<span class="number">20</span>]</span><br></pre></td></tr></table></figure>

<p>虽然 <strong>record</strong> 声明的类没有 <code>final</code> 关键字，实际上它是一个不可变类。除了一些限制外，它依旧是一个普通的<code>Java</code> 类。因此，我们可以像添加普通类一样添加逻辑。我们可以在构造实例时强制执行前提条件：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">public record <span class="function"><span class="title">Range</span>(<span class="params">int min, int max</span>)</span> &#123;</span><br><span class="line">    public Range &#123;</span><br><span class="line">        <span class="keyword">if</span> (min &gt;= max)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;min should be less than max&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外我们也可以给 <strong>Records</strong> 类增加普通方法、静态属性、静态方法，这里不再举例；</p>
<p><strong>为了简化语法糖的推理，不能在类内声明成员属性。</strong>以下是错误的示范：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">public record <span class="function"><span class="title">Range</span>(<span class="params">int min, int max</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 错误的示范</span></span><br><span class="line">    private <span class="built_in">String</span> name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>语法糖</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaScript简写优化</title>
    <url>/1899/11/30/0000-00-00%20JavaScript%E7%AE%80%E5%86%99%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<span id="more"></span>

<h2 id="1-如果有多个条件"><a href="#1-如果有多个条件" class="headerlink" title="1.如果有多个条件"></a>1.如果有多个条件</h2><p>我们可以在数组中存储多个值，并且可以使用数组 <code>include</code> 方法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Longhand</span><br><span class="line">if (x &#x3D;&#x3D;&#x3D; &#39;abc&#39; || x &#x3D;&#x3D;&#x3D; &#39;def&#39; || x &#x3D;&#x3D;&#x3D; &#39;ghi&#39; || x &#x3D;&#x3D;&#x3D;&#39;jkl&#39;) &#123;</span><br><span class="line">  &#x2F;&#x2F;logic</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Shorthand</span><br><span class="line">if ([&#39;abc&#39;, &#39;def&#39;, &#39;ghi&#39;, &#39;jkl&#39;].includes(x)) &#123;</span><br><span class="line">  &#x2F;&#x2F;logic</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-如果为真…否则简写"><a href="#2-如果为真…否则简写" class="headerlink" title="2.如果为真…否则简写"></a>2.如果为真…否则简写</h2><p>这对于我们有 <code>if-else</code> 条件，里面不包含更大的逻辑时，是一个较大的捷径。我们可以简单的使用三元运算符来实现这个简写。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">let test: boolean;</span><br><span class="line">if (x &gt; 100) &#123;</span><br><span class="line">  test &#x3D; true;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  test &#x3D; false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">let test &#x3D; (x &gt; 10) ? true : false;</span><br><span class="line">&#x2F;&#x2F;or we can use directly</span><br><span class="line">let test &#x3D; x &gt; 10;</span><br><span class="line">console.log(test);</span><br></pre></td></tr></table></figure>

<p>当我们有嵌套条件时，我们可以采用这种方式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let x &#x3D; 300,</span><br><span class="line">test2 &#x3D; (x &gt; 100) ? &#39;greater 100&#39; : (x &lt; 50) ? &#39;less 50&#39; : &#39;between 50 and 100&#39;;</span><br><span class="line">console.log(test2); &#x2F;&#x2F; &quot;greater than 100&quot;</span><br></pre></td></tr></table></figure>

<h2 id="3-声明变量"><a href="#3-声明变量" class="headerlink" title="3.声明变量"></a>3.声明变量</h2><p>当我们要声明两个具有共同值或共同类型的变量时，可以使用此简写形式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Longhand </span><br><span class="line">let test1;</span><br><span class="line">let test2 &#x3D; 1;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Shorthand </span><br><span class="line">let test1, test2 &#x3D; 1;</span><br></pre></td></tr></table></figure>

<h2 id="4-Null-Undefined，空检查"><a href="#4-Null-Undefined，空检查" class="headerlink" title="4.Null, Undefined，空检查"></a>4.Null, Undefined，空检查</h2><p>当我们创建新的变量时，有时我们想检查我们引用的变量的值是否为空或undefined。JavaScript确实有一个非常好的简写工具来实现这些功能。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">if (test1 !&#x3D;&#x3D; null || test1 !&#x3D;&#x3D; undefined || test1 !&#x3D;&#x3D; &#39;&#39;) &#123;</span><br><span class="line">    let test2 &#x3D; test1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">let test2 &#x3D; test1 || &#39;&#39;;</span><br></pre></td></tr></table></figure>

<h2 id="5-null值检查和分配默认值"><a href="#5-null值检查和分配默认值" class="headerlink" title="5.null值检查和分配默认值"></a>5.null值检查和分配默认值</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let test1 &#x3D; null,</span><br><span class="line">    test2 &#x3D; test1 || &#39;&#39;;</span><br><span class="line"></span><br><span class="line">console.log(&quot;null check&quot;, test2); &#x2F;&#x2F; output will be &quot;&quot;</span><br></pre></td></tr></table></figure>

<h2 id="6-undefined值检查和分配默认值"><a href="#6-undefined值检查和分配默认值" class="headerlink" title="6.undefined值检查和分配默认值"></a>6.undefined值检查和分配默认值</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let test1 &#x3D; undefined,</span><br><span class="line">    test2 &#x3D; test1 || &#39;&#39;;</span><br><span class="line"></span><br><span class="line">console.log(&quot;undefined check&quot;, test2); &#x2F;&#x2F; output will be &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>正常值检查</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let test1 &#x3D; &#39;test&#39;,</span><br><span class="line">    test2 &#x3D; test1 || &#39;&#39;;</span><br><span class="line"></span><br><span class="line">console.log(test2); &#x2F;&#x2F; output: &#39;test&#39;</span><br></pre></td></tr></table></figure>

<h2 id="7-将值分配给多个变量"><a href="#7-将值分配给多个变量" class="headerlink" title="7.将值分配给多个变量"></a>7.将值分配给多个变量</h2><p>当我们处理多个变量并希望将不同的值分配给不同的变量时，此简写技术非常有用。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Longhand </span><br><span class="line">let test1, test2, test3;</span><br><span class="line">test1 &#x3D; 1;</span><br><span class="line">test2 &#x3D; 2;</span><br><span class="line">test3 &#x3D; 3;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Shorthand </span><br><span class="line">let [test1, test2, test3] &#x3D; [1, 2, 3];</span><br></pre></td></tr></table></figure>

<h2 id="8-赋值运算符简写"><a href="#8-赋值运算符简写" class="headerlink" title="8.赋值运算符简写"></a>8.赋值运算符简写</h2><p>我们在编程中处理很多算术运算符，这是将运算符分配给JavaScript变量的有用技术之一。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">test1 &#x3D; test1 + 1;</span><br><span class="line">test2 &#x3D; test2 - 1;</span><br><span class="line">test3 &#x3D; test3 * 20;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">test1++;</span><br><span class="line">test2--;</span><br><span class="line">test3 *&#x3D; 20;</span><br></pre></td></tr></table></figure>

<h2 id="9-如果存在简写"><a href="#9-如果存在简写" class="headerlink" title="9.如果存在简写"></a>9.如果存在简写</h2><p>这是我们大家都在使用的常用简写之一，但仍然值得一提。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">if (test1 &#x3D;&#x3D;&#x3D; true) or if (test1 !&#x3D;&#x3D; &quot;&quot;) or if (test1 !&#x3D;&#x3D; null)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand &#x2F;&#x2F;it will check empty string,null and undefined too</span><br><span class="line">if (test1)</span><br></pre></td></tr></table></figure>

<p>注意：如果test1有任何值，它将在if循环后进入逻辑，该运算符主要用于 <code>null</code> 或 <code>undefined</code> 的检查。</p>
<h2 id="10-多个条件的AND（-amp-amp-）运算符"><a href="#10-多个条件的AND（-amp-amp-）运算符" class="headerlink" title="10.多个条件的AND（&amp;&amp;）运算符"></a>10.多个条件的AND（&amp;&amp;）运算符</h2><p>如果仅在变量为 <code>true</code> 的情况下才调用函数，则可以使用 <code>&amp;&amp;</code> 运算符。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Longhand </span><br><span class="line">if (test1) &#123;</span><br><span class="line"> callMethod(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Shorthand </span><br><span class="line">test1 &amp;&amp; callMethod();</span><br></pre></td></tr></table></figure>

<h2 id="11-foreach循环简写"><a href="#11-foreach循环简写" class="headerlink" title="11.foreach循环简写"></a>11.foreach循环简写</h2><p>这是迭代的常用简写技术之一。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">for (var i &#x3D; 0; i &lt; testData.length; i++)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">for (let i in testData) or  for (let i of testData)</span><br></pre></td></tr></table></figure>

<p>每个变量的数组</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function testData(element, index, array) &#123;</span><br><span class="line">  console.log(&#39;test[&#39; + index + &#39;] &#x3D; &#39; + element);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[11, 24, 32].forEach(testData);</span><br><span class="line">&#x2F;&#x2F; logs: test[0] &#x3D; 11, test[1] &#x3D; 24, test[2] &#x3D; 32</span><br></pre></td></tr></table></figure>

<h2 id="12-return中比较"><a href="#12-return中比较" class="headerlink" title="12.return中比较"></a>12.return中比较</h2><p>我们也可以在return语句中使用比较。它将避免我们的5行代码，并将它们减少到1行。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">let test;</span><br><span class="line">function checkReturn() &#123;</span><br><span class="line">  if (!(test &#x3D;&#x3D;&#x3D; undefined)) &#123;</span><br><span class="line">    return test;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return callMe(&#39;test&#39;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">var data &#x3D; checkReturn();</span><br><span class="line">console.log(data); &#x2F;&#x2F;output test</span><br><span class="line">function callMe(val) &#123;</span><br><span class="line">    console.log(val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">function checkReturn() &#123;</span><br><span class="line">    return test || callMe(&#39;test&#39;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="13-箭头函数"><a href="#13-箭头函数" class="headerlink" title="13.箭头函数"></a>13.箭头函数</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Longhand </span><br><span class="line">function add(a, b) &#123; </span><br><span class="line">   return a + b; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Shorthand </span><br><span class="line">const add &#x3D; (a, b) &#x3D;&gt; a + b;</span><br></pre></td></tr></table></figure>

<p>更多示例。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function callMe(name) &#123;</span><br><span class="line">  console.log(&#39;Hello&#39;, name);</span><br><span class="line">&#125;</span><br><span class="line">callMe &#x3D; name &#x3D;&gt;console.log(&#39;Hello&#39;, name);</span><br></pre></td></tr></table></figure>

<h2 id="14-短函数调用"><a href="#14-短函数调用" class="headerlink" title="14.短函数调用"></a>14.短函数调用</h2><p>我们可以使用三元运算符来实现这些功能。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">function test1() &#123;</span><br><span class="line">  console.log(&#39;test1&#39;);</span><br><span class="line">&#125;;</span><br><span class="line">function test2() &#123;</span><br><span class="line">  console.log(&#39;test2&#39;);</span><br><span class="line">&#125;;</span><br><span class="line">var test3 &#x3D; 1;</span><br><span class="line">if (test3 &#x3D;&#x3D; 1) &#123;</span><br><span class="line">  test1();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  test2();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">(test3 &#x3D;&#x3D;&#x3D; 1? test1:test2)();</span><br></pre></td></tr></table></figure>

<h2 id="15-Switch简写"><a href="#15-Switch简写" class="headerlink" title="15. Switch简写"></a>15. Switch简写</h2><p>我们可以将条件保存在键值对象中，并可以根据条件使用。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">switch (data) &#123;</span><br><span class="line">  case1:</span><br><span class="line">    test1();</span><br><span class="line">  break;</span><br><span class="line"></span><br><span class="line">  case2:</span><br><span class="line">    test2();</span><br><span class="line">  break;</span><br><span class="line"></span><br><span class="line">  case3:</span><br><span class="line">    test();</span><br><span class="line">  break;</span><br><span class="line">  &#x2F;&#x2F; And so on...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">var data &#x3D; &#123;</span><br><span class="line">  1: test1,</span><br><span class="line">  2: test2,</span><br><span class="line">  3: test</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">data[something] &amp;&amp; data[something]();</span><br></pre></td></tr></table></figure>

<h2 id="16-隐式返回简写"><a href="#16-隐式返回简写" class="headerlink" title="16.隐式返回简写"></a>16.隐式返回简写</h2><p>使用箭头函数，我们可以直接返回值，而不必编写return语句。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;longhand</span><br><span class="line">function calculate(diameter) &#123;</span><br><span class="line">  returnMath.PI * diameter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand</span><br><span class="line">calculate &#x3D; diameter &#x3D;&gt; (</span><br><span class="line">  Math.PI * diameter;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="17-小数基数指数"><a href="#17-小数基数指数" class="headerlink" title="17.小数基数指数"></a>17.小数基数指数</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">for (var i &#x3D; 0; i &lt; 10000; i++) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">for (var i &#x3D; 0; i &lt; 1e4; i++) &#123;</span><br></pre></td></tr></table></figure>

<h2 id="18-默认参数值"><a href="#18-默认参数值" class="headerlink" title="18.默认参数值"></a>18.默认参数值</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Longhand</span><br><span class="line">function add(test1, test2) &#123;</span><br><span class="line">  if (test1 &#x3D;&#x3D;&#x3D; undefined)</span><br><span class="line">    test1 &#x3D; 1;</span><br><span class="line">  if (test2 &#x3D;&#x3D;&#x3D; undefined)</span><br><span class="line">    test2 &#x3D; 2;</span><br><span class="line">  return test1 + test2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand</span><br><span class="line">add &#x3D; (test1 &#x3D; 1, test2 &#x3D; 2) &#x3D;&gt; (test1 + test2);</span><br><span class="line">add() &#x2F;&#x2F;output: 3</span><br></pre></td></tr></table></figure>

<h2 id="19-扩展运算符简写"><a href="#19-扩展运算符简写" class="headerlink" title="19.扩展运算符简写"></a>19.扩展运算符简写</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;longhand</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; joining arrays using concat</span><br><span class="line">const data &#x3D; [1, 2, 3];</span><br><span class="line">const test &#x3D; [4 ,5 , 6].concat(data);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; joining arrays</span><br><span class="line">const data &#x3D; [1, 2, 3];</span><br><span class="line">const test &#x3D; [4 ,5 , 6, ...data];</span><br><span class="line">console.log(test); &#x2F;&#x2F; [ 4, 5, 6, 1, 2, 3]</span><br></pre></td></tr></table></figure>

<p>对于克隆，我们也可以使用扩展运算符。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;longhand</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; cloning arrays</span><br><span class="line">const test1 &#x3D; [1, 2, 3];</span><br><span class="line">const test2 &#x3D; test1.slice()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; cloning arrays</span><br><span class="line">const test1 &#x3D; [1, 2, 3];</span><br><span class="line">const test2 &#x3D; [...test1];</span><br></pre></td></tr></table></figure>

<h2 id="20-模板文字"><a href="#20-模板文字" class="headerlink" title="20.模板文字"></a>20.模板文字</h2><p>如果您厌倦了在单个字符串中使用 <code>+</code> 来连接多个变量，那么这种简写可以消除您的头痛。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;longhand</span><br><span class="line">const welcome &#x3D; &#39;Hi &#39; + test1 + &#39; &#39; + test2 + &#39;.&#39;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand</span><br><span class="line">const welcome &#x3D; &#96;Hi $&#123;test1&#125; $&#123;test2&#125;&#96;;</span><br></pre></td></tr></table></figure>

<h2 id="21-多行字符串简写"><a href="#21-多行字符串简写" class="headerlink" title="21.多行字符串简写"></a>21.多行字符串简写</h2><p>当我们在代码中处理多行字符串时，可以使用以下功能：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;longhand</span><br><span class="line">const data &#x3D; &#39;abc abc abc abc abc abc\n\t&#39;</span><br><span class="line">    + &#39;test test,test test test test\n\t&#39;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand</span><br><span class="line">const data &#x3D; &#96;abc abc abc abc abc abc</span><br><span class="line">         test test,test test test test&#96;</span><br></pre></td></tr></table></figure>

<h2 id="22-对象属性分配"><a href="#22-对象属性分配" class="headerlink" title="22.对象属性分配"></a>22.对象属性分配</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let test1 &#x3D; &#39;a&#39;; </span><br><span class="line">let test2 &#x3D; &#39;b&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Longhand </span><br><span class="line">let obj &#x3D; &#123;test1: test1, test2: test2&#125;; </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Shorthand </span><br><span class="line">let obj &#x3D; &#123;test1, test2&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="23-将字符串转换成数字"><a href="#23-将字符串转换成数字" class="headerlink" title="23.将字符串转换成数字"></a>23.将字符串转换成数字</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Longhand </span><br><span class="line">let test1 &#x3D; parseInt(&#39;123&#39;); </span><br><span class="line">let test2 &#x3D; parseFloat(&#39;12.3&#39;); </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Shorthand </span><br><span class="line">let test1 &#x3D; +&#39;123&#39;; </span><br><span class="line">let test2 &#x3D; +&#39;12.3&#39;;</span><br></pre></td></tr></table></figure>

<h2 id="24-用解构简写"><a href="#24-用解构简写" class="headerlink" title="24.用解构简写"></a>24.用解构简写</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;longhand</span><br><span class="line">const test1 &#x3D; this.data.test1;</span><br><span class="line">const test2 &#x3D; this.data.test2;</span><br><span class="line">const test2 &#x3D; this.data.test3;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand</span><br><span class="line">const &#123; test1, test2, test3 &#125; &#x3D; this.data;</span><br></pre></td></tr></table></figure>

<h2 id="25-用Array-find简写"><a href="#25-用Array-find简写" class="headerlink" title="25.用Array.find简写"></a>25.用Array.find简写</h2><p>当我们确实有一个对象数组并且我们想要根据对象属性查找特定对象时，find方法确实很有用。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const data &#x3D; [</span><br><span class="line">  &#123;</span><br><span class="line">    type: &#39;test1&#39;,</span><br><span class="line">    name: &#39;abc&#39;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    type: &#39;test2&#39;,</span><br><span class="line">    name: &#39;cde&#39;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    type: &#39;test1&#39;,</span><br><span class="line">    name: &#39;fgh&#39;</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br><span class="line">function findtest1(name) &#123;</span><br><span class="line">  for (let i &#x3D; 0; i &lt; data.length; ++i) &#123;</span><br><span class="line">    if (data[i].type &#x3D;&#x3D;&#x3D; &#39;test1&#39; &amp;&amp; data[i].name &#x3D;&#x3D;&#x3D; name) &#123;</span><br><span class="line">      return data[i];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Shorthand</span><br><span class="line">filteredData &#x3D; data.find(data &#x3D;&gt; data.type &#x3D;&#x3D;&#x3D; &#39;test1&#39; &amp;&amp; data.name &#x3D;&#x3D;&#x3D; &#39;fgh&#39;);</span><br><span class="line">console.log(filteredData); &#x2F;&#x2F; &#123; type: &#39;test1&#39;, name: &#39;fgh&#39; &#125;</span><br></pre></td></tr></table></figure>

<h2 id="26-查找条件简写"><a href="#26-查找条件简写" class="headerlink" title="26.查找条件简写"></a>26.查找条件简写</h2><p>如果我们有代码来检查类型，根据类型需要调用不同的方法，我们可以选择使用多个else ifs或者switch，但是如果我们有比这更好的简写方法呢？</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">if (type &#x3D;&#x3D;&#x3D; &#39;test1&#39;) &#123;</span><br><span class="line">  test1();</span><br><span class="line">&#125;</span><br><span class="line">elseif (type &#x3D;&#x3D;&#x3D; &#39;test2&#39;) &#123;</span><br><span class="line">  test2();</span><br><span class="line">&#125;</span><br><span class="line">elseif (type &#x3D;&#x3D;&#x3D; &#39;test3&#39;) &#123;</span><br><span class="line">  test3();</span><br><span class="line">&#125;</span><br><span class="line">elseif (type &#x3D;&#x3D;&#x3D; &#39;test4&#39;) &#123;</span><br><span class="line">  test4();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  thrownewError(&#39;Invalid value &#39; + type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">var types &#x3D; &#123;</span><br><span class="line">  test1: test1,</span><br><span class="line">  test2: test2,</span><br><span class="line">  test3: test3,</span><br><span class="line">  test4: test4</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">var func &#x3D; types[type];</span><br><span class="line">(!func) &amp;&amp; thrownewError(&#39;Invalid value &#39; + type); func();</span><br></pre></td></tr></table></figure>

<h2 id="27-按位索引简写"><a href="#27-按位索引简写" class="headerlink" title="27.按位索引简写"></a>27.按位索引简写</h2><p>当我们遍历数组以查找特定值时，我们确实使用 <code>indexOf()</code> 方法，如果找到更好的方法该怎么办？让我们看看这个例子。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;longhand</span><br><span class="line">if(arr.indexOf(item) &gt; -1) &#123; &#x2F;&#x2F; item found </span><br><span class="line">&#125;</span><br><span class="line">if(arr.indexOf(item) &#x3D;&#x3D;&#x3D; -1) &#123; &#x2F;&#x2F; item not found</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand</span><br><span class="line">if(~arr.indexOf(item)) &#123; &#x2F;&#x2F; item found</span><br><span class="line">&#125;</span><br><span class="line">if(!~arr.indexOf(item)) &#123; &#x2F;&#x2F; item not found</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按位（<code>〜</code>）运算符将返回除-1以外的任何值的真实值。否定它就像做 <code>~~</code> 一样简单。另外，我们也可以使用 <code>include()</code> 函数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (arr.includes(item)) &#123; </span><br><span class="line">	&#x2F;&#x2F; true if the item found</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="28-Object-entries"><a href="#28-Object-entries" class="headerlink" title="28.Object.entries()"></a>28.Object.entries()</h2><p>此函数有助于将对象转换为对象数组。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const data &#x3D; &#123; test1: &#39;abc&#39;, test2: &#39;cde&#39;, test3: &#39;efg&#39; &#125;;</span><br><span class="line">const arr &#x3D; Object.entries(data);</span><br><span class="line">console.log(arr);</span><br><span class="line">&#x2F;** Output:</span><br><span class="line">[ [ &#39;test1&#39;, &#39;abc&#39; ],</span><br><span class="line">  [ &#39;test2&#39;, &#39;cde&#39; ],</span><br><span class="line">  [ &#39;test3&#39;, &#39;efg&#39; ]</span><br><span class="line">]</span><br><span class="line">**&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="29-Object-values"><a href="#29-Object-values" class="headerlink" title="29.Object.values()"></a>29.Object.values()</h2><p>这也是ES8中引入的一项新功能，该功能执行与 <code>Object.entries()</code> 类似的功能，但没有关键部分：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const data &#x3D; &#123; test1: &#39;abc&#39;, test2: &#39;cde&#39; &#125;;</span><br><span class="line">const arr &#x3D; Object.values(data);</span><br><span class="line">console.log(arr);</span><br><span class="line">&#x2F;** Output:</span><br><span class="line">[ &#39;abc&#39;, &#39;cde&#39;]</span><br><span class="line">**&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="30-双按位简写"><a href="#30-双按位简写" class="headerlink" title="30.双按位简写"></a>30.双按位简写</h2><p>双重NOT按位运算符方法仅适用于32位整数）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Longhand</span><br><span class="line">Math.floor(1.9) &#x3D;&#x3D;&#x3D; 1&#x2F;&#x2F; true</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Shorthand</span><br><span class="line">~~1.9 &#x3D;&#x3D;&#x3D; 1&#x2F;&#x2F; true</span><br></pre></td></tr></table></figure>

<h2 id="31-重复一个字符串多次"><a href="#31-重复一个字符串多次" class="headerlink" title="31.重复一个字符串多次"></a>31.重复一个字符串多次</h2><p>要一次又一次地重复相同的字符，我们可以使用for循环并将它们添加到同一循环中，但是如果我们有一个简写方法呢？</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;longhand </span><br><span class="line">let test &#x3D; &#39;&#39;; </span><br><span class="line">for(let i &#x3D; 0; i &lt; 5; i ++) &#123; </span><br><span class="line">  test +&#x3D; &#39;test &#39;; </span><br><span class="line">&#125; </span><br><span class="line">console.log(str); &#x2F;&#x2F; test test test test test </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand </span><br><span class="line">&#39;test &#39;.repeat(5);</span><br></pre></td></tr></table></figure>

<h2 id="32-在数组中查找最大值和最小值"><a href="#32-在数组中查找最大值和最小值" class="headerlink" title="32.在数组中查找最大值和最小值"></a>32.在数组中查找最大值和最小值</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const arr &#x3D; [1, 2, 3]; </span><br><span class="line">Math.max(…arr); &#x2F;&#x2F; 3</span><br><span class="line">Math.min(…arr); &#x2F;&#x2F; 1</span><br></pre></td></tr></table></figure>

<h2 id="33-从字符串中获取字符"><a href="#33-从字符串中获取字符" class="headerlink" title="33.从字符串中获取字符"></a>33.从字符串中获取字符</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let str &#x3D; &#39;abc&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Longhand </span><br><span class="line">str.charAt(2); &#x2F;&#x2F; c</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Shorthand </span><br><span class="line">Note: If we know the index of the array then we can directly use index insted of character.If we are not sure about index it can throwundefined</span><br><span class="line">str[2]; &#x2F;&#x2F; c</span><br></pre></td></tr></table></figure>

<h2 id="34-数学指数幂函数的简写"><a href="#34-数学指数幂函数的简写" class="headerlink" title="34.数学指数幂函数的简写"></a>34.数学指数幂函数的简写</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;longhand</span><br><span class="line">Math.pow(2,3); &#x2F;&#x2F; 8</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shorthand</span><br><span class="line">2**3&#x2F;&#x2F; 8</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>语法糖</tag>
      </tags>
  </entry>
  <entry>
    <title>解决SpringMvc的响应头特别大</title>
    <url>/2015/06/07/2015-06-07-spring-mvc-%E5%93%8D%E5%BA%94%E5%A4%B4%E7%89%B9%E5%88%AB%E5%A4%A7/</url>
    <content><![CDATA[<span id="more"></span>




<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;mvc:annotation-driven&gt;</span><br><span class="line">	&lt;mvc:message-converters&gt;</span><br><span class="line">		&lt;bean class&#x3D;&quot;com.goldpalm.core.spring.mvc.UTF8StringHttpMessageConverter&quot;&gt;</span><br><span class="line">			&lt;property name&#x3D;&quot;writeAcceptCharset&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;</span><br><span class="line">		&lt;&#x2F;bean&gt;</span><br><span class="line">	&lt;&#x2F;mvc:message-converters&gt;</span><br><span class="line">&lt;&#x2F;mvc:annotation-driven&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">添加这段配置</span><br><span class="line">&lt;bean class&#x3D;&quot;com.goldpalm.core.spring.mvc.UTF8StringHttpMessageConverter&quot;&gt;</span><br><span class="line">	&lt;property name&#x3D;&quot;writeAcceptCharset&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.0改为</span><br><span class="line"></span><br><span class="line">&lt;bean class&#x3D;&quot;org.springframework.http.converter.StringHttpMessageConverter&quot;&gt;</span><br><span class="line">	&lt;property name&#x3D;&quot;writeAcceptCharset&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>angularjs ui-router 刷新不缓存</title>
    <url>/2016/12/01/2016-12-01-angularjs-ui-router-%E5%88%B7%E6%96%B0%E4%B8%8D%E7%BC%93%E5%AD%98/</url>
    <content><![CDATA[<span id="more"></span>


<h1 id="angularjs-ui-router-刷新不缓存"><a href="#angularjs-ui-router-刷新不缓存" class="headerlink" title="angularjs ui-router 刷新不缓存"></a>angularjs ui-router 刷新不缓存</h1><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>加了cache:false不行，在页面ui-sref  后面加ui-sref-opts=”{reload:true}”  不行<br>网上的解决方法:$injector.get(‘$templateCache’).removeAll(); or  $templateCache.removeAll();<br>都是一次移除所有缓存 不实际</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;手动移除缓存</span><br><span class="line">$rootScope.$on(&#39;$stateChangeSuccess&#39;,function(event, toState, toParams, fromState, fromParams)&#123;</span><br><span class="line">        	  </span><br><span class="line">   &#x2F;&#x2F;移除模版缓存</span><br><span class="line">  var removeCache &#x3D; function(v)&#123;</span><br><span class="line">    if(typeof(v) &#x3D;&#x3D; &#39;String&#39;)</span><br><span class="line">    $templateCache.remove(v);</span><br><span class="line">  else if(typeof(v) &#x3D;&#x3D;&#39;function&#39;)</span><br><span class="line">    $templateCache.remove(v(toParams));</span><br><span class="line">  &#125;</span><br><span class="line">  if(toState.cache &#x3D;&#x3D;&#x3D; false)&#123;</span><br><span class="line">    if(typeof(toState.templateUrl) !&#x3D; &#39;undefined&#39;)</span><br><span class="line">      removeCache(toState.templateUrl);</span><br><span class="line">    else if(typeof(toState.views) !&#x3D; &#39;undefined&#39;)</span><br><span class="line">      for(var v in toState.views)</span><br><span class="line">        removeCache(toState.views[v].templateUrl);</span><br><span class="line">  &#125;&#x2F;&#x2F;cache</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;配置文件信息</span><br><span class="line">.state(&#39;app.settings.siteManage.details&#39;,&#123;&#x2F;&#x2F;站点管理  未翻译</span><br><span class="line">            	  url:&#39;&#x2F;details&#x2F;:id&#x2F;:type&#39;,</span><br><span class="line">            	  cache:false,</span><br><span class="line">            	  views: &#123;</span><br><span class="line">            		  &quot;header@app&quot; : &#123;</span><br><span class="line">            			  templateUrl : $ctx +&quot;&#x2F;main&#x2F;settings&#x2F;header&quot;</span><br><span class="line">            		  &#125;,</span><br><span class="line">            		  &quot;container@app&quot; : &#123;</span><br><span class="line">            			  templateUrl: function($routeParams)&#123;return &#39;&#x2F;siteManage&#x2F;details&#x2F;&#39;+$routeParams.id+&#39;&#x2F;&#39;+$routeParams.type;&#125;,</span><br><span class="line">                          controller:&#39;SiteManageIndexController&#39;</span><br><span class="line">                      &#125;</span><br><span class="line">            	  &#125;,</span><br><span class="line">            	  resolve:&#123;</span><br><span class="line">            		  deps:[</span><br><span class="line">            		        &#39;$ocLazyLoad&#39;,</span><br><span class="line">            		        function($ocLazyLoad)&#123;</span><br><span class="line">            		        	return $ocLazyLoad.load([&#39;&#x2F;static&#x2F;js&#x2F;controllers&#x2F;SiteManage.js&#39; ]);</span><br><span class="line">            		        &#125;</span><br><span class="line">            		  ]</span><br><span class="line">            	  &#125;</span><br><span class="line">              &#125;)</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>JavaScript</category>
        <category>AngularJs</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>angularjs</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql left join 很慢的问题</title>
    <url>/2020/10/27/2020-10-27%20mysql%20left%20join%20%E5%BE%88%E6%85%A2%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<span id="more"></span>


<h1 id="mysql-left-join-很慢的问题"><a href="#mysql-left-join-很慢的问题" class="headerlink" title="mysql left join 很慢的问题"></a>mysql left join 很慢的问题</h1><p>本地用的mysql 8  线上由于使用的云数据库 是mysql5.7</p>
<p>上一个SQL 本地 mysql 8 就0.0x秒 线上要 30+</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">	a.item_id as itemId,</span><br><span class="line">	e.category_name as firCat,</span><br><span class="line">	f.category_name as secCat,</span><br><span class="line">	c.item_barcode as itemBarcode,</span><br><span class="line">	c.cost_price as costPrice,</span><br><span class="line">	c.item_original_price as itemOriginalPrice,</span><br><span class="line">	c.item_name as itemName,</span><br><span class="line">	b.quantity as quantity,</span><br><span class="line">	a.cost_price as groupCostPrice,</span><br><span class="line">	a.item_original_price as groupItemOriginalPrice,</span><br><span class="line">	a.item_sell_price as groupItemSellPrice</span><br><span class="line">FROM</span><br><span class="line">	mall_app_item a</span><br><span class="line">left JOIN mall_app_item_relevancy b ON (a.item_id &#x3D; b.app_id)</span><br><span class="line">left JOIN mall_item c ON (b.item_id &#x3D; c.item_id)</span><br><span class="line">left JOIN (</span><br><span class="line">	SELECT</span><br><span class="line">		b.item_id,</span><br><span class="line">		a.category_name</span><br><span class="line">	FROM</span><br><span class="line">		mall_item_category a</span><br><span class="line">	LEFT JOIN mall_item_category_relevancy b ON (</span><br><span class="line">		a.category_id &#x3D; b.category_id</span><br><span class="line">	)</span><br><span class="line">	WHERE</span><br><span class="line">		a.parent_id &#x3D; 0</span><br><span class="line">		and a.category_type &#x3D; &#39;1&#39;</span><br><span class="line">) e on (a.item_id &#x3D; e.item_id)</span><br><span class="line">left JOIN (</span><br><span class="line">	SELECT</span><br><span class="line">		b.item_id,</span><br><span class="line">		a.category_name</span><br><span class="line">	FROM</span><br><span class="line">		mall_item_category a</span><br><span class="line">	LEFT JOIN mall_item_category_relevancy b ON (</span><br><span class="line">		a.category_id &#x3D; b.category_id</span><br><span class="line">	)</span><br><span class="line">	WHERE</span><br><span class="line">		a.parent_id !&#x3D; 0</span><br><span class="line">		and a.category_type &#x3D; &#39;1&#39;</span><br><span class="line">) f on (a.item_id &#x3D; f.item_id)</span><br><span class="line"></span><br><span class="line">WHERE</span><br><span class="line">	1 &#x3D; 1</span><br><span class="line">AND a.item_store &#x3D; 48</span><br><span class="line">and a.item_type &#x3D; &#39;0&#39;</span><br></pre></td></tr></table></figure>

<p>↑↑↑↑↑↑这个sql在 mysql 8.x的版本里面执行是正常的 0.0x的耗时 在mysql 5.7 要 30多秒 本机i5-10400 要60秒 数据库整库备份下来的 数据量 商品就400+ 分类也只有400+ 全站只有2000+的数据量</p>
<p>修改为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">	a.item_id as itemId,</span><br><span class="line">	e.category_name as firCat,</span><br><span class="line">	f.category_name as secCat,</span><br><span class="line">	c.item_barcode as itemBarcode,</span><br><span class="line">	c.cost_price as costPrice,</span><br><span class="line">	c.item_original_price as itemOriginalPrice,</span><br><span class="line">	c.item_name as itemName,</span><br><span class="line">	b.quantity as quantity,</span><br><span class="line">	a.cost_price as groupCostPrice,</span><br><span class="line">	a.item_original_price as groupItemOriginalPrice,</span><br><span class="line">	a.item_sell_price as groupItemSellPrice</span><br><span class="line">FROM</span><br><span class="line">	mall_app_item a,</span><br><span class="line">mall_app_item_relevancy b,</span><br><span class="line">mall_item c,</span><br><span class="line">(</span><br><span class="line">	SELECT</span><br><span class="line">		b.item_id,</span><br><span class="line">		a.category_name</span><br><span class="line">	FROM</span><br><span class="line">		mall_item_category a</span><br><span class="line">	LEFT JOIN mall_item_category_relevancy b ON (</span><br><span class="line">		a.category_id &#x3D; b.category_id</span><br><span class="line">	)</span><br><span class="line">	WHERE</span><br><span class="line">		a.parent_id &#x3D; 0</span><br><span class="line">		and a.category_type &#x3D; &#39;1&#39;</span><br><span class="line">) e,</span><br><span class="line">(</span><br><span class="line">	SELECT</span><br><span class="line">		b.item_id,</span><br><span class="line">		a.category_name</span><br><span class="line">	FROM</span><br><span class="line">		mall_item_category a</span><br><span class="line">	LEFT JOIN mall_item_category_relevancy b ON (</span><br><span class="line">		a.category_id &#x3D; b.category_id</span><br><span class="line">	)</span><br><span class="line">	WHERE</span><br><span class="line">		a.parent_id !&#x3D; 0</span><br><span class="line">		and a.category_type &#x3D; &#39;1&#39;</span><br><span class="line">) f</span><br><span class="line">WHERE</span><br><span class="line">	1 &#x3D; 1</span><br><span class="line">and a.item_id &#x3D; b.app_id</span><br><span class="line">and b.item_id &#x3D; c.item_id</span><br><span class="line">and a.item_id &#x3D; e.item_id</span><br><span class="line">and a.item_id &#x3D; f.item_id</span><br><span class="line">AND a.item_store &#x3D; 48</span><br><span class="line">and a.item_type &#x3D; &#39;0&#39;</span><br></pre></td></tr></table></figure>

<p>去掉所有的join 修改为多表查询多个结果集 速度就正常了</p>
<p>但是就有问题了 讲道理 Sql join的效率应该比多表查更高一点的</p>
<blockquote>
<p>在上面语句中，实际上是创建了多张表的笛卡尔积，所有可能的组合都会被创建出来。在笛卡尔连接中，在上面的例子中，如果有1000商品和1000条商品分类记录，这个查询会先产生1000000个结果，然后通过正确的 ID过滤出1000条记录。 这是一种低效利用数据库资源，数据库多做100倍的工作。 在大型数据库中，笛卡尔连接是一个大问题，对两个大表的笛卡尔积会创建数10亿或万亿的记录。</p>
<p>为了避免创建笛卡尔积，应该使用INNER JOIN ：</p>
</blockquote>
]]></content>
      <categories>
        <category>SQL</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring 事务嵌套的问题</title>
    <url>/2020/11/06/2020-11-06%20%20%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<span id="more"></span>


<h1 id="Aop的局限性导致嵌套事务的问题"><a href="#Aop的局限性导致嵌套事务的问题" class="headerlink" title="Aop的局限性导致嵌套事务的问题"></a>Aop的局限性导致嵌套事务的问题</h1><p>事情是这样的:</p>
<p>​    事务都是XML声明拦截 service 包路径下的所有事务</p>
<p>​    由于这次项目 在service上面直接就是Controller</p>
<p>​    不想在 Controller 中编写逻辑代码</p>
<p>​    就想 声明式事务 和 注解事务 同时使用</p>
<p>​    </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title">IDemoService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//xml中声明了 拦截Service包下的所有方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(xxx in xxx)&#123;</span><br><span class="line">        	<span class="keyword">try</span>&#123;</span><br><span class="line">	        	<span class="keyword">this</span>.work(msg); <span class="comment">// *** 代码 1 ***</span></span><br><span class="line">        	&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        		<span class="comment">//不回滚</span></span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//这里的逻辑出错的话需要单独回滚</span></span><br><span class="line">    	<span class="comment">//不回滚for调用的前一个方法的提交</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>按逻辑应该是没问题的</p>
<p>但是调用之后 并不触发work方法的回滚</p>
<p>原因是:</p>
<p>​    Spring Aop 代理的是 IDemoService 这个对象 并不是代理方法 通过 IDemoService 注入的Bean</p>
<p>​    比如 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">IDemoService demoService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">demoService.demo();</span><br><span class="line"><span class="comment">//这样调用  demo是有被切入的</span></span><br><span class="line"><span class="comment">//这个 demoService 是Spring生成的动态对象 x</span></span><br><span class="line"></span><br><span class="line">x 有个 dome方法</span><br><span class="line">x.dome 去调用 DemoServiceImpl.dome</span><br><span class="line">所以 x.dome有被注入事务管理 有被aop切入</span><br><span class="line">而 <span class="keyword">this</span>.work是 原始方法没有过代理对象所以没有被切入</span><br><span class="line"></span><br><span class="line"><span class="comment">// x 的方法有被代理</span></span><br><span class="line"><span class="comment">//而 this.work(msg); 这样调用的 就是DemoServiceImpl 中的work方法 并没有经过代理对象 x</span></span><br><span class="line"><span class="comment">//所以并不会进入Aop</span></span><br><span class="line"><span class="comment">//因此 @Transactional 注解也就不生效了</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>解决方式:</p>
<pre><code>1.   AopContext.currentProxy()  获取当前的代理对象 通过代理对象调用 work方法
 2.   work 写到其他 Service 通过其他Service 调用
</code></pre>
<p>原本以为是 Spring 不能同时使用两种代理方式的问题</p>
<p>找了半天 修改了半天配置 结果是AOP代理的局限性导致的问题 捂脸&gt;_&lt;!!!</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//原来以为是 </span></span><br><span class="line">TransactionInterceptor interceptor = (TransactionInterceptor) event.getApplicationContext().getBean(TransactionInterceptor.class);</span><br><span class="line">interceptor.setTransactionAttributeSources(<span class="keyword">new</span> AnnotationTransactionAttributeSource(),interceptor.getTransactionAttributeSource());</span><br></pre></td></tr></table></figure>

<p>实际上</p>
<p>​    @ImportResource 的XML中 有填写 tx:annotation-driven 就可以同时使用 两种事务管理方式</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>事务</tag>
      </tags>
  </entry>
  <entry>
    <title>Feign Gzip 请求错误</title>
    <url>/2020/11/06/2020-11-25%20%20Feign%20Gzip%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<span id="more"></span>


<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>Feign 请求 响应的项目报错</p>
<p><code> JSON parse error: Illegal character ((CTRL-CHAR, code 31)): only regular white space (\r, \n, \t) is allowed between tokens; nested exception is com.fasterxml.jackson.core.JsonParseException: Illegal character ((CTRL-CHAR, code 31)): only regular white space (\r, \n, \t) is allowed between tokens  at [Source: (PushbackInputStream); line: 1, column: 2]</code></p>
<p>还以为是Json使用的对应不上</p>
<p>截取请求的 InputStream 发现 是Gzip的乱码</p>
<p>原来是 Feign 发送的参数较多 自己启用了 Gzip压缩</p>
<p>但是接受时并没有判断 request.Header 里面有没有 Gzip</p>
<p>查了网上其他的回答</p>
<p><a href="https://www.jianshu.com/p/df37eb5f2169">https://www.jianshu.com/p/df37eb5f2169</a></p>
<p>说是 SpringCloud版升级到Hoxton即可</p>
<p>但我的项目本身 SpringCloud 版本一直都是 Hoxton.SR8</p>
<p>还是不行</p>
<p>想了一下觉得 Feign应该只是封装调用请求的方式</p>
<p>毕竟 提供接口给Feign的方法也能被其他http请求调用</p>
<p>那就直接 搜索一下 Springboot gzip解压http 请求</p>
<h3 id="编写Filter"><a href="#编写Filter" class="headerlink" title="编写Filter"></a>编写Filter</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * GZIP处理Filter</span><br><span class="line"> *&#x2F;</span><br><span class="line">@WebFilter(filterName &#x3D; &quot;httpServletGzipFilter&quot;, urlPatterns &#x3D; &quot;&#x2F;&quot;)</span><br><span class="line">public class HttpServletGzipFilter implements Filter &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void destroy() &#123;&#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123;</span><br><span class="line">        chain.doFilter(new HttpServletRequestWrapper((HttpServletRequest) request), response);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void init(FilterConfig arg0) throws ServletException &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">class HttpServletRequestWrapper extends javax.servlet.http.HttpServletRequestWrapper &#123;</span><br><span class="line">    private HttpServletRequest request;</span><br><span class="line"></span><br><span class="line">    public HttpServletRequestWrapper(HttpServletRequest request) &#123;</span><br><span class="line">        super(request);</span><br><span class="line">        this.request &#x3D; request;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 根据 request header 的 Content-Encoding 判断是否启用 gzip 解压数据流</span><br><span class="line">     * @return</span><br><span class="line">     * @throws IOException</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public ServletInputStream getInputStream() throws IOException &#123;</span><br><span class="line">        ServletInputStream stream &#x3D; request.getInputStream();</span><br><span class="line">        String contentEncoding &#x3D; request.getHeader(&quot;Content-Encoding&quot;);</span><br><span class="line">        if (null !&#x3D; contentEncoding &amp;&amp; contentEncoding.indexOf(&quot;gzip&quot;) !&#x3D; -1) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                final GZIPInputStream gzipInputStream &#x3D; new GZIPInputStream(stream);</span><br><span class="line">                ServletInputStream newStream &#x3D; new ServletInputStream() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public int read() throws IOException &#123;</span><br><span class="line">                        return gzipInputStream.read();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public boolean isFinished() &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public boolean isReady() &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public void setReadListener(ReadListener readListener) &#123;&#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                return newStream;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;uncompress content fail.&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return stream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="注册Filter交给Spring管理"><a href="#注册Filter交给Spring管理" class="headerlink" title="注册Filter交给Spring管理"></a>注册Filter交给Spring管理</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class HttpServletFilterConfig &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 注册 HttpServletFilter</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public FilterRegistrationBean filterRegistrationBean() &#123;</span><br><span class="line">        FilterRegistrationBean registrationBean &#x3D; new FilterRegistrationBean();</span><br><span class="line">        registrationBean.setFilter(new HttpServletGzipFilter());</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; urlPatterns &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        urlPatterns.add(&quot;&#x2F;*&quot;);</span><br><span class="line">        registrationBean.setUrlPatterns(urlPatterns);</span><br><span class="line"></span><br><span class="line">        return registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来按原先的 @RequestBody 即可正常获得数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@MysdInterior</span><br><span class="line">    @PostMapping (&quot;place&quot;)</span><br><span class="line">    @ApiOperation(value &#x3D; &quot;生成订单&quot;, notes &#x3D; &quot;提交订单加入数据库&quot;)</span><br><span class="line">    public PlaceOrderVo place(@RequestBody PlaceOrderVo vo) &#123;</span><br><span class="line">        System.out.println(vo);</span><br><span class="line">            log.info(&quot;mall api 生成订单 ： place()&quot;);</span><br><span class="line">            log.info(&quot;参数 ：&quot; + String.valueOf(JSONUtil.parse(vo)));</span><br><span class="line">        return vo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java</category>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>Feign</tag>
        <tag>Gzip</tag>
      </tags>
  </entry>
  <entry>
    <title>request多次读取</title>
    <url>/2020/11/30/2020-11-30%20%20Request%E5%A4%9A%E6%AC%A1%E8%AF%BB%E5%8F%96%E7%9A%84%E9%97%AE%E9%A2%98%20-%20%E5%89%AF%E6%9C%AC/</url>
    <content><![CDATA[<span id="more"></span>


<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>Feign 请求 响应的项目报错</p>
<p><code> JSON parse error: Illegal character ((CTRL-CHAR, code 31)): only regular white space (\r, \n, \t) is allowed between tokens; nested exception is com.fasterxml.jackson.core.JsonParseException: Illegal character ((CTRL-CHAR, code 31)): only regular white space (\r, \n, \t) is allowed between tokens  at [Source: (PushbackInputStream); line: 1, column: 2]</code></p>
<p>还以为是Json使用的对应不上</p>
<p>截取请求的 InputStream 发现 是Gzip的乱码</p>
<p>原来是 Feign 发送的参数较多 自己启用了 Gzip压缩</p>
<p>但是接受时并没有判断 request.Header 里面有没有 Gzip</p>
<p>查了网上其他的回答</p>
<p><a href="https://www.jianshu.com/p/df37eb5f2169">https://www.jianshu.com/p/df37eb5f2169</a></p>
<p>说是 SpringCloud版升级到Hoxton即可</p>
<p>但我的项目本身 SpringCloud 版本一直都是 Hoxton.SR8</p>
<p>还是不行</p>
<p>想了一下觉得 Feign应该只是封装调用请求的方式</p>
<p>毕竟 提供接口给Feign的方法也能被其他http请求调用</p>
<p>那就直接 搜索一下 Springboot gzip解压http 请求</p>
<h3 id="编写Filter"><a href="#编写Filter" class="headerlink" title="编写Filter"></a>编写Filter</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * GZIP处理Filter</span><br><span class="line"> *&#x2F;</span><br><span class="line">@WebFilter(filterName &#x3D; &quot;httpServletGzipFilter&quot;, urlPatterns &#x3D; &quot;&#x2F;&quot;)</span><br><span class="line">public class HttpServletGzipFilter implements Filter &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void destroy() &#123;&#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123;</span><br><span class="line">        chain.doFilter(new HttpServletRequestWrapper((HttpServletRequest) request), response);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void init(FilterConfig arg0) throws ServletException &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">class HttpServletRequestWrapper extends javax.servlet.http.HttpServletRequestWrapper &#123;</span><br><span class="line">    private HttpServletRequest request;</span><br><span class="line"></span><br><span class="line">    public HttpServletRequestWrapper(HttpServletRequest request) &#123;</span><br><span class="line">        super(request);</span><br><span class="line">        this.request &#x3D; request;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 根据 request header 的 Content-Encoding 判断是否启用 gzip 解压数据流</span><br><span class="line">     * @return</span><br><span class="line">     * @throws IOException</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public ServletInputStream getInputStream() throws IOException &#123;</span><br><span class="line">        ServletInputStream stream &#x3D; request.getInputStream();</span><br><span class="line">        String contentEncoding &#x3D; request.getHeader(&quot;Content-Encoding&quot;);</span><br><span class="line">        if (null !&#x3D; contentEncoding &amp;&amp; contentEncoding.indexOf(&quot;gzip&quot;) !&#x3D; -1) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                final GZIPInputStream gzipInputStream &#x3D; new GZIPInputStream(stream);</span><br><span class="line">                ServletInputStream newStream &#x3D; new ServletInputStream() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public int read() throws IOException &#123;</span><br><span class="line">                        return gzipInputStream.read();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public boolean isFinished() &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public boolean isReady() &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public void setReadListener(ReadListener readListener) &#123;&#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                return newStream;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;uncompress content fail.&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return stream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="注册Filter交给Spring管理"><a href="#注册Filter交给Spring管理" class="headerlink" title="注册Filter交给Spring管理"></a>注册Filter交给Spring管理</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class HttpServletFilterConfig &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 注册 HttpServletFilter</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public FilterRegistrationBean filterRegistrationBean() &#123;</span><br><span class="line">        FilterRegistrationBean registrationBean &#x3D; new FilterRegistrationBean();</span><br><span class="line">        registrationBean.setFilter(new HttpServletGzipFilter());</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; urlPatterns &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        urlPatterns.add(&quot;&#x2F;*&quot;);</span><br><span class="line">        registrationBean.setUrlPatterns(urlPatterns);</span><br><span class="line"></span><br><span class="line">        return registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来按原先的 @RequestBody 即可正常获得数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@MysdInterior</span><br><span class="line">    @PostMapping (&quot;place&quot;)</span><br><span class="line">    @ApiOperation(value &#x3D; &quot;生成订单&quot;, notes &#x3D; &quot;提交订单加入数据库&quot;)</span><br><span class="line">    public PlaceOrderVo place(@RequestBody PlaceOrderVo vo) &#123;</span><br><span class="line">        System.out.println(vo);</span><br><span class="line">            log.info(&quot;mall api 生成订单 ： place()&quot;);</span><br><span class="line">            log.info(&quot;参数 ：&quot; + String.valueOf(JSONUtil.parse(vo)));</span><br><span class="line">        return vo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>RequestBody</tag>
      </tags>
  </entry>
  <entry>
    <title>优化SQL Group By</title>
    <url>/2020/12/02/2020-12-02%20%E4%BC%98%E5%8C%96SQL%20Group%20By/</url>
    <content><![CDATA[<span id="more"></span>


<h3 id="SQL-Group-By-复杂查询"><a href="#SQL-Group-By-复杂查询" class="headerlink" title="SQL Group By 复杂查询"></a>SQL Group By 复杂查询</h3><p>MySql 5.7以前支持 group by 查询的字段不在 group by 的字段中 默认选第一行 而5.7以后不支持这样的写法 同事就写出了以下的代码</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">                   <span class="built_in">max</span>(mi.item_name),</span><br><span class="line">                   <span class="built_in">max</span>(mi.item_unit),</span><br><span class="line">                   <span class="built_in">max</span>(mi.item_specification),</span><br><span class="line">                   <span class="built_in">max</span>(mi.item_pics),</span><br><span class="line">                   sc.item_barcode,</span><br><span class="line">                   IF(scuh.use_type <span class="operator">=</span> <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;0&#x27;</span>) use_type,</span><br><span class="line">                   <span class="built_in">SUM</span>(scuh.purchase_num) <span class="keyword">AS</span> quantity</span><br><span class="line">                   <span class="keyword">FROM</span></span><br><span class="line">                   shop_card_use_history scuh</span><br><span class="line">                   <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> shop_card sc <span class="keyword">ON</span> scuh.card_id <span class="operator">=</span> sc.card_id</span><br><span class="line">                   <span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">                     (    </span><br><span class="line">										<span class="keyword">SELECT</span></span><br><span class="line">                         mi.item_barcode,</span><br><span class="line">                         mi.item_pics,</span><br><span class="line">                         item_name,</span><br><span class="line">                         item_store,        </span><br><span class="line">												mi.item_unit,</span><br><span class="line">                         mi.item_specification</span><br><span class="line">                         <span class="keyword">FROM</span> mall_item mi</span><br><span class="line">                         <span class="keyword">WHERE</span> mi.item_id <span class="operator">=</span></span><br><span class="line">                         (</span><br><span class="line">                           <span class="keyword">SELECT</span></span><br><span class="line">                           item_id</span><br><span class="line">                           <span class="keyword">FROM</span> mall_item mi1</span><br><span class="line">                           <span class="keyword">WHERE</span> </span><br><span class="line">                           mi.item_barcode <span class="operator">=</span> mi1.item_barcode <span class="keyword">AND</span> mi.item_store <span class="operator">=</span> mi1.item_store</span><br><span class="line">                           <span class="keyword">ORDER</span> <span class="keyword">BY</span> mi1.item_status <span class="keyword">ASC</span>, IFNULL(mi1.update_time, NOW()) <span class="keyword">DESC</span></span><br><span class="line">                           LIMIT <span class="number">1</span></span><br><span class="line">                         ) </span><br><span class="line">                     ) mi <span class="keyword">ON</span> sc.item_barcode <span class="operator">=</span> mi.item_barcode <span class="keyword">AND</span> scuh.mall_id <span class="operator">=</span> mi.item_store</span><br><span class="line">                   <span class="keyword">WHERE</span> scuh.shop_receipt_id <span class="operator">=</span> &quot;ps_31707080856260608&quot;</span><br><span class="line">                   <span class="keyword">GROUP</span> <span class="keyword">BY</span> sc.item_barcode, scuh.use_type, scuh.mall_id</span><br><span class="line">                   <span class="keyword">ORDER</span> <span class="keyword">BY</span> quantity <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>

<p>应该把 group by 放在里层 外层去关联只需要一行数据的其他表</p>
<p>修改成正常 使用group by的写法</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	b.item_name,</span><br><span class="line">	b.item_unit,</span><br><span class="line">	b.item_specification,</span><br><span class="line">	b.item_pics,</span><br><span class="line">	a.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(</span><br><span class="line">	<span class="keyword">SELECT</span></span><br><span class="line">		scuh.item_barcode,</span><br><span class="line">		sc.item_id,</span><br><span class="line">		scuh.use_type,</span><br><span class="line">		<span class="built_in">sum</span>(scuh.purchase_num)</span><br><span class="line">	<span class="keyword">FROM</span></span><br><span class="line">		shop_card_use_history scuh</span><br><span class="line">		<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> shop_card sc <span class="keyword">ON</span> scuh.card_id <span class="operator">=</span> sc.card_id </span><br><span class="line">	<span class="keyword">WHERE</span></span><br><span class="line">		scuh.shop_receipt_id <span class="operator">=</span> &quot;ps_31707080856260608&quot; </span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">		scuh.item_barcode,</span><br><span class="line">		sc.item_id,</span><br><span class="line">		scuh.use_type</span><br><span class="line">	) a</span><br><span class="line">	<span class="keyword">left</span> <span class="keyword">join</span> mall_item b <span class="keyword">on</span>(a.item_id <span class="operator">=</span> b.item_id)</span><br><span class="line">	<span class="keyword">where</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span></span><br><span class="line">	</span><br></pre></td></tr></table></figure>



<p>再修改 查询最新商品的逻辑 原有的逻辑太复杂 涉及到上架下架 逻辑删除之类的 实际上 item_id 最大的版本 一般就是最新的数据</p>
<p>实在不行 java中处理商品信息也可以</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	b.item_name,</span><br><span class="line">	b.item_unit,</span><br><span class="line">	b.item_specification,</span><br><span class="line">	b.item_pics,</span><br><span class="line">	a.<span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(</span><br><span class="line">	<span class="keyword">SELECT</span></span><br><span class="line">		scuh.item_barcode,</span><br><span class="line">		scuh.use_type,</span><br><span class="line">		<span class="built_in">sum</span>( scuh.purchase_num ) </span><br><span class="line">	<span class="keyword">FROM</span></span><br><span class="line">		shop_card_use_history scuh</span><br><span class="line">		<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> shop_card sc <span class="keyword">ON</span> scuh.card_id <span class="operator">=</span> sc.card_id </span><br><span class="line">	<span class="keyword">WHERE</span></span><br><span class="line">		scuh.shop_receipt_id <span class="operator">=</span> &quot;ps_31707080856260608&quot; </span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">		scuh.item_barcode,</span><br><span class="line">		scuh.use_type </span><br><span class="line">	) a</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">	<span class="keyword">SELECT</span></span><br><span class="line">		mb.<span class="operator">*</span> </span><br><span class="line">	<span class="keyword">FROM</span></span><br><span class="line">		( <span class="keyword">SELECT</span> item_barcode, item_store, <span class="built_in">max</span>( item_id ) <span class="keyword">AS</span> item_id <span class="keyword">FROM</span> mall_item <span class="keyword">GROUP</span> <span class="keyword">BY</span> item_barcode, item_store ) ma</span><br><span class="line">		<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> mall_item mb <span class="keyword">ON</span> ( ma.item_id <span class="operator">=</span> mb.item_id ) </span><br><span class="line">	) b <span class="keyword">ON</span> ( a.item_barcode <span class="operator">=</span> b.item_barcode ) </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	<span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>SQL</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>SQL</tag>
        <tag>Group By</tag>
      </tags>
  </entry>
  <entry>
    <title>Allatori破解</title>
    <url>/2021/01/18/2021-01-18%20Allatori%E7%A0%B4%E8%A7%A3/</url>
    <content><![CDATA[<span id="more"></span>

<p><strong>源代码:<a href="https://github.com/lqs1848/AllatoriCrack">https://github.com/lqs1848/AllatoriCrack</a></strong></p>
<p>根据 <a href="https://www.52pojie.cn/thread-622023-1-1.html">https://www.52pojie.cn/thread-622023-1-1.html</a> 做了一些改进</p>
<p>帖子里面没有具体代码 没有具体实现 QAQ</p>
<p>还要求在ubuntu下反编译</p>
<p>实际操作了一下,要求在ubuntu环境下主要是因为 windows 目录不区分大小写 <strong>Allatori</strong> 都是 iIIii 大小写的i混合的文件名</p>
<p>那用 zip 操作即可</p>
<p>具体流程为:</p>
<p>zip 读取<strong>Allatori</strong>.jar 找到所有的class</p>
<p>使用 javassist 读取class的字节码</p>
<p>判断这个类是否有 THIS_IS_DEMO_VERSION_NOT_FOR_COMMERCIAL_USE 方法</p>
<p>然后替换这个方法的返回值</p>
<p>String 返回值的解密全部条件都带上判断即可</p>
<p>但是要移除</p>
<p>System.out.println()</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">################################################</span><br><span class="line">#                                              #</span><br><span class="line">#        ## #   #    ## ### ### ##  ###        #</span><br><span class="line">#       # # #   #   # #  #  # # # #  #         #</span><br><span class="line">#       ### #   #   ###  #  # # ##   #         #</span><br><span class="line">#       # # ### ### # #  #  ### # # ###        #</span><br><span class="line">#                                              #</span><br><span class="line"># Obfuscation by Allatori Obfuscator v7.6 DEMO #</span><br><span class="line">#                                              #</span><br><span class="line">#           http:&#x2F;&#x2F;www.allatori.com            #</span><br><span class="line">#                                              #</span><br><span class="line">################################################</span><br></pre></td></tr></table></figure>



<p>全部都操作完</p>
<p>简单项目ok</p>
<p>复杂项目加密出错…</p>
<p>查看了一下加密信息</p>
<p>很多的类出现了方法名称重复</p>
<p>大概就是比较长的类</p>
<p>原来是有一个 </p>
<p>​    ALLATORIXDEMO方法</p>
<p>​    还有一个随机英文大小写字符 的方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">m.insertAfter(&quot; if             ($_!&#x3D;null&amp;&amp;!$_.isEmpty()&amp;&amp;$_.equals(\&quot;ALLATORIxDEMO\&quot;)) &#123;\n&quot; +&quot;$_ &#x3D; \&quot;qtfreet00\&quot;;\n&quot; +&quot;&#125;&quot;);</span><br></pre></td></tr></table></figure>

<p>按 qtfreet00 的做法 过滤返回参数是 ALLATORIxDEMO 应该就是可行的 但是不知道为什么 一样被替换了</p>
<p>打印方法入参进行对比</p>
<p>第一行是参数 </p>
<p>第二行是返回值</p>
<p>依次交替</p>
<blockquote>
<p>(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br>(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br>c.m.common.utils.i&amp;<init>&amp;(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br><init><br>(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br>(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br>c.m.common.utils.i&amp;ALLATORIxDEMO&amp;Lcom/mysd/common/utils/MapCache;<br>null<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>null<br>c.m.common.utils.MapCache&amp;keys&amp;()Ljava/util/Set;<br>keys<br>c.m.common.utils.MapCache&amp;put&amp;(Ljava/lang/Object;Ljava/lang/Object;J)Ljava/lang/Object;<br>put<br>c.m.common.utils.MapCache&amp;clear&amp;()V<br>clear<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;Lcom/mysd/common/utils/Callable;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache&amp;reSize&amp;()V<br>reSize<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;JLcom/mysd/common/utils/Callable;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache&amp;put&amp;(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;<br>put<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Lcom/mysd/common/utils/i;)Z<br>null<br>c.m.common.utils.MapCache&amp;remove&amp;(Ljava/lang/Object;)V<br>remove<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache&amp;contains&amp;(Ljava/lang/String;)Z<br>contains<br>c.m.common.utils.MapCache&amp;size&amp;()I<br>size<br>c.m.common.utils.MapCache&amp;<init>&amp;()V<br><init><br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;Lcom/mysd/common/utils/MapEx;<br>null<br>c.m.common.utils.i&amp;ALLATORIxDEMO&amp;Lcom/mysd/common/utils/MapCache;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.i&amp;<init>&amp;(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br><init><br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;Lcom/mysd/common/utils/MapEx;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;keys&amp;()Ljava/util/Set;<br>keys<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;put&amp;(Ljava/lang/Object;Ljava/lang/Object;J)Ljava/lang/Object;<br>put<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;clear&amp;()V<br>clear<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;Lcom/mysd/common/utils/Callable;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;reSize&amp;()V<br>reSize<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;JLcom/mysd/common/utils/Callable;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;put&amp;(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;<br>put<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Lcom/mysd/common/utils/i;)Z<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;remove&amp;(Ljava/lang/Object;)V<br>remove<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;contains&amp;(Ljava/lang/String;)Z<br>contains<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;size&amp;()I<br>size<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;<init>&amp;()V<br><init><br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.i&amp;ALLATORIxDEMO&amp;Lcom/mysd/common/utils/MapCache;<br>ALLATORIxDEMO<br>Lcom/mysd/common/utils/MapCache;<br>null<br>(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br>null<br>Lcom/mysd/common/utils/MapCache;<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.i&amp;<init>&amp;(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br><init><br>(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;reSize&amp;()V<br>reSize<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;put&amp;(Ljava/lang/Object;Ljava/lang/Object;J)Ljava/lang/Object;<br>put<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Lcom/mysd/common/utils/i;)Z<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;Lcom/mysd/common/utils/MapEx;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;JLcom/mysd/common/utils/Callable;)Ljava/lang/Object;<br>get<br>(Lcom/mysd/common/utils/MapCache;Ljava/lang/Object;J)V<br>null<br>Lcom/mysd/common/utils/MapCache;<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>com/mysd/common/utils/MapCache<br>null<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>[INFO] Obfuscation completed. Writing log file…<br>c.m.common.utils.i&amp;ALLATORIxDEMO&amp;Lcom/mysd/common/utils/MapCache;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Lcom/mysd/common/utils/i;)Z<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Lcom/mysd/common/utils/i;)Z<br>“ s=”118” e=”118<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;(Ljava/lang/String;)Ljava/lang/String;<br>ALLATORIxDEMO<br>c.m.common.utils.MapCache&amp;AllatoriDecryptString&amp;(Ljava/lang/String;)Ljava/lang/String;<br>F<br>c.m.common.utils.MapCache&amp;clear&amp;()V<br>clear<br>c.m.common.utils.MapCache&amp;clear&amp;()V<br>“ s=”103” e=”107<br>c.m.common.utils.MapCache&amp;contains&amp;(Ljava/lang/String;)Z<br>contains<br>c.m.common.utils.MapCache&amp;contains&amp;(Ljava/lang/String;)Z<br>“ s=”6” e=”6<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;)Ljava/lang/Object;<br>“ s=”22” e=”233<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;JLcom/mysd/common/utils/Callable;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;JLcom/mysd/common/utils/Callable;)Ljava/lang/Object;<br>“ s=”47” e=”224<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;Lcom/mysd/common/utils/Callable;)Ljava/lang/Object;<br>get<br>c.m.common.utils.MapCache&amp;get&amp;(Ljava/lang/Object;Lcom/mysd/common/utils/Callable;)Ljava/lang/Object;<br>“ s=”115” e=”115<br>c.m.common.utils.MapCache&amp;keys&amp;()Ljava/util/Set;<br>keys<br>c.m.common.utils.MapCache&amp;keys&amp;()Ljava/util/Set;<br>“ s=”72” e=”72<br>c.m.common.utils.MapCache&amp;put&amp;(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;<br>put<br>c.m.common.utils.MapCache&amp;put&amp;(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;<br>“ s=”3” e=”3<br>c.m.common.utils.MapCache&amp;put&amp;(Ljava/lang/Object;Ljava/lang/Object;J)Ljava/lang/Object;<br>put<br>c.m.common.utils.MapCache&amp;put&amp;(Ljava/lang/Object;Ljava/lang/Object;J)Ljava/lang/Object;<br>“ s=”112” e=”210<br>c.m.common.utils.MapCache&amp;reSize&amp;()V<br>reSize<br>c.m.common.utils.MapCache&amp;reSize&amp;()V<br>“ s=”40” e=”190<br>c.m.common.utils.MapCache&amp;remove&amp;(Ljava/lang/Object;)V<br>remove<br>c.m.common.utils.MapCache&amp;remove&amp;(Ljava/lang/Object;)V<br>“ s=”71” e=”209<br>c.m.common.utils.MapCache&amp;size&amp;()I<br>size<br>c.m.common.utils.MapCache&amp;size&amp;()I<br>“ s=”132” e=”230<br>c.m.common.utils.MapCache&amp;ALLATORIxDEMO&amp;Lcom/mysd/common/utils/MapEx;<br>ALLATORIxDEMO</p>
</blockquote>
<p>对比发现 入参带有 AllatoriDecryptString 的是返回 一个随机英文大小写字符</p>
<p>修改判断代码 $_ 前面加上 $1.indexOf(&quot;AllatoriDecryptString&quot;)</p>
<p>搞定收工</p>
]]></content>
      <categories>
        <category>破解</category>
      </categories>
      <tags>
        <tag>Allatori</tag>
        <tag>加密</tag>
      </tags>
  </entry>
  <entry>
    <title>RequestBody读取</title>
    <url>/2021/01/27/2021-01-27%20%20RequestBody%E8%AF%BB%E5%8F%96/</url>
    <content><![CDATA[<span id="more"></span>

<p>requestBody 多次读取</p>
<p>网上的做法一般是</p>
<p>重新封装一个 request</p>
<p>把初始的request的body读取后 重新写入一个 inputStream</p>
<p>如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ReadListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentCachingRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BufferedReader reader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServletInputStream inputStream;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ContentCachingRequestWrapper</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        loadBody(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadBody</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        body = IOUtils.toByteArray(request.getInputStream());</span><br><span class="line">        inputStream = <span class="keyword">new</span> RequestCachingInputStream(body);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getBody() &#123;</span><br><span class="line">        <span class="keyword">return</span> body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> inputStream;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getInputStream();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream, getCharacterEncoding()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestCachingInputStream</span> <span class="keyword">extends</span> <span class="title">ServletInputStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ByteArrayInputStream inputStream;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RequestCachingInputStream</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">            inputStream = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> inputStream.read();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> inputStream.available() == <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadListener</span><span class="params">(ReadListener readlistener)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这个写法有个问题就是 </p>
<p>有些方法使用 parameterMap 获取请求参数的 会获取不到</p>
<p>应该改为</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ReadListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentCachingRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String[]&gt; parameterMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BufferedReader reader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServletInputStream inputStream;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ContentCachingRequestWrapper</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        parameterMap = request.getParameterMap();</span><br><span class="line">        loadBody(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadBody</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        body = IOUtils.toByteArray(request.getInputStream());</span><br><span class="line">        inputStream = <span class="keyword">new</span> RequestCachingInputStream(body);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getBody() &#123;</span><br><span class="line">        <span class="keyword">return</span> body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String[]&gt; getParameterMap() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.parameterMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> inputStream;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getInputStream();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream, getCharacterEncoding()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestCachingInputStream</span> <span class="keyword">extends</span> <span class="title">ServletInputStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ByteArrayInputStream inputStream;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RequestCachingInputStream</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">            inputStream = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> inputStream.read();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> inputStream.available() == <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadListener</span><span class="params">(ReadListener readlistener)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这样就从 parameterMap 里面获取参数的方法也可以在我们自定义的request里面获取都 请求参数了</p>
<p>原因是 request.getParameterMap(); 和 request.getInputStream(); 这两个方法是竞争的</p>
<p>不管调用哪一个 都会执行 readStarted = true;</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>JavaWeb</category>
      </categories>
      <tags>
        <tag>RequestBody</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Aop Cglib Jdk问题</title>
    <url>/2021/02/05/2021-02-05%20Spring%20Aop%20Cglib%20Jdk%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<span id="more"></span>

<p>太乱不看版总结:</p>
<p>​    Spring 的 AOP都是用代理实现的 代理是无法拦截 内部调用</p>
<p>​    如果要拦截内部调用 就得编译时织入(修改字节码 修改目标对象)</p>
<p>SpringBoot2 默认就使用 Cglib 进行 AOP</p>
<p>可以在注入的Bean getClass().getName() 查看 名称肯定都带有 $$EnhancerBySpringCGLIB$$fda183c9</p>
<p>百度 <strong>SpringBoot AOP无法拦截类内部的调用方法</strong> 很多都甩锅JDK代理 说使用Cglib就没问题</p>
<p>现在默认就是 cglib 但使用时还是碰到内部类无法被拦截的问题</p>
<p>实测添加注解</p>
<p>​    <code>@EnableAspectJAutoProxy(exposeProxy=true,proxyTargetClass=true)</code></p>
<p>无效</p>
<p>比如 <a href="https://blog.csdn.net/piaoslowly/article/details/81743692">https://blog.csdn.net/piaoslowly/article/details/81743692</a> 讲的非常详细</p>
<p><a href="https://blog.csdn.net/dm_vincent/article/details/57526325">https://blog.csdn.net/dm_vincent/article/details/57526325</a></p>
<blockquote>
<p>关于动态代理和CGLIB这两种方式的简要总结如下：</p>
<ul>
<li>JDK动态代理(Dynamic Proxy)<ul>
<li>基于标准JDK的动态代理功能</li>
<li>只针对实现了接口的业务对象</li>
</ul>
</li>
<li>CGLIB<ul>
<li>通过动态地对目标对象进行子类化来实现AOP代理，上面截图中的<code>SampleBean$$EnhancerByCGLIB$$1767dd4b</code>即为动态创建的一个子类</li>
<li>需要指定<code>@EnableAspectJAutoProxy(proxyTargetClass = true)</code>来强制使用</li>
<li>当业务对象没有实现任何接口的时候默认会选择CGLIB</li>
</ul>
</li>
</ul>
</blockquote>
<p>Spring 的 AOP 都是基于动态代理</p>
<p>所以是无法解决 内部接口调用</p>
<p>即使是CGLIB也是使用了动态代理</p>
<blockquote>
<p>最大的区别在于两者实现AOP的底层原理不太一样：</p>
<ul>
<li>Spring AOP: 基于代理(Proxying)</li>
<li>AspectJ: 基于字节码操作(Bytecode Manipulation)</li>
</ul>
</blockquote>
<p>如果非要动态调用内部的 就得使用 AspectJ</p>
<p>CGLIB 为什么也不能代理 </p>
<p>这篇文章讲的很详细 </p>
<p><a href="https://blog.csdn.net/luanlouis/article/details/24589193">https://blog.csdn.net/luanlouis/article/details/24589193</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> samples;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.core.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.core.Signature;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Callback;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Factory;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Programmer</span>$$<span class="title">EnhancerByCGLIB</span>$$<span class="title">fa7aa2cd</span> <span class="keyword">extends</span> <span class="title">Programmer</span></span></span><br><span class="line"><span class="class">  <span class="keyword">implements</span> <span class="title">Factory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="comment">//......省略</span></span><br><span class="line">  <span class="keyword">private</span> MethodInterceptor CGLIB$CALLBACK_0;  <span class="comment">// Enchaner传入的methodInterceptor</span></span><br><span class="line">   <span class="comment">// ....省略</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">code</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    MethodInterceptor tmp4_1 = <span class="keyword">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">    <span class="keyword">if</span> (tmp4_1 == <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      tmp4_1;</span><br><span class="line">      CGLIB$BIND_CALLBACKS(<span class="keyword">this</span>);<span class="comment">//若callback 不为空，则调用methodInterceptor 的intercept()方法</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.CGLIB$CALLBACK_0 != <span class="keyword">null</span>)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">      <span class="comment">//如果没有设置callback回调函数，则默认执行父类的方法</span></span><br><span class="line">      <span class="keyword">super</span>.code();</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="comment">//....后续省略</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>CGLIB 生成出来的动态代理类 也不能拦截到你内部调用</p>
<p>因为他也只是继承目标类 并不是修改目标类</p>
<p>AspectJ 就像 <strong>Javassist</strong> 是编译时直接修改了目标类 而不是继承目标对象进行拦截</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Aop</tag>
        <tag>Cglib</tag>
      </tags>
  </entry>
  <entry>
    <title>Java上传文件临时文件目录丢失</title>
    <url>/2021/02/25/2021-02-25%20Java%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E4%B8%A2%E5%A4%B1/</url>
    <content><![CDATA[<span id="more"></span>

<blockquote>
<p>java.lang.RuntimeException: java.nio.file.NoSuchFileException: /tmp/undertow.16318593944131808257.9002/undertow8460611219768761359upload</p>
</blockquote>
<p>上传文件时突然出现此异常</p>
<p>原因网上讲的都很明白</p>
<p>linux 把 tmp 回收了</p>
<p>路径不存在了</p>
<p>不过他们的解决方式都不是我喜欢的</p>
<blockquote>
<p>在 applicaiton.yml(applicaiton.property) 中添加配置 ：</p>
<p>spring:</p>
<p>  servlet:</p>
<p>​    multipart:</p>
<p>​      location: /data/tmp</p>
<p>手动指定目录后，必须保证该目录存在，并有读写的权限，创建该目录 mkdir -p /data/tmp</p>
</blockquote>
<p>在配置文件中加配置还要指定目录 感觉不是很方便</p>
<p>附上我自己的解决方式</p>
<p>在 jar 目录下生成临时文件夹  不会被 linux回收 也不需要指定固定路径</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.MultipartConfigElement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.MultipartConfigFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ResourceUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.unit.DataSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.FileUtil;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	Environment env;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MultipartConfigElement <span class="title">multipartConfigElement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		MultipartConfigFactory factory = <span class="keyword">new</span> MultipartConfigFactory();</span><br><span class="line">		factory.setMaxFileSize(DataSize.parse(<span class="string">&quot;1024MB&quot;</span>));</span><br><span class="line">		factory.setMaxRequestSize(DataSize.parse(<span class="string">&quot;1024MB&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 临时文件存放路径 System.getProperty(&quot;java.io.tmpdir&quot;)</span></span><br><span class="line">		<span class="comment">//factory.setLocation(System.getProperty(&quot;java.io.tmpdir&quot;));</span></span><br><span class="line">		</span><br><span class="line">		String jar_parent = System.getProperty(<span class="string">&quot;user.dir&quot;</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			jar_parent = <span class="keyword">new</span> File(ResourceUtils.getURL(<span class="string">&quot;classpath:&quot;</span>).getPath()).getParentFile().getParentFile().getParent();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//防止项目启动时间过长 /temp 下生成的  /temp/容器名称xxx/ 目录被系统自动回收删除 导致 FileNotFoundException</span></span><br><span class="line">		String path =jar_parent + File.separator + <span class="string">&quot;temp&quot;</span> + File.separator + env.getProperty(<span class="string">&quot;spring.application.name&quot;</span>);</span><br><span class="line">		FileUtil.mkdir(path);</span><br><span class="line">		factory.setLocation(path);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> factory.createMultipartConfig();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
  </entry>
  <entry>
    <title>WebFilter无效问题</title>
    <url>/2021/03/03/2021-03-03%20WebFilter%E6%97%A0%E6%95%88%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<span id="more"></span>

<blockquote>
<p>在springboot应用中自定义Filter时，在Filter上添加<code>@compent</code>注解会使<code>urlPatterns</code>匹配路径变为<code>/*</code>而不是自定义路径</p>
</blockquote>
<p>应该是因为 @<em>WebFilter</em>注解 是由 Servlet3.0 提供的 而不是 spring提供的</p>
<p>所以 spring 添加这个过滤器时没有把<code>urlPatterns</code>信息添加到过滤器中</p>
<h1 id="解决方式："><a href="#解决方式：" class="headerlink" title="解决方式："></a>解决方式：</h1><ol>
<li>移除类上的<code>@compent</code>注解，在启动类上添加<code>@ServletComponentScan</code>注解</li>
<li>不使用<code>@WebFilter</code>方式声明过滤器，使用<code>FilterRegistrationBean</code>在配置类中注入Filter</li>
</ol>
]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>WebFilter</tag>
      </tags>
  </entry>
  <entry>
    <title>Ajax请求合并</title>
    <url>/2021/03/12/2021-03-12%20Ajax%E8%AF%B7%E6%B1%82%E5%90%88%E5%B9%B6/</url>
    <content><![CDATA[<span id="more"></span>


<p>线上项目 首页加载时 请求了9个接口 刷新首页 请求数刷刷的往上涨</p>
<p>没几下就被我的后台限流策略屏蔽了 为了限流能正常工作  便需要把首页的请求进行合并</p>
<p>首先考虑到要不影响线上功能并且改动较小</p>
<p><strong>对原接口不做任何改动</strong></p>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>前端拦截所有Ajax请求 合并统一发送 存储各自的 promise 后端统一返回后再 各自回调</p>
<p>后端提供一个通用接口 /index/wilful  返回多个返回值</p>
<p><strong>请求参数为:</strong> <em>路径和原来的参数</em></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/mp/content/detail&quot;</span>,    <span class="comment">//原请求路径</span></span><br><span class="line">        <span class="attr">&quot;param&quot;</span>: &#123;						 <span class="comment">//原请求参数</span></span><br><span class="line">            <span class="attr">&quot;mallId&quot;</span>: <span class="number">48</span>, </span><br><span class="line">            <span class="attr">&quot;sectionKey&quot;</span>: <span class="string">&quot;home_banner&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &#123;									 <span class="comment">//多个同理</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/game/turntable/details&quot;</span>, </span><br><span class="line">        <span class="attr">&quot;param&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;mallId&quot;</span>: <span class="string">&quot;55&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;itemId&quot;</span>: <span class="string">&quot;111&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;activityId&quot;</span>: <span class="string">&quot;222&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>返回值:</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ver&quot;</span>: <span class="string">&quot;1.1.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;code&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;t&quot;</span>: <span class="number">1618451056360</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;/game/turntable/details&quot;</span>: &#123;		<span class="comment">//对应多个请求的原始url 内部为原始请求的返回值</span></span><br><span class="line">            <span class="attr">&quot;msg&quot;</span>: <span class="string">&quot;success&quot;</span>,				<span class="comment">//只代表此接口的成功失败</span></span><br><span class="line">            <span class="attr">&quot;code&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;turntable&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">                ...</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;prizes&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;id&quot;</span>: <span class="number">12</span>,</span><br><span class="line">                    <span class="attr">&quot;turntableId&quot;</span>: <span class="number">3</span>,</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                    ...</span><br><span class="line">                &#125;,</span><br><span class="line">                ...</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;/mp/content/detail&quot;: &#123;</span><br><span class="line">            &quot;msg&quot;: &quot;success&quot;,</span><br><span class="line">            &quot;total&quot;: 3,</span><br><span class="line">            &quot;code&quot;: 0,</span><br><span class="line">            &quot;rows&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;,</span><br><span class="line">                ...</span><br><span class="line">            ],</span><br><span class="line">            &quot;pageNum&quot;: 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;url&quot;: &quot;/index/wilful&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//把全局 request 全部转发给</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//可以判断一下 只有需要整合的接口才进 group</span></span><br><span class="line">	<span class="keyword">if</span> (options.url != <span class="string">&#x27;/index/wilful&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> uni.$httpGroup.request(&#123;</span><br><span class="line">			path: options.url,</span><br><span class="line">			param: &#123;</span><br><span class="line">				...options.data</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//原有逻辑</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//合并Ajax请求</span></span><br><span class="line"><span class="keyword">const</span> $httpGroup = &#123;</span><br><span class="line">	paramList: [],</span><br><span class="line">	resolveList: [],</span><br><span class="line">	fireRequest (data) &#123;	<span class="comment">//真正的请求</span></span><br><span class="line">		<span class="keyword">return</span> request(&#123;</span><br><span class="line">			url: <span class="string">&#x27;/index/wilful&#x27;</span>,</span><br><span class="line">			header: &#123;</span><br><span class="line">				<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">			&#125;,</span><br><span class="line">			method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">			data</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	request (data) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//获得到第一个请求之后进行定时</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.paramList.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">//收集范围 下面有说明</span></span><br><span class="line">				<span class="built_in">Promise</span>.resolve().then(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">					<span class="keyword">let</span> copyParamList = [...this.paramList];</span><br><span class="line">					<span class="keyword">let</span> copyResolveList = [...this.resolveList];</span><br><span class="line">                    <span class="comment">//清空待请求</span></span><br><span class="line">					<span class="built_in">this</span>.paramList = [];</span><br><span class="line">					<span class="built_in">this</span>.resolveList = [];</span><br><span class="line">                    <span class="comment">//请求合并接口</span></span><br><span class="line">					<span class="built_in">this</span>.fireRequest([</span><br><span class="line">						...copyParamList</span><br><span class="line">					]).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> (res &amp;&amp; res.data) &#123;</span><br><span class="line">                            <span class="comment">//成功回调所有的接口</span></span><br><span class="line">							copyParamList.forEach(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">								copyResolveList[index].resolve(res.data[item.path]);</span><br><span class="line">							&#125;)</span><br><span class="line">						&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">//异常回调</span></span><br><span class="line">							copyParamList.forEach(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">								copyResolveList[index].resolve(&#123;</span><br><span class="line">									code: res.code || <span class="number">500</span>,</span><br><span class="line">									data: <span class="literal">undefined</span>,</span><br><span class="line">									msg: res.msg || <span class="string">&#x27;&#x27;</span></span><br><span class="line">								&#125;);</span><br><span class="line">							&#125;)</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.resolveList.push(&#123;</span><br><span class="line">				resolve,</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="built_in">this</span>.paramList.push(&#123;</span><br><span class="line">				...data</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>收集范围:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//在本轮“事件循环”结束时执行 	JS stack级别</span></span><br><span class="line"><span class="built_in">Promise</span>.resolve()	</span><br><span class="line"></span><br><span class="line"><span class="comment">//在有实现Microtasks的浏览器是Microtasks级别 没有就是 Task级别</span></span><br><span class="line">Vue.prototype.$nextTick(<span class="function">()=&gt;</span>&#123;&#125;)	</span><br><span class="line"></span><br><span class="line"><span class="comment">//在下一轮“事件循环”开始时执行  	Tasks级别</span></span><br><span class="line"><span class="built_in">setTimeout</span>(fn, <span class="number">0</span>)	</span><br></pre></td></tr></table></figure>

<p>更详细可以看 <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/">https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/</a></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结:"></a>小结:</h3><p>大致上就是 把Ajax异步请求收集成一个数组 把整个数组全部提交到后端接口 再全部回调</p>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>后端用 SpringMVC</p>
<p>先写一个工具类 把项目中所有的 Controller 和 Controller 中的 @RequestMapping 整理出来 (不管是 @GetMapping 还是 @GetMapping 都是实现了 @RequestMapping  <!--组合注解-->)</p>
<p>再用反射注入请求参数 并执行 获得返回结果 合并接口后返回</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Lazy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.DefaultParameterNameDiscoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.ParameterNameDiscoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AnnotatedElementUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lqs1848.common.exception.CustomException;</span><br><span class="line"><span class="keyword">import</span> com.lqs1848.common.utils.AopTargetUtils;</span><br><span class="line"><span class="keyword">import</span> com.lqs1848.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.lqs1848.common.utils.bean.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> com.lqs1848.common.utils.bean.StringToClass;</span><br><span class="line"><span class="keyword">import</span> com.lqs1848.common.utils.spring.SpringContextHolder;</span><br><span class="line"><span class="keyword">import</span> com.lqs1848.common.web.domain.R;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1 不考虑 同路径有 get又有post 2 先不考虑路径 &#123;xxx&#125; p 3 只装配基础数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Lazy(true)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebWilfulUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	ParameterNameDiscoverer parameterNameDiscoverer;</span><br><span class="line">	Map&lt;String, Box&gt; map = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostConstruct</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		parameterNameDiscoverer = <span class="keyword">new</span> DefaultParameterNameDiscoverer();</span><br><span class="line">		map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">		Map&lt;String, Object&gt; dealers = SpringContextHolder.getApplicationContext()</span><br><span class="line">				.getBeansWithAnnotation(Controller.class);</span><br><span class="line">		<span class="keyword">for</span> (Object controller : dealers.values()) &#123;</span><br><span class="line">			List&lt;String&gt; basePaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">			Object original = AopTargetUtils.getTarget(controller);</span><br><span class="line">			Class&lt;?&gt; cla = original.getClass();</span><br><span class="line">			RequestMapping anno = AnnotatedElementUtils.getMergedAnnotation(cla, RequestMapping.class);</span><br><span class="line">			<span class="keyword">if</span> (anno != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">for</span> (String path : anno.value()) &#123;</span><br><span class="line">					basePaths.add(getPath(path));</span><br><span class="line">					<span class="comment">//System.out.println(&quot;controller path:&quot; + path);</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (Method m : cla.getMethods()) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (m.getReturnType() == <span class="keyword">null</span> || !m.getReturnType().getName().equals(R.class.getName()))</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 待添加</span></span><br><span class="line">				<span class="comment">// ++++权限校验 feign 专用的方法不能被调用</span></span><br><span class="line">				List&lt;StringBuffer&gt; msbs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">				RequestMapping manno = (RequestMapping) getMethodAnno(m, RequestMapping.class);</span><br><span class="line">				<span class="keyword">if</span> (manno != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (!basePaths.isEmpty()) &#123;</span><br><span class="line">						<span class="keyword">for</span> (String basePath : basePaths) &#123;</span><br><span class="line">							<span class="keyword">for</span> (String path : manno.value()) &#123;</span><br><span class="line">								msbs.add(<span class="keyword">new</span> StringBuffer(basePath).append(getPath(path)));</span><br><span class="line">							&#125; <span class="comment">//</span></span><br><span class="line">						&#125; <span class="comment">//</span></span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">for</span> (String path : manno.value()) &#123;</span><br><span class="line">							msbs.add(<span class="keyword">new</span> StringBuffer(getPath(path)));</span><br><span class="line">						&#125; <span class="comment">//</span></span><br><span class="line">					&#125; <span class="comment">//</span></span><br><span class="line">				&#125; <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">for</span> (StringBuffer sb : msbs) &#123;</span><br><span class="line">					map.put(sb.toString(), <span class="keyword">new</span> Box(m, controller));</span><br><span class="line">				&#125; <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">			&#125; <span class="comment">// for method</span></span><br><span class="line"></span><br><span class="line">		&#125; <span class="comment">// for class</span></span><br><span class="line">	&#125;<span class="comment">// init</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> R <span class="title">getR</span><span class="params">(String path, Map&lt;String, String&gt; paramMap)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Box b = matchingPath(path);</span><br><span class="line">		<span class="keyword">if</span> (b == <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> R.error(<span class="string">&quot;404 Url is Not Find&quot;</span>);</span><br><span class="line"></span><br><span class="line">		Class&lt;?&gt;[] clas = b.getM().getParameterTypes();</span><br><span class="line">		String[] paramStr = parameterNameDiscoverer.getParameterNames(b.getM());</span><br><span class="line"></span><br><span class="line">		List&lt;Object&gt; args = <span class="keyword">new</span> ArrayList&lt;&gt;(clas.length);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; clas.length; x++) &#123;</span><br><span class="line">			args.add(getParam(paramStr[x], clas[x], paramMap));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (R) b.getM().invoke(b.getO(), args.toArray());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (CustomException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> R.error(e.getMessage());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalAccessException | IllegalArgumentException | InvocationTargetException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> R.error(<span class="string">&quot;参数不正确&quot;</span>);</span><br><span class="line">	&#125;<span class="comment">// method</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Object <span class="title">getParam</span><span class="params">(String par, Class&lt;?&gt; cla, Map&lt;String, String&gt; paramMap)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// by Servlet</span></span><br><span class="line">		<span class="keyword">if</span> (cla.isInstance(HttpServletRequest.class))</span><br><span class="line">			<span class="keyword">return</span> ServletUtils.getRequest();</span><br><span class="line">		<span class="keyword">if</span> (cla.isInstance(HttpServletResponse.class))</span><br><span class="line">			<span class="keyword">return</span> ServletUtils.getResponse();</span><br><span class="line">		<span class="keyword">if</span> (cla.isInstance(HttpSession.class))</span><br><span class="line">			<span class="keyword">return</span> ServletUtils.getSession();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// by Name</span></span><br><span class="line">		Object nameParam = StringToClass.call(paramMap.get(par), cla);</span><br><span class="line">		<span class="keyword">if</span> (nameParam != <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> nameParam;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// by POJO by Name</span></span><br><span class="line">		<span class="keyword">if</span> (!cla.getPackageName().startsWith(<span class="string">&quot;java.lang&quot;</span>)) &#123;</span><br><span class="line">			<span class="comment">// 不是基础类型 可以顺便判断一下是不是自己自定义包名下面的类</span></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * try &#123; Object obj = cla.getDeclaredConstructor().newInstance(); BeanMap</span></span><br><span class="line"><span class="comment">			 * beanMap = BeanMap.create(obj); beanMap.putAll(paramMap); return obj; &#125; catch</span></span><br><span class="line"><span class="comment">			 * (InstantiationException | IllegalAccessException | IllegalArgumentException |</span></span><br><span class="line"><span class="comment">			 * InvocationTargetException | NoSuchMethodException | SecurityException e) &#123;</span></span><br><span class="line"><span class="comment">			 * return null; &#125;</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Object pojo = mapToBean(paramMap, cla);</span><br><span class="line">				<span class="keyword">return</span> pojo;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">mapToBean</span><span class="params">(Map&lt;String, String&gt; map, Class&lt;?&gt; beanClass)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Object object = beanClass.getDeclaredConstructor().newInstance();</span><br><span class="line">		List&lt;Field&gt; fields = BeanUtils.getThisToObjectFies(beanClass);</span><br><span class="line">		<span class="keyword">for</span> (Field f : fields) &#123;</span><br><span class="line">			Object value = StringToClass.call(map.get(f.getName()), f.getType());</span><br><span class="line">			<span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">				f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">				f.set(object, value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> object;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 路径匹配</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Box <span class="title">matchingPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 更复杂的 比如 /xxx/&#123;路径参数&#125; 这种的待添加</span></span><br><span class="line">		<span class="keyword">return</span> map.get(path);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (path == <span class="keyword">null</span> || path.isEmpty())</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/&quot;</span>) || path.startsWith(<span class="string">&quot;\\&quot;</span>))</span><br><span class="line">			<span class="keyword">return</span> path;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;/&quot;</span> + path;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Annotation <span class="title">getClassAnno</span><span class="params">(Class&lt;?&gt; cla, Class&lt;? extends Annotation&gt; annotationType)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> AnnotatedElementUtils.getMergedAnnotation(cla, annotationType);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Annotation res = cla.getAnnotation(annotationType); if (res != null) return</span></span><br><span class="line"><span class="comment">		 * res; for (Annotation a : cla.getAnnotations()) &#123; res =</span></span><br><span class="line"><span class="comment">		 * getClassAnno(a.getClass(), annotationType); if (res != null) return res; &#125; //</span></span><br><span class="line"><span class="comment">		 * for return null;</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">	&#125;<span class="comment">// method</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Annotation <span class="title">getMethodAnno</span><span class="params">(Method method, Class&lt;? extends Annotation&gt; annotationType)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> AnnotatedElementUtils.getMergedAnnotation(method, annotationType);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Annotation res = method.getAnnotation(annotationType); if (res != null)</span></span><br><span class="line"><span class="comment">		 * return res; for (Annotation a : method.getAnnotations()) &#123; res =</span></span><br><span class="line"><span class="comment">		 * getClassAnno(a.getClass(), annotationType); if (res != null) return res; &#125; //</span></span><br><span class="line"><span class="comment">		 * for return null;</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">	&#125;<span class="comment">// method</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Data</span></span><br><span class="line">	<span class="meta">@AllArgsConstructor</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Box</span> </span>&#123;</span><br><span class="line">		Method m;</span><br><span class="line">		Object o;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">// class</span></span><br></pre></td></tr></table></figure>

<p>其他工具类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringToClass</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">call</span><span class="params">(String param,Class&lt;?&gt; cla)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.isEmpty(param)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (cla.isAssignableFrom(String.class))</span><br><span class="line">			<span class="keyword">return</span> param;</span><br><span class="line">		<span class="keyword">if</span> (cla.isAssignableFrom(Integer.class) || cla.isAssignableFrom(<span class="keyword">int</span>.class))</span><br><span class="line">			<span class="keyword">return</span> Integer.valueOf(param);</span><br><span class="line">		<span class="keyword">if</span> (cla.isAssignableFrom(Short.class) || cla.isAssignableFrom(<span class="keyword">short</span>.class))</span><br><span class="line">			<span class="keyword">return</span> Short.valueOf(param);</span><br><span class="line">		<span class="keyword">if</span> (cla.isAssignableFrom(Long.class) || cla.isAssignableFrom(<span class="keyword">long</span>.class))</span><br><span class="line">			<span class="keyword">return</span> Long.valueOf(param);</span><br><span class="line">		<span class="keyword">if</span> (cla.isAssignableFrom(Float.class) || cla.isAssignableFrom(<span class="keyword">float</span>.class))</span><br><span class="line">			<span class="keyword">return</span> Float.valueOf(param);</span><br><span class="line">		<span class="keyword">if</span> (cla.isAssignableFrom(Double.class) || cla.isAssignableFrom(<span class="keyword">double</span>.class))</span><br><span class="line">			<span class="keyword">return</span> Double.valueOf(param);</span><br><span class="line">		<span class="keyword">if</span> (cla.isAssignableFrom(BigDecimal.class))</span><br><span class="line">			<span class="keyword">return</span> BigDecimal.valueOf(Double.valueOf(param));</span><br><span class="line">		<span class="keyword">if</span> (cla.isAssignableFrom(Boolean.class) || cla.isAssignableFrom(<span class="keyword">boolean</span>.class))</span><br><span class="line">			<span class="keyword">return</span> Boolean.valueOf(param);</span><br><span class="line">		<span class="keyword">if</span> (cla.isAssignableFrom(Byte.class) || cla.isAssignableFrom(<span class="keyword">byte</span>.class))</span><br><span class="line">			<span class="keyword">return</span> Byte.valueOf(param);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="comment">// class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanUtils</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">beans</span>.<span class="title">BeanUtils</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Field&gt; <span class="title">getThisToObjectFies</span><span class="params">(Class&lt;?&gt; cls)</span> </span>&#123;</span><br><span class="line">		List&lt;Field&gt; res = <span class="keyword">new</span> ArrayList&lt;Field&gt;();</span><br><span class="line">		<span class="keyword">if</span> (cls == <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> res;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			res.addAll(Arrays.asList(cls.getDeclaredFields()));</span><br><span class="line">		&#125; <span class="keyword">while</span> ((cls = cls.getSuperclass()) != <span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;<span class="comment">// getThisToObjectFies</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">GlobalController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Lazy(true)</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> WebWilfulUtils wilfulUtils;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping(&quot;wilful&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> R <span class="title">test</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;WilfulParam&gt; params)</span> </span>&#123;</span><br><span class="line">		Map&lt;String,R&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">		params.forEach(p-&gt;&#123;</span><br><span class="line">			R mr = wilfulUtils.getR(p.getPath(), p.getParam());</span><br><span class="line">			data.put(p.getPath(), mr.pure());	</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="keyword">return</span> R.data(data);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;<span class="comment">// class IndexController</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WilfulParam</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String path;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;String,String&gt; param;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结:"></a>小结:</h3><p>麻烦的几个点是 </p>
<p>​    组合注解的识别 最早是自己实现的 后修改为 使用Spring的AnnotatedElementUtils进行识别</p>
<p>​    方法参数注入 这个真的是特别麻烦 现在的实现 支持注入的参数其实不够多</p>
<p>​    方法参数名的识别也是个大坑  现在先用 Spring的ParameterNameDiscoverer 去识别</p>
<p>还有些路径是不能识别的比如 /xxx/{id}/{xxxid} 这样的路径参数 的 @RequestMapper</p>
<p>暂时没有这样的接口需要合并就先不实现了</p>
<p>花点时间 基本上 所有的接口都可以被反射合并调用</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>JavaScript</tag>
        <tag>Web</tag>
        <tag>Ajax</tag>
        <tag>VUE</tag>
        <tag>反射</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven AssertionError</title>
    <url>/2021/03/19/2021-03-19%20Maven%20AssertionError/</url>
    <content><![CDATA[<span id="more"></span>

<blockquote>
<p>Exception in thread “main” java.lang.AssertionError</p>
</blockquote>
<p>Maven 编译报错</p>
<p>没有给出具体内容</p>
<p>加上forceJavacCompilerUse强制打印出compile的错误信息。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- forceJavacCompilerUse can help to show the location of exact compilation error --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">forceJavacCompilerUse</span>&gt;</span>true<span class="tag">&lt;/<span class="name">forceJavacCompilerUse</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>后面发现是 我引用了 org.junit.jupiter.api.Test; </p>
<p>但是Test在编译时是不引入的</p>
<p>导致编译报错</p>
<p>把使用了 测试类移动到 src/test/java 中即可</p>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
        <tag>Exception</tag>
      </tags>
  </entry>
  <entry>
    <title>分布式 日志追踪 链路追踪</title>
    <url>/2021/03/31/2021-03-31%E5%88%86%E5%B8%83%E5%BC%8F%20%E6%97%A5%E5%BF%97%E8%BF%BD%E8%B8%AA%20%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/</url>
    <content><![CDATA[<span id="more"></span>


<h1 id="日志追踪码传递"><a href="#日志追踪码传递" class="headerlink" title="日志追踪码传递"></a>日志追踪码传递</h1><blockquote>
<p>MDC（Mapped Diagnostic Context，映射调试上下文）是 log4j 和 logback 提供的一种方便在多线程条件下记录日志的功能。MDC 可以看成是一个与当前线程绑定的Map，可以往其中添加键值对。</p>
</blockquote>
<blockquote>
<p>MDC内部使用的是ThreadLocal所以只有本线程才有效</p>
</blockquote>
<p>slf4j MDC源码中 没有用 ThreadLocal 就是普通的Map </p>
<p>使用 ThreadLocal 的是其他的日志框架覆盖 MDC实现</p>
<p>比如 logback 就是在自身的包中覆盖了 org.slf4j 包中的部分类</p>
<p>logback 中的MDC 就是使用 ThreadLocal</p>
<h1 id="在-微服务当前切换-服务传递追踪码"><a href="#在-微服务当前切换-服务传递追踪码" class="headerlink" title="在 微服务当前切换 服务传递追踪码"></a>在 微服务当前切换 服务传递追踪码</h1><h2 id="gateway-网关传递"><a href="#gateway-网关传递" class="headerlink" title="gateway 网关传递"></a>gateway 网关传递</h2><p>直接在转发的请求头中携带即可</p>
<h2 id="Feign-Hystrix"><a href="#Feign-Hystrix" class="headerlink" title="Feign Hystrix"></a>Feign Hystrix</h2><h3 id="网上资料"><a href="#网上资料" class="headerlink" title="网上资料"></a>网上资料</h3><p>网上的写法都是介绍 HystrixRequestVariableDefault </p>
<blockquote>
<p>feign 如果有用 hystrix 传递时有涉及到跨线程 需要使用 HystrixRequestVariableDefault 传递</p>
</blockquote>
<p>或者重写 wrapCallable 方法</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Callable&lt;T&gt; <span class="title">wrapCallable</span><span class="params">(Callable&lt;T&gt; callable)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//TransmittableThreadLocal修饰原有Callable</span></span><br><span class="line">       <span class="keyword">return</span> TtlCallable.get(callable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还需要按最后 去替换线程池 </p>
<p>和 在Configuration配置自定义 HystrixConcurrencyStrategy 替换默认的 HystrixConcurrencyStrategyDefault</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixConfig</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> HystrixConcurrencyStrategy <span class="title">requestContextHystrixConcurrencyStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MyHystrixConcurrencyStrategy();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此处参考了 <a href="https://shanhy.blog.csdn.net/article/details/108668952">https://shanhy.blog.csdn.net/article/details/108668952</a></p>
</blockquote>
<h3 id="实测都不太方便"><a href="#实测都不太方便" class="headerlink" title="实测都不太方便"></a>实测都不太方便</h3><ol>
<li>HystrixRequestVariableDefault 要用 HystrixContextRunnable 或 HystrixContextCallable创建线程才能在线程间传递数据</li>
<li>wrapCallable 测试无效 </li>
</ol>
<h3 id="HystrixInvocationHandler"><a href="#HystrixInvocationHandler" class="headerlink" title="HystrixInvocationHandler"></a>HystrixInvocationHandler</h3><p>阅读源码后发现 wrapCallable 装饰是在 HystrixInvocationHandler.invoke 之前就调用了 </p>
<p>invoke 中 还有一个 HystrixCommand 进行回调</p>
<p>等于是 Hystrix 有两层 调用 第一层时参数还有传递 第二层回调时切换线程导致传递的参数丢失</p>
<p>覆盖 HystrixInvocationHandler 类 调用自定义的 HystrixCommand 进行传参</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Lqs1848HystrixCommand</span>&lt;<span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">R</span>&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String trace;<span class="comment">//你要传递的参数</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="title">Lqs1848HystrixCommand</span><span class="params">(Setter setter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(setter);</span><br><span class="line">		<span class="keyword">this</span>.trace = TraceUtils.getTrace();<span class="comment">//获取到当前线程的值</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> R <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		TraceUtils.setTrace(trace);<span class="comment">//线程池执行时 把值传递给线程池</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> runMain();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			TraceUtils.clear();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> R <span class="title">runMain</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="dubbo-传递"><a href="#dubbo-传递" class="headerlink" title="dubbo 传递"></a>dubbo 传递</h2><p>带隐藏参数即可 在RpcContext 中携带 </p>
<h2 id="父子线程传递"><a href="#父子线程传递" class="headerlink" title="父子线程传递"></a>父子线程传递</h2><p>网上的方法都是 </p>
<blockquote>
<p><a href="https://yanglinwei.blog.csdn.net/article/details/113503577">https://yanglinwei.blog.csdn.net/article/details/113503577</a></p>
<p><a href="https://segmentfault.com/a/1190000020083061">https://segmentfault.com/a/1190000020083061</a></p>
<p><a href="https://juejin.cn/post/6844904128351567885">https://juejin.cn/post/6844904128351567885</a></p>
<p><a href="https://blog.csdn.net/zlt2000/article/details/99641821">https://blog.csdn.net/zlt2000/article/details/99641821</a></p>
</blockquote>
<p>内容都一样也不知道是谁抄谁的</p>
<p>其中最重要的是第一行</p>
<blockquote>
<p>package org.slf4j;</p>
</blockquote>
<p>要覆盖掉 slf4j 中的MDCAdapter</p>
<blockquote>
<p>MDC.mdcAdapter = mdcAdapter;</p>
</blockquote>
<p>这个根本就不重要</p>
<p>只要和 logback 一样实现 把 org.slf4j.impl 实现了就行 重写 StaticMDCBinder 即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticMDCBinder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> StaticMDCBinder SINGLETON = <span class="keyword">new</span> StaticMDCBinder();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StaticMDCBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MDCAdapter <span class="title">getMDCA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//这里替换成功自己的自定义的MDC</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyMDCAdapter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMDCAdapterClassStr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MysdMDCAdapter.class.getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="线程池替换"><a href="#线程池替换" class="headerlink" title="线程池替换"></a>线程池替换</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程池配置</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolConfig</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 核心线程池大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> corePoolSize = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最大可创建的线程数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxPoolSize = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列最大长度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> queueCapacity = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线程池维护线程所允许的空闲时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> keepAliveSeconds = <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;threadPoolTaskExecutor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">threadPoolTaskExecutor</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	MyThreadPoolTaskExecutor executor = <span class="keyword">new</span> MyThreadPoolTaskExecutor();</span><br><span class="line">        executor.setMaxPoolSize(maxPoolSize);</span><br><span class="line">        executor.setCorePoolSize(corePoolSize);</span><br><span class="line">        executor.setQueueCapacity(queueCapacity);</span><br><span class="line">        executor.setKeepAliveSeconds(keepAliveSeconds);</span><br><span class="line">        <span class="comment">// 线程池对拒绝任务(无线程可用)的处理策略</span></span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;<span class="comment">//method</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	@Bean</span></span><br><span class="line"><span class="comment">	public Executor taskExecutor() &#123;</span></span><br><span class="line"><span class="comment">		ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();</span></span><br><span class="line"><span class="comment">		executor.setMaxPoolSize(maxPoolSize);</span></span><br><span class="line"><span class="comment">		executor.setCorePoolSize(corePoolSize);</span></span><br><span class="line"><span class="comment">		executor.setQueueCapacity(queueCapacity);</span></span><br><span class="line"><span class="comment">		executor.setKeepAliveSeconds(keepAliveSeconds);</span></span><br><span class="line"><span class="comment">		// 线程池对拒绝任务(无线程可用)的处理策略</span></span><br><span class="line"><span class="comment">		executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());</span></span><br><span class="line"><span class="comment">		return TtlExecutors.getTtlExecutor(executor);</span></span><br><span class="line"><span class="comment">	&#125;//method</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行周期性或定时任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;scheduledExecutorService&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ScheduledExecutorService <span class="title">scheduledExecutorService</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	ScheduledExecutorService scheduledExecutorService = <span class="keyword">new</span> ScheduledThreadPoolExecutor(corePoolSize,</span><br><span class="line">                <span class="keyword">new</span> BasicThreadFactory.Builder().namingPattern(<span class="string">&quot;schedule-pool-%d&quot;</span>).daemon(<span class="keyword">true</span>).build())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterExecute</span><span class="params">(Runnable r, Throwable t)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.afterExecute(r, t);</span><br><span class="line">                Threads.printException(r, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> TtlExecutors.getTtlScheduledExecutorService(scheduledExecutorService);</span><br><span class="line">    &#125;<span class="comment">//method</span></span><br><span class="line">&#125;<span class="comment">//class</span></span><br></pre></td></tr></table></figure>

<h2 id="Async"><a href="#Async" class="headerlink" title="@Async"></a>@Async</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncConfig</span> <span class="keyword">extends</span> <span class="title">AsyncConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskExecutor threadPoolTaskExecutor;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Executor <span class="title">getAsyncExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//返回你替换过的 executor</span></span><br><span class="line">        <span class="comment">//或者用默认线程池 然后设置 TaskDecorator</span></span><br><span class="line">		<span class="keyword">return</span> threadPoolTaskExecutor;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="MQ传递"><a href="#MQ传递" class="headerlink" title="MQ传递"></a>MQ传递</h2><p>我的mq调用都是用的 json格式数据</p>
<p>传输数据时携带上 追踪码即可</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>跨线程</p>
<p>使用 阿里的 TransmittableThreadLocal </p>
<p>把有提供 回调修饰的方法用 TransmittableThreadLocal提供的工具修饰一下</p>
<p>ThreadLocal&lt;&gt;  替换为 TransmittableThreadLocal&lt;&gt;</p>
<p>再把 所有使用的线程池 换成自己的线程池即可</p>
<p>替换线程池 和 修饰 Callable/Runnable 二者实现其一即可</p>
<p>Hystrix的线程池我就没有替换 而是修饰了 Callable</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
        <tag>日志追踪</tag>
        <tag>分布式</tag>
        <tag>链路追踪</tag>
        <tag>微服务</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 字符集判断</title>
    <url>/2021/04/06/2021-04-06%20Java%20%E5%AD%97%E7%AC%A6%E9%9B%86%E5%88%A4%E6%96%AD/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="Java-字符集判断"><a href="#Java-字符集判断" class="headerlink" title="Java 字符集判断"></a>Java 字符集判断</h1><p>线上项目中有小票打印设备</p>
<p>小票打印的设备 没有做编码判断  小票机 只能打印GB2312的字符</p>
<p>java后台给出的字符又是UTF-8的 部分字符超过GB2312的范围了</p>
<p>百度了半天 关于Java的字符串 编码判断转换 都不能实现我所需要的效果</p>
<p>其实就是 判断 一下 字符是否超过 GB2312 超过就替换为 “□” 这样的方块</p>
<p>防止小票机出错就行了</p>
<p>但是 百度到的都是 编码转换 </p>
<p>比如</p>
<blockquote>
<p>String iso8859 = new String(sb.toString().getBytes(“iso8859-1”));<br>String gbk = new String(sb.toString().getBytes(“gbk”));<br>String utf8 = new String(sb.toString().getBytes(“utf-8”));<br>if(iso8859.equals(sb.toString())){<br>    System.out.println(“iso8859”);<br>}else  if(gbk.equals(sb.toString())){<br>    System.out.println(“gbk”);<br>}else  if(utf8.equals(sb.toString())){<br>    System.out.println(“utf8”);<br>}</p>
</blockquote>
<p>或者</p>
<blockquote>
<p>return new String(str.getBytes(“ISO-8859-1”), “UTF-8”);</p>
</blockquote>
<p>都无法准确的判断 或者转换字符串的编码</p>
<p>实际上得使用</p>
<h2 id="Charset-canEncode"><a href="#Charset-canEncode" class="headerlink" title="Charset.canEncode"></a>Charset.canEncode</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String <span class="title">toGB2312</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>&#123;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    Charset cs = Charset.forName(<span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">    CharsetEncoder encode = cs.newEncoder();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">char</span> x = s.charAt(i);</span><br><span class="line">        <span class="keyword">if</span> (encode.canEncode(x)) &#123;</span><br><span class="line">            sb.append(x);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;□&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题解决~</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>GB2312 的字符太小了 </p>
<p>很多商品其实是繁体字 是有对应的简体字的 虽然不多 但也聊胜于无吧</p>
<p>引入 <a href="https://github.com/program-in-chinese/zhconverter">https://github.com/program-in-chinese/zhconverter</a></p>
<p>其中的 “繁到简单字.properties” 改名为 “toSimple.properties”</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ResourceBundle keyMap = ResourceBundle.getBundle(<span class="string">&quot;toSimple&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String <span class="title">toChineseSimplified</span><span class="params">(<span class="keyword">final</span> String str)</span> </span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (str.length() &gt; <span class="number">1</span> &amp;&amp; keyMap.containsKey(str)) &#123;</span><br><span class="line">        <span class="keyword">return</span> keyMap.getString(str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> c : str.toCharArray()) &#123;</span><br><span class="line">        String ch = String.valueOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如有多个对应字符, 暂时用第一个; 如果没有对应字符, 保留原字符</span></span><br><span class="line">        sb.append(keyMap.containsKey(ch) ? keyMap.getString(ch).charAt(<span class="number">0</span>) : ch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在返回给小票机的接口上添加</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//尝试让更多的字符能被扫码机识别</span></span><br><span class="line">    str = EnCodingUtils.toChineseSimplified(str);</span><br><span class="line">    <span class="comment">//扫码机只能识别 gb2312 不能识别 gb2312 以外的字符 超过范围的用 □ 代替</span></span><br><span class="line">    str = EnCodingUtils.toGB2312(str);</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;字符转换异常&quot;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>搞定收工~</p>
<p><em><strong><center><a href="https://github.com/lqs1848/java_workspace/blob/main/Test/src/org/lqs1848/test/CodeConversion.java">源码</a></center></strong></em></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>gb2312</tag>
        <tag>字符集</tag>
      </tags>
  </entry>
  <entry>
    <title>TensorFlow Java</title>
    <url>/2021/04/14/2021-04-14%20TensorFlow%20Java/</url>
    <content><![CDATA[<span id="more"></span>

<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>先捋清楚 java tensorflow 的依赖关系</p>
<p>Maven集成 Tensorflow</p>
<p>以前是引入 tensorflow 里面是 libtensorflow 和 tensorflow_jni</p>
<p>最新的 tensorflow java 独立于 tensorflow仓库进行更新 </p>
<p>引入要改为 tensorflow-core-platform 里面其实就是 tensorflow-java 和 各个平台的 javacpp</p>
<p>就是 java的Api 和TensorFlow大版本没有关系了 tensorflow java 0.3.0 -&gt; 0.4.0 都是 2.4.1的Tensoflow</p>
<p>以前的 libtensorflow 版本是跟着Tensoflow大版本更新的 </p>
<h2 id="HelloTensorFlow"><a href="#HelloTensorFlow" class="headerlink" title="HelloTensorFlow"></a>HelloTensorFlow</h2><p><a href="https://www.tensorflow.org/install/lang_java?hl=zh_cn">https://www.tensorflow.org/install/lang_java?hl=zh_cn</a></p>
<p>官网给的第一个例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.tensorflow.ConcreteFunction;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.Signature;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.Tensor;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.TensorFlow;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.op.Ops;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.op.core.Placeholder;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.op.math.Add;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.types.TInt32;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloTensorFlow</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Hello TensorFlow &quot;</span> + TensorFlow.version());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> (ConcreteFunction dbl = ConcreteFunction.create(HelloTensorFlow::dbl);</span><br><span class="line">        Tensor&lt;TInt32&gt; x = TInt32.scalarOf(<span class="number">10</span>);</span><br><span class="line">        Tensor&lt;TInt32&gt; dblX = dbl.call(x).expect(TInt32.DTYPE)) &#123;</span><br><span class="line">      System.out.println(x.data().getInt() + <span class="string">&quot; doubled is &quot;</span> + dblX.data().getInt());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Signature <span class="title">dbl</span><span class="params">(Ops tf)</span> </span>&#123;</span><br><span class="line">    Placeholder&lt;TInt32&gt; x = tf.placeholder(TInt32.DTYPE);</span><br><span class="line">    Add&lt;TInt32&gt; dblX = tf.math.add(x, x);</span><br><span class="line">    <span class="keyword">return</span> Signature.builder().input(<span class="string">&quot;x&quot;</span>, x).output(<span class="string">&quot;dbl&quot;</span>, dblX).build();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>这个例子就已经出错了 正确的应该是:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloTensorFlow</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Hello TensorFlow &quot;</span> + TensorFlow.version());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> (ConcreteFunction dbl = ConcreteFunction.create(HelloTensorFlow::dbl);</span><br><span class="line">				TInt32 x = TInt32.scalarOf(<span class="number">10</span>);</span><br><span class="line">				Tensor dblX = dbl.call(x)) &#123;</span><br><span class="line">			System.out.println(x.getInt() + <span class="string">&quot; doubled is &quot;</span> + ((TInt32) dblX).getInt());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Signature <span class="title">dbl</span><span class="params">(Ops tf)</span> </span>&#123;</span><br><span class="line">		Placeholder&lt;TInt32&gt; x = tf.placeholder(TInt32.class);</span><br><span class="line">		Add&lt;TInt32&gt; dblX = tf.math.add(x, x);</span><br><span class="line">		<span class="keyword">return</span> Signature.builder().input(<span class="string">&quot;x&quot;</span>, x).output(<span class="string">&quot;dbl&quot;</span>, dblX).build();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用MAVEN时需要添加 </p>
<p> <code>-Djavacpp.platform=linux-x86_64</code></p>
<p>指定目标平台 </p>
<p>不然 windows linux macos  x86 x64 一堆jar都会被导入</p>
<p><em><strong><center><a href="https://github.com/lqs1848/java_workspace/tree/main/TensorFlow">源码</a></center></strong></em></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>TensorFlow</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>TensorFlow</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenCV Java</title>
    <url>/2021/04/15/2021-04-15%20OpenCV%20Java/</url>
    <content><![CDATA[<span id="more"></span>

<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>Maven集成 OpenCV</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javacv-platform<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>引入的不要是 OpenPnP OpenCV 而是 <a href="https://github.com/bytedeco">bytedeco</a>/<strong><a href="https://github.com/bytedeco/javacv">javacv</a></strong></p>
<p>javacv 自带了各平台 OpenCV   .dll  .so  .o .dylib  不用再自己安装 OpenCV了</p>
<p><strong>无需加载动态库</strong></p>
<blockquote>
<p>URL url = ClassLoader.getSystemResource(“lib/opencv/opencv_java440.dll”);</p>
<p>System.load(url.getPath())</p>
<p>或者 </p>
<p>System.loadLibrary(Core.NATIVE_LIBRARY_NAME);  <em>//加载动态链接库</em></p>
</blockquote>
<p>使用 bytedeco 有一点要注意</p>
<p>OpenCV 原本的 import 路径为  org.opencv</p>
<p>JavaCV import 路径为 org.bytedeco.opencv</p>
<p>路径不是完全对应的  比如 <strong>Imgcodecs</strong></p>
<p>原API 路径为: org.opencv.imgcodecs.Imgcodecs</p>
<p>bytedeco 路径为: org.bytedeco.opencv.global.opencv_imgcodecs</p>
<h2 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h2><p>网上随便找了个示例 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.opencv.core.*;</span><br><span class="line"><span class="keyword">import</span> org.opencv.highgui.HighGui;</span><br><span class="line"><span class="keyword">import</span> org.opencv.imgcodecs.Imgcodecs;</span><br><span class="line"><span class="keyword">import</span> org.opencv.imgproc.Imgproc;</span><br><span class="line"><span class="keyword">import</span> org.opencv.objdetect.CascadeClassifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FaceOpenCV</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// Java 在使用 OpenCV 前必须加载 Core.NATIVE_LIBRARY_NAME 类,否则会报错</span></span><br><span class="line">        System.loadLibrary(Core.NATIVE_LIBRARY_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">face</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1 读取OpenCV自带的人脸识别特征XML文件</span></span><br><span class="line">        CascadeClassifier faceCV = <span class="keyword">new</span> CascadeClassifier(<span class="string">&quot;G:\\SystemSoft\\opencv\\opencv\\sources\\data\\haarcascades\\haarcascade_frontalface_alt.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//2 读取测试图片</span></span><br><span class="line">        Mat image = Imgcodecs.imread(<span class="string">&quot;F:\\workTest\\FaceOpenCVData\\1test.png&quot;</span>);</span><br><span class="line">        <span class="comment">//3 特征匹配</span></span><br><span class="line">        MatOfRect face = <span class="keyword">new</span> MatOfRect();</span><br><span class="line">        faceCV.detectMultiScale(image, face);</span><br><span class="line">        <span class="comment">//4 匹配 Rect 矩阵 数组</span></span><br><span class="line">        Rect[] rects = face.toArray();</span><br><span class="line">        System.out.println(<span class="string">&quot;匹配到&quot;</span> + rects.length + <span class="string">&quot;个人脸&quot;</span>);</span><br><span class="line">        <span class="comment">// 5 为每张识别到的人脸画一个圈</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rects.length; i++) &#123;</span><br><span class="line">            Imgproc.rectangle(image, <span class="keyword">new</span> Point(rects[i].x, rects[i].y), <span class="keyword">new</span> Point(rects[i].x + rects[i].width, rects[i].y + rects[i].height), <span class="keyword">new</span> Scalar(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>));</span><br><span class="line">            Imgproc.putText(image, <span class="string">&quot;FACE&quot;</span>, <span class="keyword">new</span> Point(rects[i].x, rects[i].y), Imgproc.FONT_HERSHEY_SCRIPT_SIMPLEX, <span class="number">1.0</span>, <span class="keyword">new</span> Scalar(<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">1</span>, Imgproc.LINE_AA, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6 展示图片</span></span><br><span class="line">        HighGui.imshow(<span class="string">&quot;人脸识别&quot;</span>, image);</span><br><span class="line">        HighGui.waitKey(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        face();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>用 javacv 修改一下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.global.opencv_imgcodecs;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.global.opencv_imgproc;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Mat;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Point;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Rect;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.RectVector;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Scalar;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_objdetect.CascadeClassifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 1 读取OpenCV自带的人脸识别特征XML文件</span></span><br><span class="line">		<span class="comment">// OpenCV 图像识别库一般位于 opencv\sources\data 下面</span></span><br><span class="line">		CascadeClassifier facebook = <span class="keyword">new</span> CascadeClassifier(<span class="string">&quot;\\data\\haarcascades\\haarcascade_frontalface_alt.xml&quot;</span>);</span><br><span class="line">		<span class="comment">// 2 读取测试图片</span></span><br><span class="line">		Mat image = opencv_imgcodecs.imread(<span class="string">&quot;\\1.jpg&quot;</span>);</span><br><span class="line">		<span class="comment">// 3 特征匹配</span></span><br><span class="line">		RectVector face = <span class="keyword">new</span> RectVector();</span><br><span class="line">		facebook.detectMultiScale(image, face);</span><br><span class="line">		<span class="comment">// 4 匹配 Rect 矩阵 数组</span></span><br><span class="line">		Rect[] rects = face.get();</span><br><span class="line">		System.out.println(<span class="string">&quot;匹配到 &quot;</span> + rects.length + <span class="string">&quot; 个人脸&quot;</span>);</span><br><span class="line">		<span class="comment">// 5 为每张识别到的人脸画一个圈</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rects.length; i++) &#123;</span><br><span class="line">			opencv_imgproc.rectangle(image, <span class="keyword">new</span> Point(rects[i].x(), rects[i].y()),</span><br><span class="line">					<span class="keyword">new</span> Point(rects[i].x() + rects[i].width(), rects[i].y() + rects[i].height()),</span><br><span class="line">					<span class="keyword">new</span> Scalar(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>));</span><br><span class="line">			opencv_imgproc.putText(image, <span class="string">&quot;Human&quot;</span>, <span class="keyword">new</span> Point(rects[i].x(), rects[i].y()),</span><br><span class="line">					opencv_imgproc.FONT_HERSHEY_SCRIPT_SIMPLEX, <span class="number">1.0</span>, <span class="keyword">new</span> Scalar(<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">1</span>,</span><br><span class="line">					opencv_imgproc.LINE_AA, <span class="keyword">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 6 展示图片</span></span><br><span class="line">		<span class="comment">// HighGui.imshow(&quot;人脸识别&quot;, image);</span></span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;\\2.jpg&quot;</span>, image);</span><br><span class="line">		<span class="comment">// HighGui.waitKey(0);</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 MAVEN 时需要添加 </p>
<p> <code>-Djavacpp.platform=linux-x86_64</code></p>
<p>指定目标平台 </p>
<p>不然 windows linux macos  x86 x64 一堆jar都会被导入</p>
<p><em><strong><center><a href="https://github.com/lqs1848/java_workspace/tree/main/opencv">源码</a></center></strong></em></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>OpenCV</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>OpenCV</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql Using join buffer (Block Nested Loop) join</title>
    <url>/2021/04/16/2021-04-16%20%20Mysql%20Using%20join%20buffer%20(Block%20Nested%20Loop)%20join/</url>
    <content><![CDATA[<span id="more"></span>


<h3 id="Mysql-Using-join-buffer-Block-Nested-Loop"><a href="#Mysql-Using-join-buffer-Block-Nested-Loop" class="headerlink" title="Mysql Using join buffer (Block Nested Loop)"></a>Mysql Using join buffer (Block Nested Loop)</h3><p>EXPLAIN  中的 extra 字段 有数据是 Using where; Using join buffer (Block Nested Loop)</p>
<p>1.未建立索引</p>
<p>2.数据类型不一致</p>
<p> 都是 verchar 但是 编码不一致也会导致此问题</p>
<p> 比如一个表的字段是 utf8 编码 另一个是 utf8mb4 编码</p>
]]></content>
      <categories>
        <category>SQL</category>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>SQL</tag>
        <tag>EXPLAIN</tag>
      </tags>
  </entry>
  <entry>
    <title>分组最大N</title>
    <url>/2021/04/16/2021-04-16%20%20%E5%88%86%E7%BB%84%E6%9C%80%E5%A4%A7N/</url>
    <content><![CDATA[<span id="more"></span>


<h3 id="分组最大N"><a href="#分组最大N" class="headerlink" title="分组最大N"></a>分组最大N</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="built_in">MAX</span>(item_id) <span class="keyword">AS</span> item_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	mall_item mi</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	mi.item_barcode,</span><br><span class="line">	mi.item_store</span><br></pre></td></tr></table></figure>

<p>优化为 join</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	i1.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	mall_item i1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> mall_item i2 <span class="keyword">ON</span> (</span><br><span class="line">	i1.item_barcode <span class="operator">=</span> i2.item_barcode</span><br><span class="line">	<span class="keyword">AND</span> i1.item_store <span class="operator">=</span> i2.item_store</span><br><span class="line">	<span class="keyword">AND</span> i1.item_id <span class="operator">&lt;</span> i2.item_id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	i2.item_barcode <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>



<p>起因 数据库监控看到一条慢SQL 耗时1秒多</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    mi.item_id,</span><br><span class="line">    mi.item_barcode,</span><br><span class="line">    mi.item_pics,</span><br><span class="line">    mi.item_name,</span><br><span class="line">    mi.item_store,</span><br><span class="line">    mi.item_unit,</span><br><span class="line">    mi.item_specification,</span><br><span class="line">    sc.item_sell_price,sc.item_original_price,sc.specs_remark,</span><br><span class="line">    sc.item_barcode,sc.source <span class="keyword">as</span> itemType,</span><br><span class="line">    IF(scuh.use_type<span class="operator">=</span><span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;0&#x27;</span>) use_type,</span><br><span class="line">    scuh.purchase_num <span class="keyword">AS</span> quantity,</span><br><span class="line">    scuh.card_id</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line"></span><br><span class="line">    (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">MAX</span>(item_id) <span class="keyword">AS</span> item_id</span><br><span class="line">    <span class="keyword">FROM</span> mall_item mi</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> mi.item_barcode, mi.item_store</span><br><span class="line">    ) tmp</span><br><span class="line">    <span class="keyword">JOIN</span> mall_item mi <span class="keyword">ON</span> tmp.item_id <span class="operator">=</span> mi.item_id</span><br><span class="line">    <span class="keyword">join</span> shop_card sc <span class="keyword">on</span> mi.item_store<span class="operator">=</span>sc.mall_id <span class="keyword">AND</span> mi.item_barcode<span class="operator">=</span>sc.item_barcode</span><br><span class="line">    <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> shop_card_use_history scuh <span class="keyword">ON</span> scuh.purchase_num<span class="operator">&gt;</span><span class="number">0</span> <span class="keyword">and</span> scuh.use_type <span class="operator">!=</span> <span class="string">&#x27;j&#x27;</span> <span class="keyword">and</span> sc.card_id <span class="operator">=</span> scuh.card_id</span><br><span class="line">    <span class="keyword">where</span> scuh.shop_receipt_id <span class="operator">=</span> <span class="string">&#x27;ps_1382892968715325440&#x27;</span></span><br></pre></td></tr></table></figure>

<p>优化后</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  i1.item_id,</span><br><span class="line">  i1.item_barcode,</span><br><span class="line">  i1.item_pics,</span><br><span class="line">  i1.item_name,</span><br><span class="line">  i1.item_store,</span><br><span class="line">  i1.item_unit,</span><br><span class="line">  i1.item_specification,</span><br><span class="line">  sc.item_sell_price,</span><br><span class="line">  sc.item_original_price,</span><br><span class="line">  sc.specs_remark,</span><br><span class="line">  sc.item_barcode,</span><br><span class="line">  sc.source <span class="keyword">AS</span> itemType,</span><br><span class="line"></span><br><span class="line">IF (scuh.use_type <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;0&#x27;</span>) use_type,</span><br><span class="line"> scuh.purchase_num <span class="keyword">AS</span> quantity,</span><br><span class="line"> scuh.card_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  mall_item i1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> mall_item i2 <span class="keyword">ON</span> (</span><br><span class="line">  i1.item_barcode <span class="operator">=</span> i2.item_barcode</span><br><span class="line">  <span class="keyword">AND</span> i1.item_store <span class="operator">=</span> i2.item_store</span><br><span class="line">  <span class="keyword">AND</span> i1.item_id <span class="operator">&lt;</span> i2.item_id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">JOIN</span> shop_card sc <span class="keyword">ON</span> i1.item_store <span class="operator">=</span> sc.mall_id</span><br><span class="line"><span class="keyword">AND</span> i1.item_barcode <span class="operator">=</span> sc.item_barcode</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> shop_card_use_history scuh <span class="keyword">ON</span> scuh.purchase_num <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">AND</span> scuh.use_type <span class="operator">!=</span> <span class="string">&#x27;j&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> sc.card_id <span class="operator">=</span> scuh.card_id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">  scuh.shop_receipt_id <span class="operator">=</span> <span class="string">&#x27;ps_1382892968715325440&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> i2.item_barcode <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>优化完只用几十毫秒</p>
]]></content>
      <categories>
        <category>SQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>SQL</tag>
        <tag>Group By</tag>
      </tags>
  </entry>
  <entry>
    <title>DataBufferLimitException:Exceeded limit on max bytes to buffer</title>
    <url>/2021/05/08/2021-05-08%20Exceeded%20limit%20on%20max%20bytes%20to%20buffer/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="WebFlux-上传文件异常"><a href="#WebFlux-上传文件异常" class="headerlink" title="WebFlux 上传文件异常"></a>WebFlux 上传文件异常</h1><p>错误信息提示</p>
<blockquote>
<p>DataBufferLimitException: Exceeded limit on max bytes to buffer : 262144</p>
</blockquote>
<p>网上随便一搜</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">codec:</span></span><br><span class="line">    <span class="attr">max-in-memory-size:</span> <span class="string">20MB</span></span><br></pre></td></tr></table></figure>

<p>重启项目</p>
<p>报错依旧…</p>
<p>换个解决方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebfluxConfig</span> <span class="keyword">implements</span> <span class="title">WebFluxConfigurer</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> WebClient <span class="title">getWebClientBuilder</span><span class="params">()</span></span>&#123;</span><br><span class="line">	    <span class="keyword">return</span>   WebClient.builder().exchangeStrategies(ExchangeStrategies.builder()</span><br><span class="line">	            .codecs(configurer -&gt; configurer</span><br><span class="line">	                      .defaultCodecs()</span><br><span class="line">	                      .maxInMemorySize(<span class="number">20</span> * <span class="number">1024</span> * <span class="number">1024</span>))</span><br><span class="line">	                    .build())</span><br><span class="line">	                  .build();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureHttpMessageCodecs</span><span class="params">(ServerCodecConfigurer configurer)</span> </span>&#123;</span><br><span class="line">        configurer.defaultCodecs().maxInMemorySize(<span class="number">20</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重启</p>
<p>又报错…</p>
<p>懵逼</p>
<p>仔细研究了一下</p>
<p>发现不是默认的Filter出错而是自己的自定义 Filter出错了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//出错的位置</span></span><br><span class="line">ServerRequest serverRequest = <span class="keyword">new</span> DefaultServerRequest(exchange);</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改为</span></span><br><span class="line">ServerRequest serverRequest = ServerRequest.create(exchange, codecConfigurer.getReaders());</span><br><span class="line"><span class="comment">//codecConfigurer 用spring注入的</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">ServerCodecConfigurer codecConfigurer;</span><br></pre></td></tr></table></figure>



<p>简单讲就是 我自己写的 RequestBodyFilter 用的 Codecs 不是 Spring 注入的</p>
<p>所以之前设置的都没有生效</p>
<p>以前没问题是因为 这个filter 我写了 上传文件的白名单 这次接口刚添加 忘记加白名单了</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>Exception</tag>
        <tag>WebFlux</tag>
      </tags>
  </entry>
  <entry>
    <title>JasperReport (一)项目集成</title>
    <url>/2021/05/19/2021-05-19%20jasperreports1/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="引入依赖包"><a href="#引入依赖包" class="headerlink" title="引入依赖包"></a>引入依赖包</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>	</span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.jasperreports<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jasperreports<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.17.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lowagie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>itext<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.jasperreports<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jasperreports-fonts<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.17.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lowagie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>itext<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itextpdf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>itextpdf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itextpdf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>itext-pdfa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itextpdf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>itext-asian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itextpdf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>font-asian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.1.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.groovy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>groovy-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="添加-PdfReportView"><a href="#添加-PdfReportView" class="headerlink" title="添加 PdfReportView"></a>添加 PdfReportView</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfReportView</span> <span class="keyword">extends</span> <span class="title">AbstractView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_TYPE = <span class="string">&quot;application/pdf&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String templatePath;</span><br><span class="line">    <span class="keyword">private</span> String exportFileName;</span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PdfReportView</span><span class="params">(String templatePath, String exportFileName,Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.templatePath = templatePath;</span><br><span class="line">        <span class="keyword">if</span> (exportFileName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                exportFileName = URLEncoder.encode(exportFileName, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.exportFileName = exportFileName;</span><br><span class="line">        <span class="keyword">this</span>.connection = connection;</span><br><span class="line">        setContentType(CONTENT_TYPE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Map&lt;String, Object&gt; <span class="title">getParamsMap</span><span class="params">(Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">            Object val = map.get(key);</span><br><span class="line">            <span class="keyword">if</span> (val <span class="keyword">instanceof</span> JRDataSource) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                params.put(key, val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> JRDataSource <span class="title">getDataSource</span><span class="params">(Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">            Object val = map.get(key);</span><br><span class="line">            <span class="keyword">if</span> (val <span class="keyword">instanceof</span> JRDataSource) &#123;</span><br><span class="line">                <span class="keyword">return</span> (JRDataSource) map.get(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JREmptyDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(Map&lt;String, Object&gt; map,</span></span></span><br><span class="line"><span class="function"><span class="params">        HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        response.setContentType(getContentType());</span><br><span class="line">        <span class="comment">//response.setContentType(&quot;application/octet-stream&quot;);</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;content-disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + exportFileName + <span class="string">&quot;.pdf&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (InputStream inputStream = Thread.currentThread().getContextClassLoader()</span><br><span class="line">            .getResourceAsStream(templatePath)) &#123;</span><br><span class="line">            <span class="keyword">try</span> (OutputStream ouputStream = response.getOutputStream()) &#123;</span><br><span class="line"></span><br><span class="line">                JasperPrint jasperPrint = JasperFillManager</span><br><span class="line">                    .fillReport(inputStream, getParamsMap(map), connection);</span><br><span class="line"></span><br><span class="line">                JasperExportManager.exportReportToPdfStream(jasperPrint, ouputStream);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//使用了连接池 所以是放回连接池</span></span><br><span class="line">            	connection.close();</span><br><span class="line">			&#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="添加Controller"><a href="#添加Controller" class="headerlink" title="添加Controller"></a>添加Controller</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//引入数据源</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"><span class="meta">@RequestMapping(&quot;pdf&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">pdf</span><span class="params">(<span class="meta">@RequestParam(&quot;type&quot;)</span>String type,<span class="meta">@RequestParam(&quot;orderId&quot;)</span>String id)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">	SysUser user = getLoginUserMust();</span><br><span class="line">	Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	<span class="comment">//模板中的参数</span></span><br><span class="line">	map.put(<span class="string">&quot;gid&quot;</span>, user.getGroupId());</span><br><span class="line">	map.put(<span class="string">&quot;pid&quot;</span>, user.getPlatformId());</span><br><span class="line">	map.put(<span class="string">&quot;orderid&quot;</span>, IdMixUtils.decode(id).longValue());</span><br><span class="line">       <span class="comment">//传递数据库连接</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="keyword">new</span> PdfReportView(<span class="string">&quot;templates/report/&quot;</span>+type+<span class="string">&quot;.jasper&quot;</span>, type, dataSource.getConnection()),map);</span><br><span class="line">   &#125;<span class="comment">//method</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>参考</p>
<p><a href="https://segmentfault.com/a/1190000012526395">https://segmentfault.com/a/1190000012526395</a></p>
</blockquote>
<p>大致与参考内容相差不大 就是多了个传递 数据库连接的动作</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>report</category>
      </categories>
      <tags>
        <tag>jasperreports</tag>
        <tag>ireport</tag>
        <tag>打印</tag>
        <tag>报表</tag>
        <tag>导出PDF</tag>
      </tags>
  </entry>
  <entry>
    <title>JasperReport (二)设计模板</title>
    <url>/2021/05/20/2021-05-20%20jasperreports2/</url>
    <content><![CDATA[<span id="more"></span>

<p>设计工具 选择 Jaspersoft Studio  就是升级版的 IReport(这个需要 jdk1.7 超过1.7无法启动)</p>
<p>大致操作方式:</p>
<blockquote>
<p><a href="https://blog.csdn.net/shiyun123zw/category_7422282.html">https://blog.csdn.net/shiyun123zw/category_7422282.html</a></p>
</blockquote>
<p>遇到的问题:</p>
<h3 id="Dataset-传参"><a href="#Dataset-传参" class="headerlink" title="Dataset 传参"></a>Dataset 传参</h3><p>要传递到 Dataset 中要在引用的地方添加</p>
<p>比如 Table 用了 Dataset </p>
<p>在 table 控件的 Properties -&gt; Dataset -&gt; Parameters </p>
<p><img src="/img/report_1.jpg"></p>
<h3 id="Table-合并单元格"><a href="#Table-合并单元格" class="headerlink" title="Table 合并单元格"></a>Table 合并单元格</h3><p>合并单元格必须用 Group Column</p>
<h3 id="Text-自动换行"><a href="#Text-自动换行" class="headerlink" title="Text 自动换行"></a>Text 自动换行</h3><p>最新版本的 JasperSoft Studio </p>
<p>没有 StretchWith Overflow 这么个属性</p>
<p><a href="https://community.jaspersoft.com/questions/911866/stretch-text-field-data-overflow">https://community.jaspersoft.com/questions/911866/stretch-text-field-data-overflow</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">textField</span> <span class="attr">isStretchWithOverflow</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">reportElement</span> <span class="attr">uuid</span>=<span class="string">&quot;5935ad61-77ec-4b05-84bf-6f72d3dcd0bd&quot;</span> <span class="attr">style</span>=<span class="string">&quot;table&quot;</span> <span class="attr">positionType</span>=<span class="string">&quot;Float&quot;</span> <span class="attr">stretchType</span>=<span class="string">&quot;RelativeToTallestObject&quot;</span> <span class="attr">x</span>=<span class="string">&quot;233&quot;</span> <span class="attr">y</span>=<span class="string">&quot;233&quot;</span> <span class="attr">width</span>=<span class="string">&quot;150&quot;</span> <span class="attr">height</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textElement</span> <span class="attr">textAlignment</span>=<span class="string">&quot;Center&quot;</span> <span class="attr">verticalAlignment</span>=<span class="string">&quot;Middle&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textFieldExpression</span>&gt;</span>&lt;![CDATA[&quot;DP-GI&quot;]]&gt;<span class="tag">&lt;/<span class="name">textFieldExpression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">textField</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>需要在 textField 手动加上 isStretchWithOverflow=”true”</p>
<h1 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h1><p><img src="/img/report_2.jpg"></p>
<p><em><strong><center><a href="/other/demo.jrxml">点击下载 DEMO</a></center></strong></em></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>report</category>
      </categories>
      <tags>
        <tag>jasperreports</tag>
        <tag>打印</tag>
        <tag>报表</tag>
        <tag>导出PDF</tag>
        <tag>Jaspersoft Studio</tag>
      </tags>
  </entry>
  <entry>
    <title>Seata</title>
    <url>/2021/05/25/2021-05-25%20seata/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="nacos-配置"><a href="#nacos-配置" class="headerlink" title="nacos 配置"></a>nacos 配置</h1><p>先创建一个 seata 的 namespace 记录ID a9cfa2b3-71b8-4c99-8a8e-5c31f74787e3</p>
<p>下载 <a href="https://github.com/seata/seata">https://github.com/seata/seata</a></p>
<p>在 seata-develop\script\config-center 目录下</p>
<p>config.txt 根据自己的需要修改 </p>
<blockquote>
<p>我的修改内容为</p>
<p>store 开头都删掉(配置从 nacos 读取了 这个应该也没什么用)</p>
<p>添加  service.vgroupMapping.服务名=default 有几个添加几个 ( 1.4.2 是这样的格式 旧版是其他格式 </p>
<p>等后面项目启动报错了再加也行</p>
</blockquote>
<p>执行 nacos/nacos-config.sh </p>
<blockquote>
<p>sh nacos-config.sh -h 192.168.101.222 -p 8848 -g SEATA_GROUP -t a9cfa2b3-71b8-4c99-8a8e-5c31f74787e3 -u nacos -w nacos</p>
</blockquote>
<p>把 config.txt 的内容导入到 nacos 中 结果如图</p>
<p><img src="/img/seata_1.jpg"></p>
<p>其实内容也就是</p>
<p><img src="/img/seata_2.jpg"></p>
<p>手动一个个添加到nacos也行</p>
<h1 id="docker-部署-seata"><a href="#docker-部署-seata" class="headerlink" title="docker 部署 seata"></a>docker 部署 seata</h1><blockquote>
<p>docker pull seataio/seata-server:1.4.2</p>
<p>docker run –name seata -p 8091:8091 -d  seataio/seata-server:1.4.2</p>
<p>docker cp seata:/seata-server  /home/dockerdata/seata      —–把 seata 的配置文件放到 /home/dockerdata/seata 中</p>
<p>docker stop seata</p>
<p>docker rm seata</p>
</blockquote>
<p>修改 /home/dockerdata/seata/seata-server/resources/registry.conf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="line">  type &#x3D; &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    application &#x3D; &quot;seata-server&quot;</span><br><span class="line">    serverAddr &#x3D; &quot;192.168.101.222:8848&quot;</span><br><span class="line">    group &#x3D; &quot;SEATA_GROUP&quot;</span><br><span class="line">    namespace &#x3D; &quot;a9cfa2b3-71b8-4c99-8a8e-5c31f74787e3&quot;</span><br><span class="line">    cluster &#x3D; &quot;default&quot;</span><br><span class="line">    username &#x3D; &quot;nacos&quot;</span><br><span class="line">    password &#x3D; &quot;nacos&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line">  # file、nacos 、apollo、zk、consul、etcd3</span><br><span class="line">  type &#x3D; &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;192.168.101.222:8848&quot;</span><br><span class="line">    namespace &#x3D; &quot;a9cfa2b3-71b8-4c99-8a8e-5c31f74787e3&quot;</span><br><span class="line">    group &#x3D; &quot;SEATA_GROUP&quot;</span><br><span class="line">    username &#x3D; &quot;nacos&quot;</span><br><span class="line">    password &#x3D; &quot;nacos&quot;</span><br><span class="line">    dataId &#x3D; &quot;seataServer.properties&quot;  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>配置后 重新运行一个以 /home/dockerdata/seata/seata-server/resources 为配置目录的 容器</p>
<blockquote>
<p>docker run -d –name seata-server -it -p 8091:8091 -e SEATA_IP=192.168.101.222 -e SEATA_CONFIG_NAME=file:/root/seata/config/registry -v /home/dockerdata/seata/seata-server/resources:/root/seata/config –net=bridge –restart=always seataio/seata-server:1.4.2;</p>
</blockquote>
<p>到 nacos 的服务中查看 服务列表 是否有 seata-server (记得切换到 seata 命名空间</p>
<h1 id="SpringCloud-整合-Seata"><a href="#SpringCloud-整合-Seata" class="headerlink" title="SpringCloud 整合 Seata"></a>SpringCloud 整合 Seata</h1><h2 id="Maven引入依赖"><a href="#Maven引入依赖" class="headerlink" title="Maven引入依赖"></a>Maven引入依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    //排除掉旧版本 引入最新的 1.4.2</span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置yml"><a href="#配置yml" class="headerlink" title="配置yml"></a>配置yml</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">application-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">my_test_tx_group</span>    <span class="comment">#此处配置自定义的seata事务分组名称</span></span><br><span class="line">  <span class="attr">enable-auto-data-source-proxy:</span> <span class="literal">true</span>    <span class="comment">#开启数据库代理</span></span><br><span class="line">  <span class="comment">#不需要手动去替换 datasource</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">a9cfa2b3-71b8-4c99-8a8e-5c31f74787e3</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.222</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.222</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">a9cfa2b3-71b8-4c99-8a8e-5c31f74787e3</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span>  </span><br></pre></td></tr></table></figure>

<h2 id="创建-undo-log-表"><a href="#创建-undo-log-表" class="headerlink" title="创建 undo_log 表"></a>创建 undo_log 表</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `undo_log`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `undo_log` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;increment id&#x27;</span>,</span><br><span class="line">  `branch_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;branch transaction id&#x27;</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;global transaction id&#x27;</span>,</span><br><span class="line">  `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;undo_log context,such as serialization&#x27;</span>,</span><br><span class="line">  `rollback_info` longblob <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;rollback info&#x27;</span>,</span><br><span class="line">  `log_status` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;0:normal status,1:defense status&#x27;</span>,</span><br><span class="line">  `log_created` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create datetime&#x27;</span>,</span><br><span class="line">  `log_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;modify datetime&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">99</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;AT transaction mode undo table&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<h1 id="碰到的问题"><a href="#碰到的问题" class="headerlink" title="碰到的问题"></a>碰到的问题</h1><h2 id="Jackson格式化-Cannot-construct-instance-of-java-time-LocalDateTime-no-Creators-like-de"><a href="#Jackson格式化-Cannot-construct-instance-of-java-time-LocalDateTime-no-Creators-like-de" class="headerlink" title="Jackson格式化 Cannot construct instance of java.time.LocalDateTime (no Creators, like de"></a>Jackson格式化 Cannot construct instance of <code>java.time.LocalDateTime</code> (no Creators, like de</h2><h3 id="解决过程"><a href="#解决过程" class="headerlink" title="解决过程"></a>解决过程</h3><p>尝试 给 Jackson 添加</p>
<blockquote>
<p>.registerModule(new ParameterNamesModule())<br>.registerModule(new Jdk8Module())<br>.registerModule(new JavaTimeModule());</p>
</blockquote>
<p>无效</p>
<p>看源码找到 JacksonUndoLogParser </p>
<blockquote>
<p>private final ObjectMapper mapper = new ObjectMapper();</p>
</blockquote>
<p>原来用的自己创建的 ObjectMapper  难怪 给Spring的 ObjectMapper 添加 JavaTimeModule 没有效果</p>
<p>在源码中找切换 jackson 的方式 看到原来读取配置 client.undo.logSerialization=jackson</p>
<p>然后记录在 undo_log 表的 context 字段中 serializer=jackson&amp;compressorType=NONE</p>
<p>在执行回滚时反序列化是根据 serializer=jackson 查找 Parser</p>
<p>在插入 undo_log 时 是根据 配置 client.undo.logSerialization</p>
<p>修改 client.undo.logSerialization 即可切换 Parser 有 fastjson jackson kryo protostuff 这些可以选择</p>
<p>换为 fastjson 嗯 还是 时间转换异常 错误变成   <strong>Timestamp format must be yyyy-mm-dd hh:mm:ss[.fffffffff]]</strong></p>
<p>┻━┻︵╰(‵□′)╯︵┻━┻</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>覆盖 seata 的 JacksonUndoLogParser   ( 自己定义一个一模一样的包名 和 类名 然后把 seata中的 JacksonUndoLogParser 复制进去 修改其中部分代码</p>
<p>在 init() 中 添加</p>
<blockquote>
<p>mapper.registerModule(new ParameterNamesModule())<br>            .registerModule(new Jdk8Module())<br>            .registerModule(new JavaTimeModule());</p>
</blockquote>
<p>解决 (๑•̀ㅂ•́)و✧</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>seata</tag>
        <tag>分布式事务</tag>
        <tag>nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>数字转换任意进制 纯数字加密</title>
    <url>/2021/06/04/2021-06-04%20%20%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2%20%E6%95%B0%E5%AD%97%E5%8A%A0%E5%AF%86/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p><strong>项目中需要 加密纯数字 (加密id 防止用户随便改比如 URL?id=1 修改成 URL?id=2</strong></p>
<p>就想用 进制转换 10进制转换为 自定义的进制 16进制 32进制 太常见了</p>
<p>网上给的代码都是用 Integer.valueOf(String s, int radix); 实现</p>
<p>满足不了自定义进制密文的要求</p>
<p>只好自己实现一个咯~ </p>
<p>网上一搜应该一堆 但我愣是没有搜到…  感叹中文互联网的内容越来越差很多东西都搜不到了</p>
<h1 id="基本实现"><a href="#基本实现" class="headerlink" title="基本实现"></a>基本实现</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String enstr = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;<span class="comment">//62进制</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">char</span>[] array = enstr.toCharArray();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> len = array.length;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">9999999</span>;i&lt; <span class="number">999999999</span>;i++) &#123;</span><br><span class="line">		String enc = encode(i);</span><br><span class="line">		<span class="keyword">if</span>(decode(enc)!=i) &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">			System.out.println(i + <span class="string">&quot; &quot;</span>+ enc);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encode</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = id / len;</span><br><span class="line">	<span class="keyword">int</span> y = id % len;</span><br><span class="line">	<span class="keyword">return</span> encode(x, y, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encode</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, String sb)</span> </span>&#123;</span><br><span class="line">	sb = array[y] + sb;</span><br><span class="line">	<span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> sb;</span><br><span class="line">	<span class="keyword">return</span> encode(x / len, x % len, sb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">decode</span><span class="params">(String code)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> r = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; code.length(); i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> fd = code.length() - i - <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> x = enstr.indexOf(code.charAt(i));</span><br><span class="line">		<span class="keyword">if</span> (fd != <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">int</span> cur = x * len;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; fd; j++)</span><br><span class="line">				cur *= len;</span><br><span class="line">			r += cur;</span><br><span class="line">		&#125; <span class="keyword">else</span> </span><br><span class="line">			r += x;</span><br><span class="line">	&#125; <span class="comment">// for</span></span><br><span class="line">	<span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实际使用"><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h1><p>上面的代码会有个问题 比如每次生成 id = 61 固定 会生成 id = z</p>
<p>为了没有规律加入随机数放到生成的字符中</p>
<p>为了防止被用户修改 还要再加入校验码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String baseSecret = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> len = baseSecret.length();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Random ran = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encode</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = id / len;</span><br><span class="line">	<span class="keyword">int</span> y = id % len;</span><br><span class="line">	<span class="keyword">int</span> r = ran.nextInt(baseSecret.length());</span><br><span class="line">	String secret = getOffsetSecret(r);</span><br><span class="line">	String code = encode(x, y, <span class="string">&quot;&quot;</span>, secret) + baseSecret.charAt(r);</span><br><span class="line">	<span class="keyword">return</span> code + getCheckCode(code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encode</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, String sb, String secret)</span> </span>&#123;</span><br><span class="line">	sb = secret.charAt(y) + sb;</span><br><span class="line">	<span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> sb;</span><br><span class="line">	<span class="keyword">return</span> encode(x / len, x % len, sb, secret);</span><br><span class="line">&#125;<span class="comment">// mtehod</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">decode</span><span class="params">(String code)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	String checkStr = code.substring(code.length() - <span class="number">1</span>);</span><br><span class="line">	code = code.substring(<span class="number">0</span>, code.length() - <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span>(!checkStr.equals(getCheckCode(code)))</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;校验无法通过!&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	String offsetStr = code.substring(code.length() - <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">int</span> offset = baseSecret.indexOf(offsetStr);</span><br><span class="line">	String secret = getOffsetSecret(offset);</span><br><span class="line"></span><br><span class="line">	code = code.substring(<span class="number">0</span>, code.length() - <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">int</span> r = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; code.length(); i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> fd = code.length() - i - <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> x = secret.indexOf(code.charAt(i));</span><br><span class="line">		<span class="keyword">if</span> (fd != <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">int</span> cur = x * len;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; fd; j++)</span><br><span class="line">				cur *= len;</span><br><span class="line">			r += cur;</span><br><span class="line">		&#125; <span class="keyword">else</span></span><br><span class="line">			r += x;</span><br><span class="line">	&#125; <span class="comment">// for</span></span><br><span class="line">	<span class="keyword">return</span> r;</span><br><span class="line">&#125;<span class="comment">// method</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//加入随机数</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getOffsetSecret</span><span class="params">(<span class="keyword">int</span> offset)</span> </span>&#123;</span><br><span class="line">	StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= baseSecret.length(); i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> o = (i + offset) % baseSecret.length();</span><br><span class="line">		sb.append(baseSecret.charAt(o));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;<span class="comment">// method</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//加入校验码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCheckCode</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">	str = str.substring(<span class="number">0</span>, str.length() - <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">int</span> code = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length(); i++)</span><br><span class="line">		code += baseSecret.indexOf(str.charAt(i));</span><br><span class="line">	<span class="keyword">return</span> baseSecret.charAt(code % baseSecret.length()) + <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;<span class="comment">//</span></span><br></pre></td></tr></table></figure>

<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><p>为了长度大致相同 可以给一个基础的数值 比如加密前先 +100000 之后再加密</p>
<h1 id="玩出花来"><a href="#玩出花来" class="headerlink" title="玩出花来"></a>玩出花来</h1><p>baseSecret 可以随便换比如 “0aQ1bR2cS3dT4eU5fV6gW7hX8iY9jZAkBlCmDnEoFpGqHrIsJtKuLvMwNxOyPz” 这种没规律的</p>
<p>或者</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">123456</span>;</span><br><span class="line">        System.out.println(x + <span class="string">&quot; &quot;</span> + encode(x));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String baseSecret = <span class="string">&quot;ilI&quot;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">123456 illiIIllIIlil</span></span><br><span class="line"><span class="comment">123456 lIIliiIIiiIli</span></span><br><span class="line"><span class="comment">123456 IiiIlliilliII</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String baseSecret = <span class="string">&quot;-=*&quot;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">123456 *--*==--==-**</span></span><br><span class="line"><span class="comment">123456 =**=--**--*=-</span></span><br><span class="line"><span class="comment">123456 -==-**==**=-=</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String baseSecret = <span class="string">&quot;oO0&quot;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">123456 0oo0OOooOOo00</span></span><br><span class="line"><span class="comment">123456 O00Ooo00oo0Oo</span></span><br><span class="line"><span class="comment">123456 oOOo00OO00OoO</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p><em><strong><center><a href="https://github.com/lqs1848/java_workspace/blob/main/Test/src/org/lqs1848/test/NumberEncryption.java">源码</a></center></strong></em></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>进制转换</tag>
        <tag>数字加密</tag>
      </tags>
  </entry>
  <entry>
    <title>BBR为什么可以加速SS</title>
    <url>/2021/06/07/2021-06-07%20%20BBR/</url>
    <content><![CDATA[<span id="more"></span>

<p>之前自己部署SS的时候，搭建教程大部分都有 修改服务器TCP算法为 BBR 的步骤,，为什么要使用BBR? BBR为什么能加速SS? 一直没去研究</p>
<p>最近有点时间，查阅了一下资料</p>
<h1 id="TCP判断线路的理想速率"><a href="#TCP判断线路的理想速率" class="headerlink" title="TCP判断线路的理想速率"></a>TCP判断线路的理想速率</h1><p>服务器发送数据包，当然越快越好，最好一次性全发出去。但是，发得太快，就有可能丢包。带宽小、路由器过热、缓存溢出等许多因素都会导致丢包。线路不好的话，发得越快，丢得越多。</p>
<p>最理想的状态是，在线路允许的情况下，达到最高速率。但是我们怎么知道，对方线路的理想速率是多少呢？答案就是慢慢试。</p>
<p>TCP 协议为了做到效率与可靠性的统一，设计了一个慢启动（slow start）机制。开始的时候，发送得较慢，然后根据丢包的情况，调整速率：如果不丢包，就加快发送速度；如果丢包，就降低发送速度。</p>
<p>即使对于带宽很大、线路很好的连接，TCP 也总是从10个数据包开始慢慢试，过了一段时间以后，才达到最高的传输速率。这就是 TCP 的慢启动。</p>
<h1 id="Delay-Based"><a href="#Delay-Based" class="headerlink" title="Delay-Based"></a>Delay-Based</h1><p>BBR是 delay-based，而不是 loss-based，不受丢包影响</p>
<p>国内的运营商，为了减少跨国流量，故意在出口随机丢包…</p>
<p>如果是 loss based 速度自然就无法达到带宽上限</p>
<p>同样是 delay-based 的 TCP Vegas, Fast, Ledbat, Google CC 也可以提高 SS 的速度</p>
<h1 id="Loss-Based的几个问题"><a href="#Loss-Based的几个问题" class="headerlink" title="Loss-Based的几个问题"></a>Loss-Based的几个问题</h1><ul>
<li><p><strong>丢包即拥塞</strong> 现实中网络环境很复杂会存在错误丢包，很多算法无法很好区分拥塞丢包和错误丢包，因此在存在一定错误丢包的前提下在某些网络场景中并不能充分利用带宽。</p>
</li>
<li><p><strong>缓冲区膨胀问题BufferBloat</strong> 网络连接中路由器、交换机、核心网设备等等为了平滑网络波动而存在缓冲区，这些缓存区就像输液管的膨胀部分让数据更加平稳，但是Loss-Based策略在最初就像网络中发生数据类似于灌水，此时是将Buffer全部算在内的，一旦buffer满了，就可能出现RTT增加丢包等问题，就相当于有的容量本不该算在其中，但是策略是基于包含Buffer进行预测的，特别地在深缓冲区网络就会出现一些问题。</p>
</li>
<li><p><strong>网络负载高但无丢包事件</strong> 假设网络中的负载已经很高了，只要没有丢包事件出现，算法就不会主动减窗降低发送速率，这种情况下虽然充分利用了网络带宽，同时由于一直没有丢包事件出现发送方仍然在加窗，表现出了较强的网络带宽侵略性，加重了网络负载压力。</p>
</li>
<li><p><strong>高负载丢包</strong> 高负载无丢包情况下算法一直加窗，这样可以预测丢包事件可能很快就出现了，一旦丢包出现窗口将呈现乘性减少，由高位发送速率迅速降低会造成整个网络的瞬时抖动性，总体呈现较大的锯齿状波动。</p>
</li>
<li><p><strong>低负载高延时丢包</strong> 在某些弱网环境下RTT会增加甚至出现非拥塞引起丢包，此时基于丢包反馈的拥塞算法的窗口会比较小，对带宽的利用率很低，吞吐量下降很明显，但是实际上网络负载并不高，所以在弱网环境下效果并不是非常理想。</p>
</li>
</ul>
<h1 id="TCP-BBR算法基本原理"><a href="#TCP-BBR算法基本原理" class="headerlink" title="TCP BBR算法基本原理"></a>TCP BBR算法基本原理</h1><p>TCP BBR算法是一种主动式机制，简单来说BBR算法不再基于丢包判断并且也不再使用AIMD线性增乘性减策略来维护拥塞窗口，而是分别采样估计极大带宽和极小延时，并用二者乘积作为发送窗口，并且BBR引入了Pacing Rate限制数据发送速率，配合cwnd使用来降低冲击。</p>
<p>BBR算法的一些思想在之前的基于延时的拥塞控制算法中也有出现，其中必有有名的是TCP WestWood算法。</p>
<blockquote>
<p>TCP Westwood改良自New Reno，不同于以往其他拥塞控制算法使用丢失来测量，其通过对确认包测量来确定一个合适的发送速度，并以此调整拥塞窗口和慢启动阈值。其改良了慢启动阶段算法为敏捷探测和设计了一种持续探测拥塞窗口的方法来控制进入敏捷探测，使链接尽可能地使用更多的带宽。</p>
</blockquote>
<p>TCP WestWood算法也是基于带宽和延时乘积进行设计的，但是带宽和延时两个指标无法同时测量，因为这两个值是有些矛盾的极值，要测量最大带宽就要发送最大的数据量但是此时的RTT可能会很大，如果要测量最小的RTT那么久意味着数据量非常少最大带宽就无法获得。</p>
<p>TCP BBR算法采用交替采样测量两个指标，取一段时间内的带宽极大值和延时极小值作为估计值。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>简单讲就是 默认的TCP 拥堵算法 是基于丢包判断带宽的理想速率</p>
<p>而国际带宽容易丢包 导致默认算法判断出的带宽上限并非真实带宽</p>
<!--在Linux4.19内核中已经将拥塞控制算法从CUBIC（该算法从2.6.19内核就引入Linux了）改为BBR，而HTTP3也使用此算法。-->







]]></content>
      <categories>
        <category>NetWork</category>
      </categories>
      <tags>
        <tag>BBR</tag>
      </tags>
  </entry>
  <entry>
    <title>Transaction rolled back because it has been marked as rollback-only</title>
    <url>/2021/06/10/2021-06-10%20Transaction%20rolled%20back%20because%20it%20has%20been%20marked%20as%20rollback-only/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="Spring事务管理报错-Transaction-rolled-back-because-it-has-been-marked-as-rollback-only"><a href="#Spring事务管理报错-Transaction-rolled-back-because-it-has-been-marked-as-rollback-only" class="headerlink" title="Spring事务管理报错:Transaction rolled back because it has been marked as rollback-only"></a>Spring事务管理报错:Transaction rolled back because it has been marked as rollback-only</h1><h1 id="出错代码"><a href="#出错代码" class="headerlink" title="出错代码"></a>出错代码</h1><p>算是比较常见的错误了</p>
<p>很多解释说明都云里雾里的</p>
<p>其实比较简单</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceA</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ServiceB serviceB;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">			serviceB.testB();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">			</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">//method</span></span><br><span class="line">&#125;<span class="comment">//class</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceB</span></span>&#123;</span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testB</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;测试&quot;</span>);</span><br><span class="line">    &#125;<span class="comment">//method</span></span><br><span class="line">&#125;<span class="comment">//class</span></span><br></pre></td></tr></table></figure>

<p>上面这段代码就会报错 Transaction rolled back because it has been marked as rollback-only</p>
<p>原因是 Spring 事务管理是通过AOP切入的</p>
<p>ServiceA 的 testA 已经切入   </p>
<p>testB 又切入了一次 </p>
<p>@Transactional 的默认传播机制是 Propagation propagation() default Propagation.REQUIRED;</p>
<p>等于 testA 和 testB 使用的是同一个事务</p>
<p>testB 抛出异常时  Spring Aop 已经把事务标记为需要回滚</p>
<p>testA 使用同一个事务 try-catch 了 testB 的异常 所以 testA 没有异常 方法结束</p>
<p>testA 提交事务时 由于 testB已经被回滚 所以抛异常</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>AOP.serviceA.testA    -&gt;    进入方法前    开启事务</p>
<p>↓</p>
<p>serviceA.testA    -&gt;    方法执行</p>
<p>↓</p>
<p>AOP.serivceB.testB    -&gt;    进入方法前    开启事务 读取到已有事务 REQUIRED 继承A的事务</p>
<p>↓</p>
<p>serviceB.testB    -&gt;    方法执行    出现异常</p>
<p>↓</p>
<p>AOP.serviceB.testB    -&gt;    方法执行后    检测到异常 回滚事务</p>
<p>↓</p>
<p>serviceA.testA    -&gt;    方法执行    testB的异常被 try-catch 方法正常结束</p>
<p>↓</p>
<p>AOP.serviceA.testA    -&gt;    方法执行后    没有异常 提交事务</p>
<p>其实就是 AOP 切入了两次 A 和 B 使用的是同一个事务</p>
<p>并且 抓取 B 的错误时 B 已经回滚了事务</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ol>
<li>指定 testB 的事务传播性为 REQUIRES_NEW (testB单独一个事务 回滚不影响 testA</li>
<li>把 testA 中的 try-catch 放到 testB 中 testB返回true false 给 testA 判断</li>
<li>从 controller 中分别调用 testA 和 testB</li>
</ol>
]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>事务</tag>
        <tag>Transaction</tag>
      </tags>
  </entry>
  <entry>
    <title>聚合支付原理</title>
    <url>/2021/06/10/2021-06-10%20%E8%81%9A%E5%90%88%E6%94%AF%E4%BB%98%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<span id="more"></span>

<p><strong>公司要接入聚合支付(第四方支付) 封装成自用支付(第五方支付)</strong></p>
<p><strong>但聚合支付提供方没有给被扫接口</strong></p>
<p><strong>稍微了解下聚合支付封装 第三方支付 的逻辑</strong></p>
<h1 id="主扫-一个二维码-微信也能扫支付宝也能扫"><a href="#主扫-一个二维码-微信也能扫支付宝也能扫" class="headerlink" title="主扫(一个二维码 微信也能扫支付宝也能扫)"></a>主扫(一个二维码 微信也能扫支付宝也能扫)</h1><p>这个是最基础的 只是给每个商户单独 生成一个URL而已</p>
<p>基本就是给一个二维码 里面是URL地址 微信/支付宝 扫码 会直接跳转访问</p>
<p>被访问时通过 JavaScript 判断用户浏览器的 UserAgent </p>
<p>判断是通过微信还是支付宝或者其他支付软件</p>
<p>再调起对应支付软件的网页SDK支付</p>
<h1 id="被扫-用户打开-微信-支付宝-扫码机自动识别"><a href="#被扫-用户打开-微信-支付宝-扫码机自动识别" class="headerlink" title="被扫(用户打开 微信/支付宝 扫码机自动识别)"></a>被扫(用户打开 微信/支付宝 扫码机自动识别)</h1><p>硬件设备识别二维码获得二维码内容</p>
<p>根据二维码内容调用第三方支付</p>
<p><strong>微信：</strong></p>
<p><strong>用户付款码条形码规则：18位纯数字，以10、11、12、13、14、15开头</strong></p>
<p>对应调起接口 <a href="https://pay.weixin.qq.com/wiki/doc/api/wxpay_v2/product/chapter1_12.shtml">付款码支付</a></p>
<p><strong>支付宝：</strong></p>
<p><strong>25<del>30开头的长度为16</del>24位的数字，实际字符串长度以开发者获取的付款码长度为准</strong></p>
<p>调起对应接口 <a href="https://opendocs.alipay.com/open/01csp3">当面付</a></p>
]]></content>
      <tags>
        <tag>pay</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud 整合 Dubbo</title>
    <url>/2021/04/23/2021-04-23%20%20SpringCloud%20%E6%95%B4%E5%90%88%20Dubbo/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="选择整合方式"><a href="#选择整合方式" class="headerlink" title="选择整合方式"></a>选择整合方式</h1><p>1 用 dubbo 替换 feign 的 http 请求方式</p>
<p>2 正常的接口远程调用方式</p>
<h2 id="0-共通基础"><a href="#0-共通基础" class="headerlink" title="0 共通基础"></a>0 共通基础</h2><p>不管用什么方式使用dubbo 都得引入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="1-用-dubbo-替代-feign"><a href="#1-用-dubbo-替代-feign" class="headerlink" title="1 用 dubbo 替代 feign"></a>1 用 dubbo 替代 feign</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.Feign;</span><br><span class="line"><span class="keyword">import</span> feign.Target;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.DubboReference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ReflectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.alibaba.spring.util.AnnotationUtils.getAttributes;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.core.annotation.AnnotationAttributes.fromMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dubbo、Feign整合类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboFeignBuilder</span> <span class="keyword">extends</span> <span class="title">Feign</span>.<span class="title">Builder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DubboReference defaultReference;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultReferenceClass</span> </span>&#123;</span><br><span class="line">        <span class="meta">@DubboReference(check = false)</span></span><br><span class="line">        String field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboFeignBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultReference = Objects.requireNonNull(ReflectionUtils.findField(DefaultReferenceClass.class, <span class="string">&quot;field&quot;</span>)).getAnnotation(DubboReference.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">target</span><span class="params">(Target&lt;T&gt; target)</span> </span>&#123;</span><br><span class="line">        ReferenceBeanBuilder beanBuilder = ReferenceBeanBuilder.create(fromMap(getAttributes(defaultReference,</span><br><span class="line">                applicationContext.getEnvironment(), <span class="keyword">true</span>)), applicationContext).interfaceClass(target.type());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            T object = (T) beanBuilder.build().getObject();</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.utils.ArrayUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.MethodConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.DubboService;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Method;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Service;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.spring.ServiceBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.spring.context.DubboBootstrapApplicationListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.spring.context.annotation.DubboClassPathBeanDefinitionScanner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.MutablePropertyValues;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanClassLoaderAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.EnvironmentAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ResourceLoaderAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationBeanNameGenerator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ClassPathBeanDefinitionScanner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ConfigurationClassPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AnnotationAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ResourceLoader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.filter.AnnotationTypeFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.alibaba.spring.util.AnnotationUtils.getAttribute;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.alibaba.spring.util.BeanRegistrar.registerInfrastructureBean;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.alibaba.spring.util.ObjectUtils.of;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Arrays.asList;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.apache.dubbo.config.spring.beans.factory.annotation.ServiceBeanNameBuilder.create;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.beans.factory.support.BeanDefinitionBuilder.rootBeanDefinition;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.context.annotation.AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.core.annotation.AnnotatedElementUtils.findMergedAnnotation;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.core.annotation.AnnotationUtils.getAnnotationAttributes;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.util.ClassUtils.getAllInterfacesForClass;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.util.ClassUtils.resolveClassName;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.util.StringUtils.hasText;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboFeignProviderBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span>, <span class="title">EnvironmentAware</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ResourceLoaderAware</span>, <span class="title">BeanClassLoaderAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;Class&lt;? extends Annotation&gt;&gt; serviceAnnotationTypes = asList(</span><br><span class="line">            <span class="comment">// @since 2.7.7 Add the @DubboService , the issue : https://github.com/apache/dubbo/issues/6007</span></span><br><span class="line">            DubboService.class,</span><br><span class="line">            <span class="comment">// @since 2.7.0 the substitute @com.alibaba.dubbo.config.annotation.Service</span></span><br><span class="line">            Service.class,</span><br><span class="line">            <span class="comment">// @since 2.7.3 Add the compatibility for legacy Dubbo&#x27;s @Service , the issue : https://github.com/apache/dubbo/issues/4330</span></span><br><span class="line">            com.alibaba.dubbo.config.annotation.Service.class</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">&quot;:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; packagesToScan;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DubboService defaultService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboFeignProviderBeanPostProcessor</span><span class="params">(String... packagesToScan)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(Arrays.asList(packagesToScan));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboFeignProviderBeanPostProcessor</span><span class="params">(Collection&lt;String&gt; packagesToScan)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> LinkedHashSet&lt;String&gt;(packagesToScan));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboFeignProviderBeanPostProcessor</span><span class="params">(Set&lt;String&gt; packagesToScan)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.packagesToScan = packagesToScan;</span><br><span class="line">        <span class="meta">@DubboService</span></span><br><span class="line">        <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultServiceClass</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        ;</span><br><span class="line">        <span class="keyword">this</span>.defaultService = DefaultServiceClass.class.getAnnotation(DubboService.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @since 2.7.5</span></span><br><span class="line">        registerInfrastructureBean(registry, DubboBootstrapApplicationListener.BEAN_NAME, DubboBootstrapApplicationListener.class);</span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; resolvedPackagesToScan = resolvePackagesToScan(packagesToScan);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(resolvedPackagesToScan)) &#123;</span><br><span class="line">            registerServiceBeans(resolvedPackagesToScan, registry);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;packagesToScan is empty , ServiceBean registry will be ignored!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers Beans whose classes was annotated &#123;<span class="doctag">@link</span> FeignClient&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packagesToScan The base packages to scan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry       &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceBeans</span><span class="params">(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        DubboClassPathBeanDefinitionScanner scanner =</span><br><span class="line">                <span class="keyword">new</span> DubboClassPathBeanDefinitionScanner(registry, environment, resourceLoader);</span><br><span class="line"></span><br><span class="line">        BeanNameGenerator beanNameGenerator = resolveBeanNameGenerator(registry);</span><br><span class="line"></span><br><span class="line">        scanner.setBeanNameGenerator(beanNameGenerator);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// refactor @since 2.7.7</span></span><br><span class="line">        serviceAnnotationTypes.forEach(annotationType -&gt; &#123;</span><br><span class="line">            scanner.addIncludeFilter(<span class="keyword">new</span> AnnotationTypeFilter(annotationType));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String packageToScan : packagesToScan) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Registers @DubboService Bean first</span></span><br><span class="line">            scanner.scan(packageToScan);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Finds all BeanDefinitionHolders of @DubboService whether @ComponentScan scans or not.</span></span><br><span class="line">            Set&lt;BeanDefinitionHolder&gt; beanDefinitionHolders =</span><br><span class="line">                    findServiceBeanDefinitionHolders(scanner, packageToScan, registry, beanNameGenerator);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(beanDefinitionHolders)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (BeanDefinitionHolder beanDefinitionHolder : beanDefinitionHolders) &#123;</span><br><span class="line">                    registerServiceBean(beanDefinitionHolder, registry, scanner);</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(beanDefinitionHolders.size() + <span class="string">&quot; annotated Dubbo&#x27;s @DubboService Components &#123; &quot;</span> +</span><br><span class="line">                        beanDefinitionHolders +</span><br><span class="line">                        <span class="string">&quot; &#125; were scanned under package[&quot;</span> + packageToScan + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;No Spring Bean annotating Dubbo&#x27;s @DubboService was found under package[&quot;</span></span><br><span class="line">                        + packageToScan + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * It&#x27;d better to use BeanNameGenerator instance that should reference</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ConfigurationClassPostProcessor&#125;,</span></span><br><span class="line"><span class="comment">     * thus it maybe a potential problem on bean name generation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> BeanNameGenerator&#125; instance</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SingletonBeanRegistry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> AnnotationConfigUtils#CONFIGURATION_BEAN_NAME_GENERATOR</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ConfigurationClassPostProcessor#processConfigBeanDefinitions</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.5.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BeanNameGenerator <span class="title">resolveBeanNameGenerator</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanNameGenerator beanNameGenerator = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (registry <span class="keyword">instanceof</span> SingletonBeanRegistry) &#123;</span><br><span class="line">            SingletonBeanRegistry singletonBeanRegistry = SingletonBeanRegistry.class.cast(registry);</span><br><span class="line">            beanNameGenerator = (BeanNameGenerator) singletonBeanRegistry.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (beanNameGenerator == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;BeanNameGenerator bean can&#x27;t be found in BeanFactory with name [&quot;</span></span><br><span class="line">                    + CONFIGURATION_BEAN_NAME_GENERATOR + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            log.info(<span class="string">&quot;BeanNameGenerator will be a instance of &quot;</span> +</span><br><span class="line">                    AnnotationBeanNameGenerator.class.getName() +</span><br><span class="line">                    <span class="string">&quot; , it maybe a potential problem on bean name generation.&quot;</span>);</span><br><span class="line">            beanNameGenerator = <span class="keyword">new</span> AnnotationBeanNameGenerator();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanNameGenerator;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finds a &#123;<span class="doctag">@link</span> Set&#125; of &#123;<span class="doctag">@link</span> BeanDefinitionHolder BeanDefinitionHolders&#125; whose bean type annotated</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> DubboService&#125; Annotation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> scanner       &#123;<span class="doctag">@link</span> ClassPathBeanDefinitionScanner&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packageToScan pachage to scan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry      &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.5.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">findServiceBeanDefinitionHolders</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            ClassPathBeanDefinitionScanner scanner, String packageToScan, BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">            BeanNameGenerator beanNameGenerator)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Set&lt;BeanDefinition&gt; beanDefinitions = scanner.findCandidateComponents(packageToScan);</span><br><span class="line"></span><br><span class="line">        Set&lt;BeanDefinitionHolder&gt; beanDefinitionHolders = <span class="keyword">new</span> LinkedHashSet&lt;BeanDefinitionHolder&gt;(beanDefinitions.size());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitions) &#123;</span><br><span class="line"></span><br><span class="line">            String beanName = beanNameGenerator.generateBeanName(beanDefinition, registry);</span><br><span class="line">            BeanDefinitionHolder beanDefinitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName);</span><br><span class="line">            beanDefinitionHolders.add(beanDefinitionHolder);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanDefinitionHolders;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers &#123;<span class="doctag">@link</span> ServiceBean&#125; from new annotated &#123;<span class="doctag">@link</span> DubboService&#125; &#123;<span class="doctag">@link</span> BeanDefinition&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanDefinitionHolder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> scanner</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ServiceBean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> BeanDefinition</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceBean</span><span class="params">(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     DubboClassPathBeanDefinitionScanner scanner)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; beanClass = resolveClass(beanDefinitionHolder);</span><br><span class="line"></span><br><span class="line">        Annotation service = findServiceAnnotation(beanClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The &#123;<span class="doctag">@link</span> AnnotationAttributes&#125; of <span class="doctag">@Service</span> annotation</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        AnnotationAttributes serviceAnnotationAttributes = getAnnotationAttributes(service, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; interfaceClass = resolveServiceInterfaceClass(serviceAnnotationAttributes, beanClass);</span><br><span class="line"></span><br><span class="line">        String annotatedServiceBeanName = beanDefinitionHolder.getBeanName();</span><br><span class="line"></span><br><span class="line">        AbstractBeanDefinition serviceBeanDefinition =</span><br><span class="line">                buildServiceBeanDefinition(service, serviceAnnotationAttributes, interfaceClass, annotatedServiceBeanName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ServiceBean Bean name</span></span><br><span class="line">        String beanName = generateServiceBeanName(serviceAnnotationAttributes, interfaceClass);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (scanner.checkCandidate(beanName, serviceBeanDefinition)) &#123; <span class="comment">// check duplicated candidate bean</span></span><br><span class="line">            registry.registerBeanDefinition(beanName, serviceBeanDefinition);</span><br><span class="line">            log.warn(<span class="string">&quot;The BeanDefinition[&quot;</span> + serviceBeanDefinition +</span><br><span class="line">                    <span class="string">&quot;] of ServiceBean has been registered with name : &quot;</span> + beanName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;The Duplicated BeanDefinition[&quot;</span> + serviceBeanDefinition +</span><br><span class="line">                    <span class="string">&quot;] of ServiceBean[ bean name : &quot;</span> + beanName +</span><br><span class="line">                    <span class="string">&quot;] was be found , Did @DubboComponentScan scan to same package in many times?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generates the bean name of &#123;<span class="doctag">@link</span> ServiceBean&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceAnnotationAttributes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaceClass              the class of interface annotated &#123;<span class="doctag">@link</span> Service&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ServiceBean@interfaceClassName#annotatedServiceBeanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.7.3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">generateServiceBeanName</span><span class="params">(AnnotationAttributes serviceAnnotationAttributes, Class&lt;?&gt; interfaceClass)</span> </span>&#123;</span><br><span class="line">        ServiceBeanNameBuilder builder = create(interfaceClass, environment)</span><br><span class="line">                .group(serviceAnnotationAttributes.getString(<span class="string">&quot;group&quot;</span>))</span><br><span class="line">                .version(serviceAnnotationAttributes.getString(<span class="string">&quot;version&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; resolveServiceInterfaceClass(AnnotationAttributes attributes, Class&lt;?&gt; defaultInterfaceClass)</span><br><span class="line">            <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line"></span><br><span class="line">        ClassLoader classLoader = defaultInterfaceClass != <span class="keyword">null</span> ? defaultInterfaceClass.getClassLoader() : Thread.currentThread().getContextClassLoader();</span><br><span class="line">        Class&lt;?&gt; interfaceClass = getAttribute(attributes, <span class="string">&quot;interfaceClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">void</span>.class.equals(interfaceClass)) &#123;</span><br><span class="line"></span><br><span class="line">            interfaceClass = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            String interfaceClassName = getAttribute(attributes, <span class="string">&quot;interfaceName&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (hasText(interfaceClassName)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClassUtils.isPresent(interfaceClassName, classLoader)) &#123;</span><br><span class="line">                    interfaceClass = resolveClassName(interfaceClassName, classLoader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (interfaceClass == <span class="keyword">null</span> &amp;&amp; defaultInterfaceClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Find all interfaces from the annotated class</span></span><br><span class="line">            <span class="comment">// To resolve an issue : https://github.com/apache/dubbo/issues/3251</span></span><br><span class="line">            Class&lt;?&gt;[] allInterfaces = getAllInterfacesForClass(defaultInterfaceClass);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (allInterfaces.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                interfaceClass = allInterfaces[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        Assert.notNull(interfaceClass,</span><br><span class="line">                <span class="string">&quot;@Service interfaceClass() or interfaceName() or interface class must be present!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Assert.isTrue(interfaceClass.isInterface(),</span><br><span class="line">                <span class="string">&quot;The annotated type must be an interface!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> interfaceClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; resolveClass(BeanDefinitionHolder beanDefinitionHolder) &#123;</span><br><span class="line"></span><br><span class="line">        BeanDefinition beanDefinition = beanDefinitionHolder.getBeanDefinition();</span><br><span class="line">        <span class="keyword">return</span> resolveClass(beanDefinition);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; resolveClass(BeanDefinition beanDefinition) &#123;</span><br><span class="line"></span><br><span class="line">        String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">        <span class="keyword">return</span> resolveClassName(beanClassName, classLoader);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Find the &#123;<span class="doctag">@link</span> Annotation annotation&#125; of <span class="doctag">@Service</span></span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanClass the &#123;<span class="doctag">@link</span> Class class&#125; of Bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &lt;code&gt;null&lt;/code&gt; if not found</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.7.3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Annotation <span class="title">findServiceAnnotation</span><span class="params">(Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serviceAnnotationTypes</span><br><span class="line">                .stream()</span><br><span class="line">                .map(annotationType -&gt; findMergedAnnotation(beanClass, annotationType))</span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                .findFirst()</span><br><span class="line">                .orElse(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">resolvePackagesToScan</span><span class="params">(Set&lt;String&gt; packagesToScan)</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; resolvedPackagesToScan = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;(packagesToScan.size());</span><br><span class="line">        <span class="keyword">for</span> (String packageToScan : packagesToScan) &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(packageToScan)) &#123;</span><br><span class="line">                String resolvedPackageToScan = environment.resolvePlaceholders(packageToScan.trim());</span><br><span class="line">                resolvedPackagesToScan.add(resolvedPackageToScan);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resolvedPackagesToScan;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Build the &#123;<span class="doctag">@link</span> AbstractBeanDefinition Bean Definition&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceAnnotation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceAnnotationAttributes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaceClass</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotatedServiceBeanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2.7.3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> AbstractBeanDefinition <span class="title">buildServiceBeanDefinition</span><span class="params">(Annotation serviceAnnotation,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                              AnnotationAttributes serviceAnnotationAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                              Class&lt;?&gt; interfaceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                              String annotatedServiceBeanName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BeanDefinitionBuilder builder = rootBeanDefinition(ServiceBean.class);</span><br><span class="line"></span><br><span class="line">        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">        MutablePropertyValues propertyValues = beanDefinition.getPropertyValues();</span><br><span class="line"></span><br><span class="line">        String[] ignoreAttributeNames = of(<span class="string">&quot;provider&quot;</span>, <span class="string">&quot;monitor&quot;</span>, <span class="string">&quot;application&quot;</span>, <span class="string">&quot;module&quot;</span>, <span class="string">&quot;registry&quot;</span>, <span class="string">&quot;protocol&quot;</span>,</span><br><span class="line">                <span class="string">&quot;interface&quot;</span>, <span class="string">&quot;interfaceName&quot;</span>, <span class="string">&quot;parameters&quot;</span>);</span><br><span class="line"></span><br><span class="line">        propertyValues.addPropertyValues(<span class="keyword">new</span> AnnotationPropertyValuesAdapter(serviceAnnotation, environment, ignoreAttributeNames));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// References &quot;ref&quot; property to annotated-@Service Bean</span></span><br><span class="line">        addPropertyReference(builder, <span class="string">&quot;ref&quot;</span>, annotatedServiceBeanName);</span><br><span class="line">        <span class="comment">// Set interface</span></span><br><span class="line">        builder.addPropertyValue(<span class="string">&quot;interface&quot;</span>, interfaceClass.getName());</span><br><span class="line">        <span class="comment">// Convert parameters into map</span></span><br><span class="line">        builder.addPropertyValue(<span class="string">&quot;parameters&quot;</span>, convertParameters(serviceAnnotationAttributes.getStringArray(<span class="string">&quot;parameters&quot;</span>)));</span><br><span class="line">        <span class="comment">// Add methods parameters</span></span><br><span class="line">        List&lt;MethodConfig&gt; methodConfigs = convertMethodConfigs(serviceAnnotationAttributes.get(<span class="string">&quot;methods&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (!methodConfigs.isEmpty()) &#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;methods&quot;</span>, methodConfigs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Add &#123;<span class="doctag">@link</span> org.apache.dubbo.config.ProviderConfig&#125; Bean reference</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String providerConfigBeanName = serviceAnnotationAttributes.getString(<span class="string">&quot;provider&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(providerConfigBeanName)) &#123;</span><br><span class="line">            addPropertyReference(builder, <span class="string">&quot;provider&quot;</span>, providerConfigBeanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Add &#123;<span class="doctag">@link</span> org.apache.dubbo.config.MonitorConfig&#125; Bean reference</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String monitorConfigBeanName = serviceAnnotationAttributes.getString(<span class="string">&quot;monitor&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(monitorConfigBeanName)) &#123;</span><br><span class="line">            addPropertyReference(builder, <span class="string">&quot;monitor&quot;</span>, monitorConfigBeanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Add &#123;<span class="doctag">@link</span> org.apache.dubbo.config.ApplicationConfig&#125; Bean reference</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String applicationConfigBeanName = serviceAnnotationAttributes.getString(<span class="string">&quot;application&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(applicationConfigBeanName)) &#123;</span><br><span class="line">            addPropertyReference(builder, <span class="string">&quot;application&quot;</span>, applicationConfigBeanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Add &#123;<span class="doctag">@link</span> org.apache.dubbo.config.ModuleConfig&#125; Bean reference</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String moduleConfigBeanName = serviceAnnotationAttributes.getString(<span class="string">&quot;module&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(moduleConfigBeanName)) &#123;</span><br><span class="line">            addPropertyReference(builder, <span class="string">&quot;module&quot;</span>, moduleConfigBeanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Add &#123;<span class="doctag">@link</span> org.apache.dubbo.config.RegistryConfig&#125; Bean reference</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String[] registryConfigBeanNames = serviceAnnotationAttributes.getStringArray(<span class="string">&quot;registry&quot;</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;RuntimeBeanReference&gt; registryRuntimeBeanReferences = toRuntimeBeanReferences(registryConfigBeanNames);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!registryRuntimeBeanReferences.isEmpty()) &#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;registries&quot;</span>, registryRuntimeBeanReferences);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Add &#123;<span class="doctag">@link</span> org.apache.dubbo.config.ProtocolConfig&#125; Bean reference</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String[] protocolConfigBeanNames = serviceAnnotationAttributes.getStringArray(<span class="string">&quot;protocol&quot;</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;RuntimeBeanReference&gt; protocolRuntimeBeanReferences = toRuntimeBeanReferences(protocolConfigBeanNames);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!protocolRuntimeBeanReferences.isEmpty()) &#123;</span><br><span class="line">            builder.addPropertyValue(<span class="string">&quot;protocols&quot;</span>, protocolRuntimeBeanReferences);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ManagedList&lt;RuntimeBeanReference&gt; <span class="title">toRuntimeBeanReferences</span><span class="params">(String... beanNames)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ManagedList&lt;RuntimeBeanReference&gt; runtimeBeanReferences = <span class="keyword">new</span> ManagedList&lt;RuntimeBeanReference&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(beanNames)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line"></span><br><span class="line">                String resolvedBeanName = environment.resolvePlaceholders(beanName);</span><br><span class="line"></span><br><span class="line">                runtimeBeanReferences.add(<span class="keyword">new</span> RuntimeBeanReference(resolvedBeanName));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> runtimeBeanReferences;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPropertyReference</span><span class="params">(BeanDefinitionBuilder builder, String propertyName, String beanName)</span> </span>&#123;</span><br><span class="line">        String resolvedBeanName = environment.resolvePlaceholders(beanName);</span><br><span class="line">        builder.addPropertyReference(propertyName, resolvedBeanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List <span class="title">convertMethodConfigs</span><span class="params">(Object methodsAnnotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (methodsAnnotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.EMPTY_LIST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MethodConfig.constructMethodConfig((Method[]) methodsAnnotation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">convertParameters</span><span class="params">(String[] parameters)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ArrayUtils.isEmpty(parameters)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parameters.length % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;parameter attribute must be paired with key followed by value&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameters.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">            map.put(parameters[i], parameters[i + <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.Feign;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.AbstractConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.spring.beans.factory.annotation.DubboFeignBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.spring.beans.factory.annotation.DubboFeignProviderBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.source.ConfigurationPropertySources;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Collections.emptySet;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.apache.dubbo.spring.boot.util.DubboUtils.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dubbo配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = DUBBO_PREFIX, name = &quot;enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(AbstractConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboFeignConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = DUBBO_SCAN_PREFIX, name = BASE_PACKAGES_PROPERTY_NAME)</span></span><br><span class="line">    <span class="meta">@ConditionalOnClass(ConfigurationPropertySources.class)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DubboFeignProviderBeanPostProcessor <span class="title">dubboFeignProviderBeanPostProcessor</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; packagesToScan = environment.getProperty(DUBBO_SCAN_PREFIX + BASE_PACKAGES_PROPERTY_NAME, Set.class, emptySet());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DubboFeignProviderBeanPostProcessor(packagesToScan);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Feign.<span class="function">Builder <span class="title">feignDubboBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DubboFeignBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种方式我目前没有实践过 代码参考 <a href="https://github.com/matevip/matecloud">https://github.com/matevip/matecloud</a> 的 mate-starter-dubbo 模块</p>
<h2 id="2-dubbo-单独使用"><a href="#2-dubbo-单独使用" class="headerlink" title="2 dubbo 单独使用"></a>2 dubbo 单独使用<span id="2"></span></h2><p>首先 代码前提是 SpringCloud Nacos</p>
<h3 id="provider"><a href="#provider" class="headerlink" title="provider"></a>provider</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">provider</span>   <span class="comment">#你的provider 名称 填写到 下面的 subscribed-services 中</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">      <span class="attr">subscribed-services:</span> <span class="string">provider</span> <span class="comment">#这里要填写 $&#123;spring.application.name&#125; 表示自己订阅自己 否则默认是 &#x27;*&#x27; 会订阅所有服务</span></span><br><span class="line">      <span class="comment">#https://github.com/alibaba/spring-cloud-alibaba/issues/1564</span></span><br><span class="line">      <span class="comment">#https://github.com/alibaba/spring-cloud-alibaba/issues/1141</span></span><br><span class="line">    <span class="attr">protocol:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">dubbo</span></span><br><span class="line">        <span class="comment">#-1是自增长</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">registry:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="string">nacos://$&#123;spring.cloud.nacos.config.server-addr&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#address: spring-cloud://127.0.0.1  </span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><code>dubbo.scan.base-packages</code>：指定 Dubbo 服务实现类的扫描基准包</li>
<li><code>dubbo.protocol</code>：Dubbo服务暴露的协议配置，其中子属性name为协议名称，port为协议端口（-1 表示自增端口，从 20880 开始）</li>
<li><code>dubbo.registry</code>：Dubbo 服务注册中心配置，其中子属性address 的值 “spring-cloud://192.168.44.129”，说明挂载到 Spring Cloud 注册中心</li>
<li><code>spring.application.name</code>：Spring 应用名称，用于 Spring Cloud 服务注册和发现。该值在 Dubbo Spring Cloud 加持下被视作<code>dubbo.application.name</code>，因此，无需再显示地配置<code>dubbo.application.name</code>。</li>
<li><code>spring.main.allow-bean-definition-overriding</code>：在 Spring Boot 2.1 以及更高的版本增加该设定，因为 Spring Boot 默认调整了 Bean 定义覆盖行为。</li>
<li><code>spring.cloud.nacos.discovery</code>：Nacos 服务发现与注册配置，其中子属性 server-addr 指定 Nacos 服务器主机和端口。</li>
</ul>
</blockquote>
<p><code>dubbo.scan.base-packages</code> 这个可以用 @DubboComponentScan 替代</p>
<p>配置文件我都放到 nacos 中公用了 这里就用 注解来扫描吧 毕竟每个 provider 扫描的包可能不一样</p>
<p>先定义一个基础 api 包</p>
<p>添加上接口</p>
<p> 在 provider 中实现该接口 并添加 @DubboService 注解</p>
<h3 id="consumer"><a href="#consumer" class="headerlink" title="consumer"></a>consumer</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">    <span class="attr">protocol:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">dubbo</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">registry:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="string">nacos://$&#123;spring.cloud.nacos.config.server-addr&#125;</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">      <span class="attr">subscribed-services:</span> <span class="string">provider</span>  <span class="comment">#要订阅的服务  默认是 * </span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span>   <span class="comment">#registry address 引用这个</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yml</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">           <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">application-$&#123;spring.profiles.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</span></span><br><span class="line">           <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">database-$&#123;spring.profiles.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure>



<p>需要调用 provider 的地方使用</p>
<p>@DubboReference 注解需要调用的接口即可</p>
<p>具体可以参考</p>
<p><a href="https://github.com/nemowang/springcloud-dubbo-nacos-example">https://github.com/nemowang/springcloud-dubbo-nacos-example</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="consumer-先启动不报错配置"><a href="#consumer-先启动不报错配置" class="headerlink" title="consumer 先启动不报错配置"></a>consumer 先启动不报错配置</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费者配置不主动监督服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConsumerConfig <span class="title">consumerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ConsumerConfig consumerConfig = <span class="keyword">new</span> ConsumerConfig();</span><br><span class="line">       consumerConfig.setCheck(<span class="keyword">false</span>);</span><br><span class="line">       consumerConfig.setTimeout(<span class="number">5000</span>);</span><br><span class="line">       <span class="keyword">return</span> consumerConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="链路追踪"><a href="#链路追踪" class="headerlink" title="链路追踪"></a>链路追踪</h4><p>消费者 访问 供应者 前把追踪码携带到请求中</p>
<p>MDC 在 “2021-03-31分布式 日志追踪 链路追踪.md” 中有提到过</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Activate(group = CommonConstants.CONSUMER)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConsumerFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>&#123;</span><br><span class="line">		RpcContext context = RpcContext.getContext();</span><br><span class="line">        String trace = MDC.get(<span class="string">&quot;logTrackId&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(trace != <span class="keyword">null</span>) </span><br><span class="line">			context.setAttachment(<span class="string">&quot;logTrackId&quot;</span>, trace);</span><br><span class="line">		Result result =  invoker.invoke(invocation);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>供应者在执行准确方法前把追踪码放入 MDC</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Activate(group = CommonConstants.PROVIDER)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboProviderFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//消费者携带的参数</span></span><br><span class="line">		Map&lt;String, Object&gt; attachments = RpcContext.getContext().getObjectAttachments();</span><br><span class="line">		String trace = attachments.get(<span class="string">&quot;logTrackId&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(trace != <span class="keyword">null</span>) </span><br><span class="line">			MDC.set(<span class="string">&quot;logTrackId&quot;</span>,trace);</span><br><span class="line">		Result result =  invoker.invoke(invocation);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>链路追踪 完~</p>
<h4 id="封装-dubbo-隐式传递"><a href="#封装-dubbo-隐式传递" class="headerlink" title="封装 dubbo 隐式传递"></a>封装 dubbo 隐式传递</h4><p>如果在调用 dubbo时 需要传递或转换的信息较多可以用一下方式处理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Activate(group = CommonConstants.CONSUMER)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConsumerFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>&#123;</span><br><span class="line">		RpcContext context = RpcContext.getContext();</span><br><span class="line">		<span class="keyword">for</span> (DubboProcess processor : ProcessUtils.getAllProcessor()) &#123;</span><br><span class="line">			processor.before(context);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Result result =  invoker.invoke(invocation);</span><br><span class="line">			<span class="keyword">for</span>(DubboTransfer transfer : TransferUtils.getAllTransfer()) &#123;</span><br><span class="line">				result = transfer.devanning(result);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">			log.debug(<span class="string">&quot;Dubbo Call [&quot;</span> + context.getMethodName() + <span class="string">&quot;] Elapsed [&quot;</span> + (endTime - startTime) + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Activate(group = CommonConstants.PROVIDER)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboProviderFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>&#123;</span><br><span class="line">		Map&lt;String, Object&gt; attachments = RpcContext.getContext().getObjectAttachments();</span><br><span class="line">		<span class="keyword">for</span> (DubboProcess processor : ProcessUtils.getAllProcessor()) &#123;</span><br><span class="line">			processor.after(attachments);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		Result result =  invoker.invoke(invocation);</span><br><span class="line">		<span class="keyword">for</span>(DubboTransfer transfer : TransferUtils.getAllTransfer()) &#123;</span><br><span class="line">			result = transfer.encasement(result);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DubboProcess</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> String prefix = <span class="string">&quot;rpc_hide_param_&quot;</span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(RpcContext context)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Map&lt;String, Object&gt; params)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessUtils</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> List&lt;DubboProcess&gt; list = <span class="keyword">null</span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;DubboProcess&gt; <span class="title">getAllProcessor</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(list == <span class="keyword">null</span>) &#123;</span><br><span class="line">			list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">			List&lt;Class&lt;?&gt;&gt; processors = CommClass.getAllClassByInterface(DubboProcess.class, <span class="string">&quot;org.lqs1848.common.dubbo.process.impl&quot;</span>);</span><br><span class="line">			<span class="keyword">for</span>(Class&lt;?&gt; p :  processors) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					list.add((DubboProcess) p.newInstance());</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//分页处理器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageProcess</span> <span class="keyword">implements</span> <span class="title">DubboProcess</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(RpcContext context)</span> </span>&#123;</span><br><span class="line">		Page page = PagePass.getLocalPage();</span><br><span class="line">		<span class="keyword">if</span>(page != <span class="keyword">null</span>) &#123;</span><br><span class="line">			context.setAttachment(prefix + <span class="string">&quot;isStartPage&quot;</span>, page.getOrderBy());</span><br><span class="line">			context.setAttachment(prefix + Constants.PAGE_NUM, page.getPageNum());</span><br><span class="line">			context.setAttachment(prefix + Constants.PAGE_SIZE, page.getPageSize());</span><br><span class="line">			context.setAttachment(prefix + Constants.IS_ASC, page.getOrderBy());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(params.containsKey(prefix + <span class="string">&quot;isStartPage&quot;</span>)) &#123;</span><br><span class="line">			PagePass.tolerancePage(Convert.toInt(params.get(prefix + Constants.PAGE_NUM)), Convert.toInt(params.get(prefix + Constants.PAGE_SIZE)), Convert.toStr(params.get(prefix + Constants.IS_ASC)));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//分表标示携带</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SliciTableProcess</span> <span class="keyword">implements</span> <span class="title">DubboProcess</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(RpcContext context)</span> </span>&#123;</span><br><span class="line">		Integer flag = SliciTableUtils.getCurSubFlag();</span><br><span class="line">		<span class="keyword">if</span>(flag != <span class="keyword">null</span>)</span><br><span class="line">			context.setAttachment(prefix + <span class="string">&quot;sliciTableFlag&quot;</span>, flag);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">		SliciTableUtils.clearSubFlag();	</span><br><span class="line">		Integer flag = Convert.toInt(params.get(prefix + <span class="string">&quot;sliciTableFlag&quot;</span>));</span><br><span class="line">		<span class="keyword">if</span>(flag != <span class="keyword">null</span>)</span><br><span class="line">			SliciTableUtils.setCurSubFlag(flag);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//追踪码</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceProcess</span> <span class="keyword">implements</span> <span class="title">DubboProcess</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(RpcContext context)</span> </span>&#123;</span><br><span class="line">		String trace = Convert.toStr(TraceUtils.getTrace());</span><br><span class="line">		<span class="keyword">if</span>(trace != <span class="keyword">null</span>) </span><br><span class="line">			context.setAttachment(prefix + <span class="string">&quot;logTrackId&quot;</span>, trace);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">		String trace = Convert.toStr(params.get(prefix + <span class="string">&quot;logTrackId&quot;</span>));</span><br><span class="line">		<span class="keyword">if</span>(trace != <span class="keyword">null</span>) </span><br><span class="line">			TraceUtils.setTrace(trace);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DubboTransfer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">order</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//消费者实现</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">devanning</span><span class="params">(Result result)</span></span>;</span><br><span class="line">    <span class="comment">//提供者实现</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">encasement</span><span class="params">(Result result)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransferUtils</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> List&lt;DubboTransfer&gt; list = <span class="keyword">null</span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;DubboTransfer&gt; <span class="title">getAllTransfer</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(list == <span class="keyword">null</span>) &#123;</span><br><span class="line">			list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">			List&lt;Class&lt;?&gt;&gt; transfers = CommClass.getAllClassByInterface(DubboTransfer.class, <span class="string">&quot;org.lqs1848.common.dubbo.transfer.impl&quot;</span>);</span><br><span class="line">			<span class="keyword">for</span>(Class&lt;?&gt; p :  transfers) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					list.add((DubboTransfer) p.newInstance());</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			list.sort(<span class="keyword">new</span> Comparator&lt;DubboTransfer&gt;() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(DubboTransfer o1, DubboTransfer o2)</span> </span>&#123;</span><br><span class="line">					<span class="keyword">if</span>(o1.order() &gt; o2.order())</span><br><span class="line">						<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span>(o1.order() &lt; o2.order())</span><br><span class="line">						<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//PageHelper 分页转换</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageTransfer</span> <span class="keyword">implements</span> <span class="title">DubboTransfer</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">devanning</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">		Object obj = result.getValue();</span><br><span class="line">		<span class="keyword">if</span> (obj == <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		PageMessage page = (PageMessage) result.getObjectAttachment(<span class="string">&quot;PageMessage&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (page != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//消费者 查看传递的参数中有 Page 的分页信息</span></span><br><span class="line">            <span class="comment">//把传输过程中丢失分页信息的 Page 重新封装成 PageHelper的Page</span></span><br><span class="line">			result.setValue(page.getPageToPageHelper((List) obj));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">encasement</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">		Object obj = result.getValue();</span><br><span class="line">		<span class="keyword">if</span> (obj == <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		<span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Page) &#123;</span><br><span class="line">			<span class="comment">//提供者发现 返回的结果是 PageHelper 插件提供的 Page对象 把Page 转换成可以json传递的对象</span></span><br><span class="line">			result.setAttachment(<span class="string">&quot;PageMessage&quot;</span>, <span class="keyword">new</span> PageMessage((Page)obj));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>process 用来传递参数 比如携带追踪码 分表标示信息 还有分页信息 等</p>
<p>​    MyBatis 的 PageHelper 插件的 Page 就是个 List 在传递过程中 被转换为 JSON 会丢失分页信息 所以 Page 需要单独处理</p>
<p>transfer 用来处理 result</p>
<p>这样封装后 有使用 dubbo的就集成这个jar包 provider和consumer都同时集成</p>
<p><strong>注意:</strong></p>
<p><strong>要让dubbo的过滤器生效必须配置</strong></p>
<p>​    <strong>META-INF 下添加 dubbo/internal/org.apache.dubbo.rpc.Filter 文件</strong></p>
<p><strong>文件内容为:</strong></p>
<p><strong>providerFilter=org.lqs1848.common.dubbo.filter.DubboProviderFilter</strong><br><strong>consumerFilter=org.lqs1848.common.dubbo.filter.DubboConsumerFilter</strong></p>
<p><strong>指明 Filter 的路径</strong></p>
<p>反正过滤器不生效 百度下 org.apache.dubbo.rpc.Filter 或者 dubbo SPI</p>
<h4 id="异常传递"><a href="#异常传递" class="headerlink" title="异常传递"></a>异常传递</h4><p>Dubbo默认会把 项目的自定义异常 转换为 RuntimeException 给 consumer</p>
<p>会导致 consumer 全局异常拦截不生效</p>
<p>首先看一下 dubbo 自己的默认实现</p>
<p>org.apache.dubbo.rpc.filter.ExceptionFilter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Activate(group = CommonConstants.PROVIDER)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span>, <span class="title">Filter</span>.<span class="title">Listener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(ExceptionFilter.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Result appResponse, Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appResponse.hasException() &amp;&amp; GenericService.class != invoker.getInterface()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Throwable exception = appResponse.getException();</span><br><span class="line">                <span class="keyword">if</span> (!(exception <span class="keyword">instanceof</span> RuntimeException) &amp;&amp; (exception <span class="keyword">instanceof</span> Exception)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Method method = invoker.getInterface().getMethod(invocation.getMethodName(), invocation.getParameterTypes());</span><br><span class="line">                    Class&lt;?&gt;[] exceptionClassses = method.getExceptionTypes();</span><br><span class="line">                    <span class="keyword">for</span> (Class&lt;?&gt; exceptionClass : exceptionClassses) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (exception.getClass().equals(exceptionClass)) &#123;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                logger.error(<span class="string">&quot;Got unchecked and undeclared exception which called by &quot;</span> + RpcContext.getContext().getRemoteHost() + <span class="string">&quot;. service: &quot;</span> + invoker.getInterface().getName() + <span class="string">&quot;, method: &quot;</span> + invocation.getMethodName() + <span class="string">&quot;, exception: &quot;</span> + exception.getClass().getName() + <span class="string">&quot;: &quot;</span> + exception.getMessage(), exception);</span><br><span class="line">                String serviceFile = ReflectUtils.getCodeBase(invoker.getInterface());</span><br><span class="line">                String exceptionFile = ReflectUtils.getCodeBase(exception.getClass());</span><br><span class="line">                <span class="keyword">if</span> (serviceFile == <span class="keyword">null</span> || exceptionFile == <span class="keyword">null</span> || serviceFile.equals(exceptionFile)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String className = exception.getClass().getName();</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.&quot;</span>) || className.startsWith(<span class="string">&quot;javax.&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> RpcException) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                appResponse.setException(<span class="keyword">new</span> RuntimeException(StringUtils.toString(exception)));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Fail to ExceptionFilter when called by &quot;</span> + RpcContext.getContext().getRemoteHost() + <span class="string">&quot;. service: &quot;</span> + invoker.getInterface().getName() + <span class="string">&quot;, method: &quot;</span> + invocation.getMethodName() + <span class="string">&quot;, exception: &quot;</span> + e.getClass().getName() + <span class="string">&quot;: &quot;</span> + e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e, Invoker&lt;?&gt; invoker, Invocation invocation)</span> </span>&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Got unchecked and undeclared exception which called by &quot;</span> + RpcContext.getContext().getRemoteHost() + <span class="string">&quot;. service: &quot;</span> + invoker.getInterface().getName() + <span class="string">&quot;, method: &quot;</span> + invocation.getMethodName() + <span class="string">&quot;, exception: &quot;</span> + e.getClass().getName() + <span class="string">&quot;: &quot;</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogger</span><span class="params">(Logger logger)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>网上大多数文章都是只写了 这一段 但是不告诉你 这个是dubbo 自己的实现</p>
<p>并且也没说 如果不配置 spi 覆盖 dubbo 中默认的 ExceptionFilter 并不会生效</p>
<p>要想自己的自定义异常不被dubbo拦截掉 就得覆盖 默认 ExceptionFilter</p>
<p>首先 SPI 配置文件   dubbo/internal/org.apache.dubbo.rpc.Filter</p>
<p>添加一行</p>
<p>exception=org.lqs1848.common.dubbo.filter.DubboExceptionFilter</p>
<p>再把 dubbo 默认ExceptionFilter(org.apache.dubbo.rpc.filter.ExceptionFilter) 复制到 org.lqs1848.common.dubbo.filter 目录 并改名 DubboExceptionFilter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(className.startsWith(<span class="string">&quot;org.lqs1848.&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">//过滤掉自己的自定义异常</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//dubbo 把它无法识别的异常封装为 RuntimeException 之前把自己的异常放过 ↑↑↑↑↑↑↑↑↑↑↑↑</span></span><br><span class="line">appResponse.setException(<span class="keyword">new</span> RuntimeException(StringUtils.toString(exception)));</span><br></pre></td></tr></table></figure>

<p>这里只写了自定义异常</p>
<p>实际使用中 可能还有 com.netflix.client.ClientException: Load balancer does not have available server for client</p>
<p>这样的降级熔断之类的项目公用的异常</p>
<p>也是需要单独处理</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我引入 dubbo 时面临的需求是 service 已经写完了 必须把 部分 service 分到一个单独的微服务进行维护</p>
<p>所以在不改动任何业务代码的情况下 引入 dubbo</p>
<p>引入 dubbo 后 原先 controller 调用 service 时 分页是 PageHelper  内部是用 ThreadLocal 传递的 分页信息</p>
<p>不想改所有service 就只能在 dubbo 调用上进行传递了</p>
<p>我并没有用 dubbo 来替代 feign</p>
<p>引入 dubbo 纯粹是解决业务上的需求 所以只使用了 <a href="#2">2 dubbo 单独使用</a></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Dubbo</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>SpringCloud</tag>
        <tag>Dubbo</tag>
        <tag>SPI</tag>
        <tag>异常传递</tag>
        <tag>封装</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenCV OCR预处理</title>
    <url>/2021/07/08/2021-07-08%20OpenCV%20OCR%E9%A2%84%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p><img src="/img/opencv/1.jpg"></p>
<p>需要识别出 标签中的 76046 58420</p>
<p>Tesseract 识别大图 速度特别慢</p>
<p>并且 Tesseract 本身也是默认你传递给它的图片是预处理过的</p>
<p>目标把图片处理成这样</p>
<p><img src="/img/opencv/r_111.jpg"></p>
<p><img src="/img/opencv/r_222.jpg"></p>
<p>旋转一下角度</p>
<p><img src="/img/opencv/r_111_jz.jpg"></p>
<p><img src="/img/opencv/r_222_jz.jpg"></p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.lqs1848.cv.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacpp.indexer.IntIndexer;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.javacpp.indexer.UByteRawIndexer;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.global.opencv_core;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.global.opencv_imgcodecs;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.global.opencv_imgproc;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Mat;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.MatVector;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Point;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Rect;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Scalar;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenCV_LableCatch</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//加载图片为灰度图</span></span><br><span class="line">		Mat src = opencv_imgcodecs.imread(<span class="string">&quot;1.jpg&quot;</span>, opencv_imgcodecs.IMREAD_GRAYSCALE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> x = src.cols(); <span class="comment">// 列</span></span><br><span class="line">		<span class="keyword">int</span> y = src.rows(); <span class="comment">// 行</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (x != y) &#123; <span class="comment">// 非正方形的图 截取中心部分为正方形</span></span><br><span class="line">			<span class="keyword">if</span> (x &lt; y) &#123;</span><br><span class="line">				<span class="keyword">int</span> j = (y - x) / <span class="number">2</span>;</span><br><span class="line">				src = src.apply(<span class="keyword">new</span> Rect(<span class="number">0</span>, j, x, x));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">int</span> j = (x - y) / <span class="number">2</span>;</span><br><span class="line">				src = src.apply(<span class="keyword">new</span> Rect(j, <span class="number">0</span>, y, y));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="comment">// if</span></span><br><span class="line"></span><br><span class="line">		Mat gray = <span class="keyword">new</span> Mat();</span><br><span class="line">		<span class="comment">//把大小不确定的图片 转换为固定 3000 * 3000</span></span><br><span class="line">		opencv_imgproc.resize(src, gray, <span class="keyword">new</span> Size(<span class="number">3000</span>, <span class="number">3000</span>));</span><br><span class="line"></span><br><span class="line">		Mat target = <span class="keyword">new</span> Mat();</span><br><span class="line">		<span class="comment">// 二值化</span></span><br><span class="line">		opencv_imgproc.threshold(gray, target, <span class="number">0</span>, <span class="number">255</span>, opencv_imgproc.THRESH_OTSU);</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\cv\\ezh.jpg&quot;</span>, target);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// new Scalar(255) 初始matrix的数值 不定义每次腐蚀膨胀的结果都会不一样 坑爹</span></span><br><span class="line">		Mat kernel = <span class="keyword">new</span> Mat(<span class="keyword">new</span> Size(<span class="number">20</span>, <span class="number">20</span>), opencv_core.CV_8UC1, <span class="keyword">new</span> Scalar(<span class="number">255</span>));</span><br><span class="line">		<span class="comment">// 腐蚀膨胀  修改迭代次数 和 kernel 的 size 保证数字有被处理成可识别的轮廓</span></span><br><span class="line">		opencv_imgproc.morphologyEx(target, src, opencv_imgproc.MORPH_OPEN, kernel, <span class="keyword">new</span> Point(-<span class="number">1</span>, -<span class="number">1</span>), <span class="number">2</span>,</span><br><span class="line">				opencv_imgproc.MORPH_RECT, opencv_imgproc.morphologyDefaultBorderValue());</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\cv\\fspz.jpg&quot;</span>, src);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 反色</span></span><br><span class="line">		opencv_core.bitwise_not(src, src);</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\cv\\fs.jpg&quot;</span>, src);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 存放轮廓</span></span><br><span class="line">		MatVector contours = <span class="keyword">new</span> MatVector();</span><br><span class="line">		Mat hierarchy = <span class="keyword">new</span> Mat();</span><br><span class="line">		<span class="comment">// 查找轮廓</span></span><br><span class="line">		opencv_imgproc.findContours(src, contours, hierarchy, opencv_imgproc.RETR_TREE,</span><br><span class="line">				opencv_imgproc.CHAIN_APPROX_NONE);</span><br><span class="line"></span><br><span class="line">		Mat contours_img = <span class="keyword">new</span> Mat(src.size(), opencv_core.CV_8U, <span class="keyword">new</span> Scalar(<span class="number">255</span>));</span><br><span class="line">		List&lt;Rect&gt; rects = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		IntIndexer hie = hierarchy.createIndexer();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; contours.size(); i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (hie.get(<span class="number">0</span>, i, <span class="number">2</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">				Mat contour = contours.get(i);</span><br><span class="line">				<span class="keyword">double</span> area = opencv_imgproc.contourArea(contour);</span><br><span class="line">				<span class="keyword">double</span> mins = <span class="number">100</span>;</span><br><span class="line">				<span class="keyword">if</span> (area &gt; mins) &#123;</span><br><span class="line">					Rect rect = opencv_imgproc.boundingRect(contour);</span><br><span class="line">					rects.add(rect);</span><br><span class="line">					opencv_imgproc.drawContours(contours_img, contours, i, <span class="keyword">new</span> Scalar(<span class="number">0</span>), -<span class="number">1</span>, opencv_imgproc.LINE_8,</span><br><span class="line">							hierarchy, Integer.MAX_VALUE, <span class="keyword">new</span> Point());</span><br><span class="line"><span class="comment">//					opencv_imgcodecs.imwrite(&quot;E:\\cv\\x_&quot; + i + &quot;.jpg&quot;, target.apply(rect));</span></span><br><span class="line">				&#125; <span class="comment">// if</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="comment">// for</span></span><br><span class="line">			<span class="comment">// opencv_imgcodecs.imwrite(&quot;E:\\cv\\x_.jpg&quot;, contours_img);</span></span><br><span class="line"></span><br><span class="line">		kernel = <span class="keyword">new</span> Mat(<span class="keyword">new</span> Size(<span class="number">7</span>, <span class="number">7</span>), opencv_core.CV_8UC1, <span class="keyword">new</span> Scalar(<span class="number">255</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> s1_id = <span class="number">0</span>, s2_id = <span class="number">0</span>, s1_jump = <span class="number">0</span>, s2_jump = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rects.size(); i++) &#123;</span><br><span class="line">			Rect rect = rects.get(i);</span><br><span class="line">			Mat roi = target.apply(rect);</span><br><span class="line">			<span class="keyword">if</span> (roi.rows() &lt;= roi.cols())</span><br><span class="line">				opencv_imgproc.resize(roi, roi, <span class="keyword">new</span> Size(<span class="number">300</span>, <span class="number">100</span>), <span class="number">0</span>, <span class="number">0</span>, opencv_imgproc.INTER_NEAREST);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				opencv_imgproc.resize(roi, roi, <span class="keyword">new</span> Size(<span class="number">100</span>, <span class="number">300</span>), <span class="number">0</span>, <span class="number">0</span>, opencv_imgproc.INTER_NEAREST);</span><br><span class="line">			</span><br><span class="line">			opencv_imgproc.morphologyEx(roi, roi, opencv_imgproc.MORPH_GRADIENT, kernel, <span class="keyword">new</span> Point(-<span class="number">1</span>, -<span class="number">1</span>), <span class="number">1</span>,</span><br><span class="line">					opencv_imgproc.MORPH_RECT, opencv_imgproc.morphologyDefaultBorderValue());</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//opencv_imgproc.medianBlur(roi, roi, 7);</span></span><br><span class="line">			</span><br><span class="line">			<span class="keyword">int</span> t_jump = stringJudge(roi);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 选出跳变次数最多的两个轮廓</span></span><br><span class="line">			<span class="comment">//if (t_jump &lt; 20) &#123;</span></span><br><span class="line">				<span class="keyword">if</span> (t_jump &gt;= s1_jump) &#123;</span><br><span class="line">					s2_id = s1_id;</span><br><span class="line">					s2_jump = s1_jump;</span><br><span class="line">					s1_id = i;</span><br><span class="line">					s1_jump = t_jump;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (t_jump &lt; s1_jump &amp;&amp; t_jump &gt;= s2_jump) &#123;</span><br><span class="line">					s2_id = i;</span><br><span class="line">					s2_jump = t_jump;</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="comment">//&#125; // if</span></span><br><span class="line">		&#125; <span class="comment">// for</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 结果排序，坐标最左为第一串数字</span></span><br><span class="line">		<span class="keyword">if</span> (rects.get(s1_id).width() &lt; rects.get(s1_id).height()</span><br><span class="line">				&amp;&amp; rects.get(s1_id).tl().y() &lt; rects.get(s2_id).tl().y()) &#123;</span><br><span class="line">			s1_id = s1_id + s2_id;</span><br><span class="line">			s2_id = s1_id - s2_id;</span><br><span class="line">			s1_id = s1_id - s2_id;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Rect ns1 = rects.get(s1_id);</span><br><span class="line">		<span class="keyword">if</span> (isCentre(target, ns1))</span><br><span class="line">			ns1 = <span class="keyword">new</span> Rect(ns1.x() - <span class="number">10</span>, ns1.y() - <span class="number">10</span>, ns1.width() + <span class="number">20</span>, ns1.height() + <span class="number">20</span>);</span><br><span class="line">		Rect ns2 = rects.get(s2_id);</span><br><span class="line">		<span class="keyword">if</span> (isCentre(target, ns2))</span><br><span class="line">			ns2 = <span class="keyword">new</span> Rect(ns2.x() - <span class="number">10</span>, ns2.y() - <span class="number">10</span>, ns2.width() + <span class="number">20</span>, ns2.height() + <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">		Mat dst1 = gray.apply(ns1);</span><br><span class="line">		Mat dst2 = gray.apply(ns2);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (dst1.cols() &lt; dst1.rows()) &#123;</span><br><span class="line">			opencv_core.transpose(dst1, dst1);</span><br><span class="line">			opencv_core.flip(dst1, dst1, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (dst2.cols() &lt; dst2.rows()) &#123;</span><br><span class="line">			opencv_core.transpose(dst2, dst2);</span><br><span class="line">			opencv_core.flip(dst2, dst2, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		opencv_imgproc.resize(dst1, dst1, <span class="keyword">new</span> Size(<span class="number">300</span>, <span class="number">100</span>), <span class="number">0</span>, <span class="number">0</span>, opencv_imgproc.INTER_NEAREST);</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\cv\\r_111.jpg&quot;</span>, dst1);</span><br><span class="line">		dst1 = OpenCVUtils.adjustAngle(dst1);</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\cv\\r_111_jz.jpg&quot;</span>, dst1);</span><br><span class="line">		opencv_imgproc.resize(dst2, dst2, <span class="keyword">new</span> Size(<span class="number">300</span>, <span class="number">100</span>), <span class="number">0</span>, <span class="number">0</span>, opencv_imgproc.INTER_NEAREST);</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\cv\\r_222.jpg&quot;</span>, dst2);</span><br><span class="line">		dst2 = OpenCVUtils.adjustAngle(dst2);</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\cv\\r_222_jz.jpg&quot;</span>, dst2);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断轮廓 是否在中心范围</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isCentre</span><span class="params">(Mat mat, Rect rect)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> x = Math.abs((mat.cols() / <span class="number">2</span>) - (mat.cols() - rect.x()));</span><br><span class="line">		<span class="keyword">int</span> y = Math.abs((mat.rows() / <span class="number">2</span>) - (mat.rows() - rect.y()));</span><br><span class="line">		<span class="keyword">return</span> x &lt; mat.cols() / <span class="number">3</span> &amp;&amp; y &lt; mat.rows() / <span class="number">3</span>;</span><br><span class="line">	&#125;<span class="comment">//method isCentre</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断区域是否为数字</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">stringJudge</span><span class="params">(Mat img)</span> </span>&#123;</span><br><span class="line">		UByteRawIndexer intIndexer = img.createIndexer();</span><br><span class="line">		<span class="keyword">int</span> rows = img.rows();</span><br><span class="line">		<span class="keyword">int</span> cols = img.cols();</span><br><span class="line">		<span class="keyword">int</span> jump = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// 数字横着放，优先遍历列</span></span><br><span class="line">		<span class="keyword">if</span> (rows &lt; cols) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> row = <span class="number">0</span>; row &lt; rows; row++) &#123;</span><br><span class="line">				<span class="keyword">boolean</span> wb_flag = <span class="keyword">false</span>;<span class="comment">// 白色到黑色</span></span><br><span class="line">				<span class="keyword">boolean</span> bw_flag = <span class="keyword">false</span>;</span><br><span class="line">				<span class="keyword">int</span> t_jump = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> col = <span class="number">0</span>; col &lt; cols; col++) &#123;</span><br><span class="line">					<span class="keyword">if</span> (col + <span class="number">1</span> &lt; cols) &#123;</span><br><span class="line">						<span class="keyword">int</span> now_point = intIndexer.get(row, col);</span><br><span class="line">						<span class="keyword">int</span> next_point = intIndexer.get(row, col + <span class="number">1</span>);</span><br><span class="line">						<span class="keyword">if</span> (now_point == <span class="number">255</span> &amp;&amp; next_point == <span class="number">0</span>) &#123;</span><br><span class="line">							wb_flag = <span class="keyword">true</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> (now_point == <span class="number">0</span> &amp;&amp; next_point == <span class="number">255</span> &amp;&amp; wb_flag) &#123;</span><br><span class="line">							bw_flag = <span class="keyword">true</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> (wb_flag &amp;&amp; bw_flag) &#123;</span><br><span class="line">							++t_jump;</span><br><span class="line">							wb_flag = <span class="keyword">false</span>;</span><br><span class="line">							bw_flag = <span class="keyword">false</span>;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (t_jump &gt; jump)</span><br><span class="line">						jump = t_jump;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> col = <span class="number">0</span>; col &lt; cols; col++) &#123;</span><br><span class="line">				<span class="keyword">boolean</span> wb_flag = <span class="keyword">false</span>;</span><br><span class="line">				<span class="keyword">boolean</span> bw_flag = <span class="keyword">false</span>;</span><br><span class="line">				<span class="keyword">int</span> t_jump = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> row = <span class="number">0</span>; row &lt; rows; row++) &#123;</span><br><span class="line">					<span class="keyword">if</span> (row + <span class="number">1</span> &lt; rows) &#123;</span><br><span class="line">						<span class="keyword">int</span> now_point = intIndexer.get(row, col);</span><br><span class="line">						<span class="keyword">int</span> next_point = intIndexer.get(row + <span class="number">1</span>, col);</span><br><span class="line">						<span class="keyword">if</span> (now_point == <span class="number">255</span> &amp;&amp; next_point == <span class="number">0</span>) &#123;</span><br><span class="line">							wb_flag = <span class="keyword">true</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> (now_point == <span class="number">0</span> &amp;&amp; next_point == <span class="number">255</span> &amp;&amp; wb_flag) &#123;</span><br><span class="line">							bw_flag = <span class="keyword">true</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> (wb_flag &amp;&amp; bw_flag) &#123;</span><br><span class="line">							++t_jump;</span><br><span class="line">							wb_flag = <span class="keyword">false</span>;</span><br><span class="line">							bw_flag = <span class="keyword">false</span>;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (t_jump &gt; jump)</span><br><span class="line">						jump = t_jump;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> jump;</span><br><span class="line">	&#125;<span class="comment">//method </span></span><br><span class="line">	</span><br><span class="line">&#125;<span class="comment">//class</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.lqs1848.cv.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.global.opencv_core;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.global.opencv_imgcodecs;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.global.opencv_imgproc;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Mat;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.MatVector;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Point;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Point2f;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Rect;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.RotatedRect;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Scalar;</span><br><span class="line"><span class="keyword">import</span> org.bytedeco.opencv.opencv_core.Size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenCVUtils</span> </span>&#123; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 矩形 矫正角度</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * 非直线矫正！！！！</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> gray</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Mat <span class="title">adjustAngle</span><span class="params">(Mat gray)</span></span>&#123;</span><br><span class="line">		<span class="comment">//Mat gray = opencv_imgcodecs.imread(&quot;E:\\test\\1.jpg&quot;, opencv_imgcodecs.IMREAD_GRAYSCALE);</span></span><br><span class="line"></span><br><span class="line">		Mat binImg = <span class="keyword">new</span> Mat();</span><br><span class="line">		<span class="comment">// 二值化</span></span><br><span class="line">		opencv_imgproc.threshold(gray, binImg, <span class="number">100</span>, <span class="number">255</span>, opencv_imgproc.CV_THRESH_BINARY_INV);</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\test\\ezh222.jpg&quot;</span>, binImg);</span><br><span class="line">		</span><br><span class="line">		Mat target = <span class="keyword">new</span> Mat();</span><br><span class="line">		opencv_imgproc.threshold(gray, target, <span class="number">0</span>, <span class="number">255</span>, opencv_imgproc.THRESH_OTSU);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// new Size(15, 15) 可以慢慢调整</span></span><br><span class="line">		Mat kernel = <span class="keyword">new</span> Mat(<span class="keyword">new</span> Size(<span class="number">15</span>, <span class="number">15</span>), opencv_core.CV_8UC1, <span class="keyword">new</span> Scalar(<span class="number">255</span>));</span><br><span class="line">		Mat morphologyDst = <span class="keyword">new</span> Mat();</span><br><span class="line">        <span class="comment">//1 迭代次数可以修改</span></span><br><span class="line">		opencv_imgproc.morphologyEx(binImg, morphologyDst, opencv_imgproc.MORPH_GRADIENT, kernel, <span class="keyword">new</span> Point(-<span class="number">1</span>, -<span class="number">1</span>), <span class="number">1</span>,</span><br><span class="line">				opencv_imgproc.MORPH_RECT, opencv_imgproc.morphologyDefaultBorderValue());</span><br><span class="line">		<span class="comment">//查看腐蚀膨胀的信息  根据这个图调整 size  保证腐蚀膨胀出来的轮廓是数字连在一起的轮廓</span></span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\test\\morphology.jpg&quot;</span>, morphologyDst);</span><br><span class="line"></span><br><span class="line">		Mat cannyDst = <span class="keyword">new</span> Mat();</span><br><span class="line">		opencv_imgproc.Canny(morphologyDst, cannyDst, <span class="number">150</span>, <span class="number">200</span>);</span><br><span class="line">		<span class="comment">//opencv_imgcodecs.imwrite(&quot;E:\\test\\canny.jpg&quot;, cannyDst);</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 获取最大矩形</span></span><br><span class="line">		RotatedRect rect = findMaxRect(cannyDst);</span><br><span class="line">		<span class="comment">// 旋转矩形</span></span><br><span class="line">		Mat CorrectImg = rotation(target , rect);</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\test\\xz1.jpg&quot;</span>, CorrectImg);</span><br><span class="line">		<span class="keyword">return</span> CorrectImg;</span><br><span class="line">		<span class="comment">//尝试二值化看效果会不会更好</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		kernel = new Mat(new Size(0, 0), opencv_core.CV_8UC1, new Scalar(255));</span></span><br><span class="line"><span class="comment">		opencv_imgproc.morphologyEx(CorrectImg, CorrectImg, opencv_imgproc.MORPH_GRADIENT, kernel, new Point(-1, -1), 1,</span></span><br><span class="line"><span class="comment">				opencv_imgproc.MORPH_RECT, opencv_imgproc.morphologyDefaultBorderValue());</span></span><br><span class="line"><span class="comment">		opencv_imgcodecs.imwrite(&quot;E:\\test\\xz2.jpg&quot;, CorrectImg);</span></span><br><span class="line"><span class="comment">		return CorrectImg;</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RotatedRect <span class="title">findMaxRect</span><span class="params">(Mat cannyMat)</span> </span>&#123;</span><br><span class="line">		MatVector contours = <span class="keyword">new</span> MatVector();</span><br><span class="line">		Mat hierarchy = <span class="keyword">new</span> Mat();</span><br><span class="line">		<span class="comment">// 寻找轮廓</span></span><br><span class="line">		opencv_imgproc.findContours(cannyMat, contours, hierarchy, opencv_imgproc.RETR_EXTERNAL,</span><br><span class="line">				opencv_imgproc.CHAIN_APPROX_NONE, <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">		<span class="comment">// 找出匹配到的最大轮廓</span></span><br><span class="line">		<span class="keyword">double</span> area = opencv_imgproc.boundingRect(contours.get(<span class="number">0</span>)).area();</span><br><span class="line">		<span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// 找出匹配到的最大轮廓</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; contours.size(); i++) &#123;</span><br><span class="line">			<span class="keyword">double</span> tempArea = opencv_imgproc.boundingRect(contours.get(i)).area();</span><br><span class="line">			<span class="keyword">if</span> (tempArea &gt; area) &#123;</span><br><span class="line">				area = tempArea;</span><br><span class="line">				index = i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		Mat matOfPoint2f = <span class="keyword">new</span> Mat(contours.get(index));</span><br><span class="line">		RotatedRect rect = opencv_imgproc.minAreaRect(matOfPoint2f);</span><br><span class="line">		Rect rect2 = opencv_imgproc.boundingRect(contours.get(index));</span><br><span class="line">		opencv_imgcodecs.imwrite(<span class="string">&quot;E:\\test\\lk.jpg&quot;</span>, cannyMat.apply(rect2));</span><br><span class="line">		<span class="keyword">return</span> rect;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Mat <span class="title">rotation</span><span class="params">(Mat cannyMat, RotatedRect rect)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">double</span> angle = rect.angle();</span><br><span class="line">		Point2f center = rect.center();</span><br><span class="line">		Mat CorrectImg = <span class="keyword">new</span> Mat(cannyMat.size(), cannyMat.type());</span><br><span class="line">		cannyMat.copyTo(CorrectImg);</span><br><span class="line">		<span class="comment">// 得到旋转矩阵算子</span></span><br><span class="line">		Mat matrix = opencv_imgproc.getRotationMatrix2D(center, angle, <span class="number">0.8</span>);</span><br><span class="line">		opencv_imgproc.warpAffine(CorrectImg, CorrectImg, matrix, CorrectImg.size(), <span class="number">1</span>, <span class="number">0</span>, <span class="keyword">new</span> Scalar(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">		<span class="keyword">return</span> CorrectImg;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;<span class="comment">// class</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/img/opencv/fspz.jpg" alt="fspz.jpg"></p>
<p>fspz.jpg 出来的图要一点点调整参数 保证 两块数字区域被正确的处理成可识别的轮廓</p>
<p>如果数字区域 二值化后不可见 那就是无法识别</p>
<p><img src="/img/opencv/xz_lk.jpg"></p>
<p>旋转要保证 数字的轮廓是正确的</p>
<h1 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h1><p>首先 bytedeco 的 API 资料是真的少</p>
<p>网上的资料使用的 查找轮廓 返回的轮廓信息都是 二维数组</p>
<p>bytedeco 给的是个 Mat ？？？</p>
<p>找了好久才发现原来是用 Indexer 读取 (<a href="https://github.com/bytedeco/javacv/issues/276">https://github.com/bytedeco/javacv/issues/276</a>)</p>
<p>腐蚀膨胀的 kernel 不传递 Scalar 每次腐蚀膨胀出来的结果都不一样…</p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>如果对焦不准的话 处理后效果还是很一般 关键还是要原图有对上焦</p>
<p>线上代码还是同事进行了多种处理</p>
<p>比如 同时本地请求 并发查询百度</p>
<p>并且本地做多种处理 </p>
<p>源码和上方代码有差异 以源码为准</p>
<p><em><strong><center><a href="https://github.com/lqs1848/java_workspace/tree/main/NumberOCR">源码</a></center></strong></em></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>OpenCV</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>OpenCV</tag>
        <tag>OCR</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringMVC 路由约束</title>
    <url>/2021/08/26/2021-08-26%20SpringMVC%20%E8%B7%AF%E7%94%B1%E7%BA%A6%E6%9D%9F/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="NET-Core-中的概念"><a href="#NET-Core-中的概念" class="headerlink" title=".NET Core 中的概念"></a>.NET Core 中的概念</h1><p>无聊逛论坛 突然看到了个 路由约束</p>
<p>好像没听过 搜索了一下 原来是 .NET Core 中的概念 <a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/routing?view=aspnetcore-5.0#route-constraint-reference">文档</a></p>
<p>[GET] /api/posts/{id}<br>[GET] /api/posts/{name}</p>
<p>这样两个地址 可以通过 路由约束 分别映射到不同的地址</p>
<blockquote>
<p>.NET Core内置的路由约束</p>
<p>检查数据类型的约束<br>检查数据的值/长度/范围的约束<br>正则表达式约束</p>
<h3 id="检查数据类型的约束"><a href="#检查数据类型的约束" class="headerlink" title="检查数据类型的约束"></a>检查数据类型的约束</h3><table>
<thead>
<tr>
<th>约束</th>
<th>行内</th>
<th>Constraint类</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>int</td>
<td><code>&#123;id:int&#125;</code></td>
<td><code>IntRouteConstraint</code></td>
<td>只允许int32整数</td>
</tr>
<tr>
<td>alpha</td>
<td><code>&#123;id:alpha&#125;</code></td>
<td><code>AlphaRouteConstraint</code></td>
<td>只能包含大小写字母</td>
</tr>
<tr>
<td>bool</td>
<td><code>&#123;id:bool&#125;</code></td>
<td><code>BoolRouteConstraint</code></td>
<td>只允许布尔类型</td>
</tr>
<tr>
<td>datetime</td>
<td><code>&#123;id:datetime&#125;</code></td>
<td><code>DateTimeRouteConstraint</code></td>
<td>只允许日期格式</td>
</tr>
<tr>
<td>decimal</td>
<td><code>&#123;id:decimal&#125;</code></td>
<td><code>DecimalRouteConstraint</code></td>
<td>只允许decimal类型</td>
</tr>
<tr>
<td>double</td>
<td><code>&#123;id:double&#125;</code></td>
<td><code>DoubleRouteConstraint</code></td>
<td>只允许double类型</td>
</tr>
<tr>
<td>float</td>
<td><code>&#123;id:float&#125;</code></td>
<td><code>FloatRouteConstraint</code></td>
<td>只允许float类型</td>
</tr>
<tr>
<td>guid</td>
<td><code>&#123;id:guid&#125;</code></td>
<td><code>GuidRouteConstraint</code></td>
<td>只允许guid类型</td>
</tr>
</tbody></table>
<h3 id="检查数据的值-长度-范围的约束"><a href="#检查数据的值-长度-范围的约束" class="headerlink" title="检查数据的值/长度/范围的约束"></a>检查数据的值/长度/范围的约束</h3><table>
<thead>
<tr>
<th>约束</th>
<th>行内</th>
<th>Constraint类</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>length(length)</td>
<td><code>&#123;id:length(12)&#125;</code></td>
<td><code>LengthRouteConstraint</code></td>
<td>字符串长度限制</td>
</tr>
<tr>
<td>maxlength(value)</td>
<td><code>&#123;id:maxlength(8)&#125;</code></td>
<td><code>MaxLengthRouteConstraint</code></td>
<td>字符串最大长度限制</td>
</tr>
<tr>
<td>minlength(value)</td>
<td><code>&#123;id:minlength(4)&#125;</code></td>
<td><code>MinLengthRouteConstraint</code></td>
<td>字符串最小长度限制</td>
</tr>
<tr>
<td>range(min,max)</td>
<td><code>&#123;id:range(18,120)&#125;</code></td>
<td><code>RangeRouteConstraint</code></td>
<td>数值范围限制</td>
</tr>
<tr>
<td>min(value)</td>
<td><code>&#123;id:min(18)&#125;</code></td>
<td><code>MinRouteConstraint</code></td>
<td>最小数值限制</td>
</tr>
<tr>
<td>max(value)</td>
<td><code>&#123;id:max(120)&#125;</code></td>
<td><code>MaxRouteConstraint</code></td>
<td>最大数值限制</td>
</tr>
</tbody></table>
<h3 id="正则表达式约束"><a href="#正则表达式约束" class="headerlink" title="正则表达式约束"></a>正则表达式约束</h3><table>
<thead>
<tr>
<th>约束</th>
<th>行内</th>
<th>Constraint类</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>regex(expression)</td>
<td><code>&#123;ssn:regex(^\d&#123;&#123;3&#125;&#125;-\d&#123;&#123;2&#125;&#125;-\d&#123;&#123;4&#125;&#125;$)&#125;/</code></td>
<td><code>RegexRouteConstraint</code></td>
<td>正则表达式约束</td>
</tr>
</tbody></table>
</blockquote>
<h1 id="Java-SpringMVC-对应实现"><a href="#Java-SpringMVC-对应实现" class="headerlink" title="Java SpringMVC 对应实现"></a>Java SpringMVC 对应实现</h1><p><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-requestmapping-uri-templates">文档</a> </p>
<h2 id="URI-Patterns"><a href="#URI-Patterns" class="headerlink" title="URI Patterns"></a>URI Patterns</h2><blockquote>
<p>一些示例：</p>
<ul>
<li><code>&quot;/resources/ima?e.png&quot;</code> - match one character in a path 匹配路径段中的一个字符segment</li>
<li><code>&quot;/resources/*.png&quot;</code> - match zero or more characters in a path segment 匹配路径段中的零个或多个字符</li>
<li><code>&quot;/resources/**&quot;</code> - match multiple path segments 匹配多个路径段</li>
<li><code>&quot;/projects/&#123;project&#125;/versions&quot;</code> - match a path segment and capture it as a variable 匹配路径段并将其捕获为变量</li>
<li><code>&quot;/projects/&#123;project:[a-z]+&#125;/versions&quot;</code> - match and capture a variable with a regex 使用正则表达式匹配并捕获变量</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;name:[a-z-]+&#125;-&#123;version:\\d\\.\\d\\.\\d&#125;&#123;ext:\\.[a-z]+&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="meta">@PathVariable</span> String name, <span class="meta">@PathVariable</span> String version, <span class="meta">@PathVariable</span> String ext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java</category>
        <category>SpringMVC</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>Hystrix上下文传递</title>
    <url>/2021/10/12/2021-10-12%20Hystrix%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BC%A0%E9%80%92/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h1><p>开发中使用 ThreadLocal 来存放日志追踪码和分表等信息，但由于 Hystrix 使用了线程池 导致了 ThreadLocal 数据丢失。</p>
<h1 id="二、尝试解决"><a href="#二、尝试解决" class="headerlink" title="二、尝试解决"></a>二、尝试解决</h1><h2 id="TTL"><a href="#TTL" class="headerlink" title="TTL"></a>TTL</h2><p>TransmittableThreadLocal </p>
<h2 id="HystrixRequestContext"><a href="#HystrixRequestContext" class="headerlink" title="HystrixRequestContext"></a>HystrixRequestContext</h2><p>忘了啥问题了 好像是存储时会出错 如果要使用得替换很多东西</p>
<h2 id="HystrixConcurrencyStrategy-amp-HystrixCommandExecutionHook"><a href="#HystrixConcurrencyStrategy-amp-HystrixCommandExecutionHook" class="headerlink" title="HystrixConcurrencyStrategy&amp;HystrixCommandExecutionHook"></a>HystrixConcurrencyStrategy&amp;HystrixCommandExecutionHook</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HystrixPlugins.getInstance().registerConcurrencyStrategy(<span class="keyword">new</span> RequestContextHystrixConcurrencyStrategy());</span><br><span class="line"></span><br><span class="line">报错:Caused by: java.lang.IllegalStateException: Another strategy was already registered.</span><br></pre></td></tr></table></figure>



<h2 id="包名类名覆盖"><a href="#包名类名覆盖" class="headerlink" title="包名类名覆盖"></a>包名类名覆盖</h2><p>实现一个 HystrixCommand</p>
<p>覆盖 feign.hystrix.HystrixInvocationHandler 使用自己实现的 HystrixCommand 进行回调</p>
<p>本地测试通过线上失败</p>
<p>原因是 Hystrix 上下文传递的逻辑 我提取到一个单独的Maven项目中</p>
<p>发布到线上变成 jar包时 所有引用 第三方jar和自己的公用 jar 处于 项目中的 lib 目录</p>
<p>lib 目录中的加载时 由于依赖 Hystrix 官方包 先加载了 官方包 重复加载的class会被忽略，只有第一个生效</p>
<p>导致线上始终无法生效</p>
<p>本地 自己的公用包 应该是加载到 class 目录下 </p>
<p>class目录优先级更高 所以覆盖成功 </p>
<p>Java的包名覆盖机制受太多外部条件影响 最终还是放弃了</p>
<blockquote>
<ul>
<li>同一个ClassLoader实例加载的类不能重复（不同的class文件，同样的类名也是重复），如果强行用同一个ClassLoader实例加载同一个类，则会报错<code>attempted duplicate class definition for &#123;your class&#125;</code></li>
<li><code>java -classpath(-cp)</code>加载配置jar包（classes）时，会按照书写定义顺序加载class，之后重复加载的class会被忽略，只有第一个生效</li>
<li>Idea中可以通过在Project Settings -&gt; Modules -&gt; Dependencies中通过上下箭头调整jar加载顺序，其实也就是调整<code>-classpath(-cp)</code>后的jar包书写顺序</li>
<li>Tomcat下的jar包貌似不同版本加载策略不同</li>
<li>spring-boot是自定义的jar包加载策略，顺序未确认，猜测默认是按字母排序</li>
</ul>
</blockquote>
<h2 id="5-SPI"><a href="#5-SPI" class="headerlink" title="5.SPI"></a>5.SPI</h2><p>扩展 HystrixConcurrencyStrategy 后不用 registerConcurrencyStrategy 注册</p>
<p>而是在工程的classpath下引入hystrix-plugins.properties配置文件</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">hystrix.plugin.HystrixConcurrencyStrategy.implementation</span>=<span class="string">com.xx.xx.xx.xxxStrategy</span></span><br></pre></td></tr></table></figure>



<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>前后用了N种方式 最终还是用 SPI 的方式实现了想要的效果…</p>
<p><strong>具体实现参照之前的 <a href="/2021/03/31/2021-03-31%E5%88%86%E5%B8%83%E5%BC%8F%20%E6%97%A5%E5%BF%97%E8%BF%BD%E8%B8%AA%20%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/">日志链路追踪</a></strong></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SpringCloud</tag>
        <tag>Hystrix</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring参数绑定 适应多种提交方式</title>
    <url>/2021/11/03/2021-11-03%20Spring%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9A/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h1><p>开发接口时经常会出现</p>
<p>有的接口一堆参数 得定义 Bean 用 @RequestBody 接收</p>
<p>有的又只有一两个 参数 用 @RequestParam 接收</p>
<p>快速迭代时修改接口导致 前端请求 ContentType 也要跟着改变</p>
<p>前端每次都要纠结参数放 param 还是放 body </p>
<p>就产生了 修改下参数绑定逻辑的想法</p>
<h1 id="二、修改参数绑定"><a href="#二、修改参数绑定" class="headerlink" title="二、修改参数绑定"></a>二、修改参数绑定</h1><p>Spring 会从 request 中获取</p>
<p>parameterMap 和 body</p>
<p>formData 是放 parameterMap 中 表现为 key-values</p>
<p>x-www 是放在 body中 表现为 key=value&amp;key=value</p>
<p>json 是放在 body 中 表现为 {key:value}</p>
<p>凭印象写的 具体得用 postMan 实测下</p>
<p>因为 post 和 get 会有区别</p>
<p>默认 get 没有 content-type 但 postMan 也能传递 x-www</p>
<p>首先 通过过滤器替换 request</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.lqs1848.framework.enums.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.lqs1848.framework.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.lqs1848.framework.web.wrapper.ContentCachingRequestWrapper;</span><br><span class="line"><span class="keyword">import</span> org.lqs1848.framework.web.wrapper.CryptoHttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.lqs1848.framework.web.wrapper.ResponseWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> eu.bitwalker.useragentutils.Browser;</span><br><span class="line"><span class="keyword">import</span> eu.bitwalker.useragentutils.OperatingSystem;</span><br><span class="line"><span class="keyword">import</span> eu.bitwalker.useragentutils.UserAgent;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceFilter</span> <span class="keyword">extends</span> <span class="title">ActionFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">filter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">		Long startTime = System.nanoTime();</span><br><span class="line">		</span><br><span class="line">		String contentType = request.getContentType();</span><br><span class="line">		log.info(<span class="string">&quot;QueryStart_Url(&quot;</span> + request.getRequestURI() + <span class="string">&quot;)_Method(&quot;</span>+request.getMethod()+<span class="string">&quot;)_Type(&quot;</span>+getContentType(contentType)+<span class="string">&quot;)_Ip(&quot;</span>+getIpAddress(request)+<span class="string">&quot;)&quot;</span>+getDevInfo(request.getHeader(HttpHeaders.USER_AGENT)));</span><br><span class="line">		ContentCachingRequestWrapper requestWrapper = <span class="keyword">new</span> ContentCachingRequestWrapper(request);</span><br><span class="line">		log.info(<span class="string">&quot;QueryString:&quot;</span> + requestWrapper.getQueryString());</span><br><span class="line">		log.info(<span class="string">&quot;QueryParameter:&quot;</span> + (requestWrapper.getParameterMap().size() !=<span class="number">0</span> ? JSON.toJSONString(requestWrapper.getParameterMap()):<span class="string">&quot;&quot;</span>));</span><br><span class="line">		<span class="keyword">if</span> (requestWrapper.hasFile() &amp;&amp; requestWrapper.getBodySize() != <span class="number">0</span>) &#123;</span><br><span class="line">			log.info(<span class="string">&quot;QueryBody: 内容是个文件&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			String queryBody = requestWrapper.getQueryBody();</span><br><span class="line">			log.info(<span class="string">&quot;QueryBody:&quot;</span> + queryBody.replaceAll(<span class="string">&quot;\\s+&quot;</span>, <span class="string">&quot; &quot;</span>));</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//支持 前端用 get 但是数据传递在body中</span></span><br><span class="line">			<span class="keyword">if</span>(HttpMethod.GET.matches(request.getMethod()) &amp;&amp; requestWrapper.getBodySize() != <span class="number">0</span>) &#123;</span><br><span class="line">				queryBody = URLDecoder.decode(queryBody, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(queryBody != <span class="keyword">null</span> &amp;&amp; queryBody.length() &gt; <span class="number">3</span> &amp;&amp; queryBody.length() &lt; <span class="number">999</span>) &#123;</span><br><span class="line">				<span class="comment">//支持 前端用 JSON 时 后端用 @RequestParam 接收参数</span></span><br><span class="line">				<span class="keyword">if</span>(contentType == <span class="keyword">null</span> || contentType.startsWith(MediaType.APPLICATION_JSON_VALUE)) &#123;</span><br><span class="line">					<span class="comment">//对简单的 RquestBody JSON 数据  放入 RequestParam 封装</span></span><br><span class="line">					JSONObject json = JSONObject.parseObject(queryBody);</span><br><span class="line">					<span class="keyword">for</span>(String key : json.keySet()) &#123;</span><br><span class="line">						String value = json.getString(key);</span><br><span class="line">						<span class="keyword">if</span>(StringUtils.isNotEmpty(value) &amp;&amp; !value.startsWith(<span class="string">&quot;&#123;&quot;</span>) &amp;&amp; !value.startsWith(<span class="string">&quot;[&quot;</span>))</span><br><span class="line">							requestWrapper.put(key, value);</span><br><span class="line">					&#125;<span class="comment">//for</span></span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//支持 前端用 x-www 后端用 参数 或者 JavaBean 接收</span></span><br><span class="line">				<span class="keyword">if</span>(contentType == <span class="keyword">null</span> || contentType.startsWith(MediaType.APPLICATION_FORM_URLENCODED_VALUE)) &#123;</span><br><span class="line">					String[] params = queryBody.split(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">					<span class="keyword">for</span>(String param : params) &#123;</span><br><span class="line">						String[] par = param.split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">						<span class="keyword">if</span>(par.length != <span class="number">2</span>) <span class="keyword">break</span>;</span><br><span class="line">						requestWrapper.put(par[<span class="number">0</span>], par[<span class="number">1</span>]);</span><br><span class="line">					&#125;<span class="comment">//for</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="comment">//if</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">//支持 前端用 x-www 或 form-data 时 后端用 JavaBean 接收</span></span><br><span class="line">			<span class="keyword">if</span>((requestWrapper.getBodySize() == <span class="number">0</span> || HttpMethod.GET.matches(request.getMethod())) &amp;&amp; </span><br><span class="line">					(contentType == <span class="keyword">null</span> || contentType.startsWith(MediaType.APPLICATION_FORM_URLENCODED_VALUE) </span><br><span class="line">							|| contentType.startsWith(MediaType.MULTIPART_FORM_DATA_VALUE))) &#123;</span><br><span class="line">				Map&lt;String,String&gt; map = requestWrapper.getParameterMapEx();</span><br><span class="line">				<span class="keyword">if</span>(!map.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">//这里主要是支持 单个参数里面有嵌套 json 意义不大</span></span><br><span class="line">					String mapJson = JSON.toJSONString(map)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\&quot;\\&#123;&quot;</span>,<span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\\&#125;\&quot;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\&quot;\\[&quot;</span>,<span class="string">&quot;[&quot;</span>)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\\]\&quot;&quot;</span>, <span class="string">&quot;]&quot;</span>)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\\\\\&quot;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">					requestWrapper.rewriteBody(mapJson);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="comment">//else</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//劫持返回信息</span></span><br><span class="line">		<span class="keyword">boolean</span> isMeHook = <span class="keyword">false</span>;</span><br><span class="line">		ResponseWrapper proxyResponse;</span><br><span class="line">		<span class="keyword">if</span> (response <span class="keyword">instanceof</span> ResponseWrapper)</span><br><span class="line">			proxyResponse = (ResponseWrapper) response;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			proxyResponse = <span class="keyword">new</span> ResponseWrapper(response);</span><br><span class="line">			isMeHook = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		chain.doFilter(requestWrapper, proxyResponse);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(response != <span class="keyword">null</span> &amp;&amp; (response.getContentType() == <span class="keyword">null</span> || response.getContentType().startsWith(MediaType.APPLICATION_JSON_VALUE)))</span><br><span class="line">			log.info(<span class="string">&quot;ResponseBody Secret(&#123;&#125;) Detail(&#123;&#125;)&quot;</span>, response <span class="keyword">instanceof</span> CryptoHttpServletResponse, <span class="keyword">new</span> String(proxyResponse.getContent()));</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			log.info(<span class="string">&quot;ResponseBody Detail(&#123;&#125;)&quot;</span>, <span class="string">&quot;内容未知 type:&quot;</span> + response.getContentType());</span><br><span class="line">		</span><br><span class="line">		Long elapsedTime = DateUtil.nanosToMillis(DateUtil.spendNt(startTime));</span><br><span class="line">		log.info(<span class="string">&quot;QueryEnd-Url:&quot;</span> + request.getRequestURI() + <span class="string">&quot; elapsedTime(&quot;</span> + elapsedTime + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(isMeHook)</span><br><span class="line">			proxyResponse.finish();</span><br><span class="line">	&#125;<span class="comment">// method</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getContentType</span><span class="params">(String contentType)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.isEmpty(contentType))</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;NONE&quot;</span>;</span><br><span class="line">		<span class="keyword">if</span>(contentType.indexOf(<span class="string">&quot;;&quot;</span>) != -<span class="number">1</span>) </span><br><span class="line">			contentType = contentType.split(<span class="string">&quot;;&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">if</span>(contentType.indexOf(<span class="string">&quot;/&quot;</span>) != -<span class="number">1</span>)</span><br><span class="line">			contentType = contentType.split(<span class="string">&quot;/&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">return</span> contentType;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDevInfo</span><span class="params">(String agent)</span> </span>&#123;</span><br><span class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		<span class="comment">//解析agent字符串</span></span><br><span class="line">		UserAgent userAgent = UserAgent.parseUserAgentString(agent);</span><br><span class="line">		<span class="comment">//获取浏览器对象</span></span><br><span class="line">		Browser browser = userAgent.getBrowser();</span><br><span class="line">		<span class="comment">//获取操作系统对象</span></span><br><span class="line">		OperatingSystem operatingSystem = userAgent.getOperatingSystem();</span><br><span class="line">		sb.append(<span class="string">&quot;_DevType(&quot;</span>).append(operatingSystem.getDeviceType()).append(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">		.append(<span class="string">&quot;_Browser(&quot;</span>).append(browser.getName()).append(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">		.append(<span class="string">&quot;_Os(&quot;</span>).append(operatingSystem.getName()).append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> sb.toString();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getIpAddress</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		String ip = request.getHeader(<span class="string">&quot;x-forwarded-for&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (ip != <span class="keyword">null</span> &amp;&amp; ip.length() != <span class="number">0</span> &amp;&amp; !<span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">			<span class="comment">// 多次反向代理后会有多个ip值，第一个ip才是真实ip</span></span><br><span class="line">			<span class="keyword">if</span> (ip.indexOf(<span class="string">&quot;,&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">				ip = ip.split(<span class="string">&quot;,&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">			ip = request.getHeader(<span class="string">&quot;Proxy-Client-IP&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">			ip = request.getHeader(<span class="string">&quot;WL-Proxy-Client-IP&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">			ip = request.getHeader(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">			ip = request.getHeader(<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">			ip = request.getHeader(<span class="string">&quot;X-Real-IP&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">			ip = request.getRemoteAddr();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ip;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="comment">// class</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.servlet.ServletFileUpload;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentCachingRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String[]&gt; parameterMap;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> BufferedReader reader;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ServletInputStream inputStream;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> StringBuffer queryStringSb;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> hasFile;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isRewriteBody = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ContentCachingRequestWrapper</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(request);</span><br><span class="line">		parameterMap = <span class="keyword">new</span> HashMap&lt;String, String[]&gt;(request.getParameterMap());</span><br><span class="line">		queryStringSb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">super</span>.getQueryString() != <span class="keyword">null</span>) queryStringSb.append(<span class="keyword">super</span>.getQueryString());</span><br><span class="line">		loadBody(request);</span><br><span class="line">		hasFile = ServletFileUpload.isMultipartContent(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">put</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!parameterMap.containsKey(key)) &#123;</span><br><span class="line">			parameterMap.put(key, <span class="keyword">new</span> String[] &#123; value &#125;);</span><br><span class="line">			<span class="keyword">if</span> (queryStringSb.length() &gt; <span class="number">0</span>)</span><br><span class="line">				queryStringSb.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">			queryStringSb.append(key).append(<span class="string">&quot;=&quot;</span>).append(value);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getParameterMapEx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (String key : parameterMap.keySet()) &#123;</span><br><span class="line">			map.put(key, <span class="keyword">this</span>.getParameter(key));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> map;</span><br><span class="line">	&#125;<span class="comment">//method getParameterMapEx</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rewriteBody</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.body = input.getBytes(Charset.defaultCharset());</span><br><span class="line">		<span class="keyword">this</span>.inputStream = <span class="keyword">new</span> RequestCachingInputStream(<span class="keyword">this</span>.body);</span><br><span class="line">		<span class="keyword">this</span>.isRewriteBody = <span class="keyword">true</span>;</span><br><span class="line">	&#125;<span class="comment">//method rewriteBody</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRewiteBody</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.isRewriteBody;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadBody</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.body = IOUtils.toByteArray(request.getInputStream());</span><br><span class="line">		<span class="keyword">this</span>.inputStream = <span class="keyword">new</span> RequestCachingInputStream(body);</span><br><span class="line">	&#125;<span class="comment">//method loadBody</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">byte</span>[] getBody() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.body;</span><br><span class="line">	&#125;<span class="comment">//method getBody</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBodySize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.body.length;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getContentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.getContentType();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.hasFile;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getQueryString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.queryStringSb.toString();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Map&lt;String, String[]&gt; getParameterMap() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.parameterMap;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		String[] values = <span class="keyword">this</span>.parameterMap.get(name);</span><br><span class="line">		<span class="keyword">return</span> values != <span class="keyword">null</span> ? values[<span class="number">0</span>] : <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String[] getParameterValues(String name) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.parameterMap.get(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getParameterNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Collections.enumeration(parameterMap.keySet());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//必须重写 不然原生request getInputStream 只能调用一次</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.inputStream;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.getInputStream();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (reader == <span class="keyword">null</span>) &#123;</span><br><span class="line">			reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream, getCharacterEncoding()));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> reader;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getQueryBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> IOUtils.toString(getBody(), getCharacterEncoding());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="comment">//class </span></span><br></pre></td></tr></table></figure>

<p>一开始只覆盖了 getParameterMap() 以为就能让 Spring 读取到 Paramter</p>
<p>结果 Spring 是通过 getParameterNames() 获得 key 再去匹配 Controller 的参数名</p>
<p>反正 ServletRequest 中的方法最好全部都覆盖掉</p>
<p>到这里只是支持 body 中的数据放到  param  中</p>
<p>如果Controller 用 bean 去接收参数 还是有可能获取不到</p>
<p>用自定义 参数解析器去接收</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.support.WebDataBinderFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.NativeWebRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.ModelAndViewContainer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.lqs1848.framework.web.wrapper.ContentCachingRequestWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiyHandlerResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//是项目中的 JavaBean 才进行注入</span></span><br><span class="line">		<span class="keyword">return</span> parameter.getParameterType().getPackageName().startsWith(<span class="string">&quot;org.lqs1848&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer container,</span></span></span><br><span class="line"><span class="function"><span class="params">			NativeWebRequest nativeWebRequest, WebDataBinderFactory factory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		ContentCachingRequestWrapper request = nativeWebRequest.getNativeRequest(ContentCachingRequestWrapper.class);</span><br><span class="line">		</span><br><span class="line">		String contentType = request.getHeader(HttpHeaders.CONTENT_TYPE);</span><br><span class="line">		<span class="keyword">if</span>(request.getBodySize() &gt; <span class="number">0</span> &amp;&amp; (request.isRewiteBody() || contentType == <span class="keyword">null</span> || contentType.startsWith(MediaType.APPLICATION_JSON_VALUE))) &#123;</span><br><span class="line">			String queryBody = request.getQueryBody();</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">//支持多个对象嵌套</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">	                controller(JavaBeanA a,JavaBeanB b)</span></span><br><span class="line"><span class="comment">	                json&#123;</span></span><br><span class="line"><span class="comment">	                	a:&#123;</span></span><br><span class="line"><span class="comment">	                		xxx:xxx</span></span><br><span class="line"><span class="comment">	                	&#125;,</span></span><br><span class="line"><span class="comment">	                	b:&#123;...&#125;</span></span><br><span class="line"><span class="comment">	                &#125;</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">				<span class="keyword">if</span>(queryBody.indexOf(<span class="string">&quot;\&quot;&quot;</span> + parameter.getParameterName() + <span class="string">&quot;\&quot;&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> JSONObject.parseObject(queryBody).getObject(parameter.getParameterName(), parameter.getParameterType());</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">//单个对象</span></span><br><span class="line">					<span class="keyword">return</span> JSONObject.parseObject(queryBody,parameter.getParameterType());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				log.error(<span class="string">&quot;参数注入增强-JSON转换失败&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="comment">//if</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;<span class="comment">//method</span></span><br><span class="line">&#125;<span class="comment">//class</span></span><br></pre></td></tr></table></figure>





<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>懒得重复写了 搬一下自己写在项目的中的说明</p>
<blockquote>
<p>Controller 中可以以任何方式接收前端传递的 QueryBody 参数<br>封装了 ContentType JSON 自动转换为 x-www 和 fromData 的逻辑</p>
<p>比如<br>public R Test(Entity e)//不需要写 @RequestBody 注解<br>public R Test(String param1,String param2)//放在 body 的可以自动拆成参数名 不需要额外定义一个 vo<br>public R Test(Entity1 e1,Entity2 e2)//可以同时接收多个数据<br>前端需要传递<br>{<br>    e1:{<br>        …<br>    },<br>    e2:{<br>        …<br>    }<br>}</p>
<p>甚至前端用 get请求 但是发送了x-www 的content-type 并把数据放在 requestBody 中 并以 xxx1=xxx1&amp;xxx2=xx2 的形式传输<br>后台使用<br>JavaBean 也可以接收</p>
</blockquote>
<p>写完代码</p>
<p>突然有点迷惑 为什么 Spring 没有去实现类似的逻辑呢</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>RequestBody</tag>
        <tag>RequestParam</tag>
      </tags>
  </entry>
  <entry>
    <title>PageHelper 丢失参数</title>
    <url>/2021/11/22/2021-11-22%20PageHelper%20%E4%B8%A2%E5%A4%B1%E5%8F%82%E6%95%B0/</url>
    <content><![CDATA[<span id="more"></span>

<p>PageHelper 5.2.0版本</p>
<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>一个很早以前的接口前段突然要使用</p>
<p>调用后发现无法查询到数据</p>
<p>查看日志发现</p>
<p>PageHelper 分页 Count SQL</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="number">0</span>) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> (round(<span class="number">6367000</span> <span class="operator">*</span> <span class="number">2</span> <span class="operator">*</span> <span class="built_in">asin</span>(<span class="built_in">sqrt</span>(pow(<span class="built_in">sin</span>(((m.latitude <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span> <span class="operator">-</span> (<span class="comment">/*latitude*/</span><span class="number">39</span> <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span>) <span class="operator">/</span> <span class="number">2</span>), <span class="number">2</span>) <span class="operator">+</span> <span class="built_in">cos</span>((<span class="comment">/*latitude*/</span><span class="number">39</span> <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span>) <span class="operator">*</span> <span class="built_in">cos</span>((m.latitude <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span>) <span class="operator">*</span> pow(<span class="built_in">sin</span>(((m.longitude <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span> <span class="operator">-</span> (<span class="comment">/*longitude*/</span><span class="number">39</span> <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span>) <span class="operator">/</span> <span class="number">2</span>), <span class="number">2</span>))))) <span class="keyword">AS</span> distance <span class="keyword">FROM</span> sel_mal m <span class="keyword">WHERE</span> m.status <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> m.mall_id <span class="operator">=</span> <span class="comment">/*mallId*/</span><span class="number">39</span>) table_count</span><br></pre></td></tr></table></figure>

<p>分页后进行查询的SQL</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> (round(<span class="number">6367000</span> <span class="operator">*</span> <span class="number">2</span> <span class="operator">*</span> <span class="built_in">asin</span>(<span class="built_in">sqrt</span>(pow(<span class="built_in">sin</span>(((m.latitude <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span> <span class="operator">-</span> (<span class="comment">/*latitude*/</span><span class="number">39</span> <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span>) <span class="operator">/</span> <span class="number">2</span>), <span class="number">2</span>) <span class="operator">+</span> <span class="built_in">cos</span>((<span class="comment">/*latitude*/</span><span class="number">39</span> <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span>) <span class="operator">*</span> <span class="built_in">cos</span>((m.latitude <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span>) <span class="operator">*</span> pow(<span class="built_in">sin</span>(((m.longitude <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span> <span class="operator">-</span> (<span class="comment">/*longitude*/</span><span class="keyword">null</span> <span class="operator">*</span> pi()) <span class="operator">/</span> <span class="number">180</span>) <span class="operator">/</span> <span class="number">2</span>), <span class="number">2</span>))))) <span class="keyword">AS</span> distance <span class="keyword">from</span> sel_mal m <span class="keyword">where</span> m.status<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> m.mall_id <span class="operator">=</span> <span class="comment">/*mallId*/</span><span class="keyword">null</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> distance <span class="keyword">ASC</span> LIMIT <span class="comment">/*Second_PageHelper*/</span><span class="number">30</span> </span><br></pre></td></tr></table></figure>



<p>PageHelper 在判断是否需要分页时的 SQL 还有 mallId 这个参数 </p>
<p>但是到了 实际分页的 SQL 时 mallId 这个参数就丢失了</p>
<p>原始XML</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">select (round(6367000 * 2 * asin(sqrt(pow(sin(((m.latitude * pi()) / 180 - (#&#123;latitude&#125; * pi()) / 180) / 2), 2) + cos((#&#123;latitude&#125; * pi()) / 180) * cos((m.latitude * pi()) / 180)</span><br><span class="line">		* pow(sin(((m.longitude * pi()) / 180 - (#&#123;longitude&#125; * pi()) / 180) / 2), 2))))) AS distance</span><br><span class="line">		<span class="keyword">from</span> sel_mal m</span><br><span class="line">		<span class="keyword">where</span></span><br><span class="line">			m.status<span class="operator">=</span><span class="number">1</span></span><br><span class="line">			and m.mall_id = #&#123;mallId&#125;</span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> distance <span class="keyword">ASC</span></span><br></pre></td></tr></table></figure>



<p>请求参数在分页时还存在</p>
<p>分页后却消失了 变成 null 导致查询不到数据</p>
<p>断点调试 PageHelper </p>
<p>根据 PageInterceptor 源码</p>
<p>Count 时 没有修改 parameter 变量</p>
<p>因为 入参没有变动 所以 PageHelper 使用了原始的 parameter 进行查询 查询结果就没有任何问题</p>
<p>而 PageHelper  进行分页时</p>
<p>增加了 /<em>Second_PageHelper</em>/30  参数</p>
<p>我原方法 是 </p>
<p>SelMalPo selectByMall(Long mallId);</p>
<p>单个参数的方法</p>
<p>PageHelper  对请求参数进行修改</p>
<p>变更为 paramMap HashMap 用于传递自身所需要的 limit size</p>
<p>在 AbstractHelperDialect 114行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">//下面这段方法，主要解决一个常见类型的参数时的问题</span></span><br><span class="line"><span class="keyword">if</span> (boundSql.getParameterMappings() != <span class="keyword">null</span> &amp;&amp; boundSql.getParameterMappings().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (ParameterMapping parameterMapping : boundSql.getParameterMappings()) &#123;</span><br><span class="line">        String name = parameterMapping.getProperty();</span><br><span class="line">        <span class="keyword">if</span> (!name.equals(PAGEPARAMETER_FIRST)</span><br><span class="line">            &amp;&amp; !name.equals(PAGEPARAMETER_SECOND)</span><br><span class="line">            &amp;&amp; paramMap.get(name) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasTypeHandler</span><br><span class="line">                || parameterMapping.getJavaType().equals(parameterObject.getClass())) &#123;</span><br><span class="line">                paramMap.put(name, parameterObject);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>注入参数时</p>
<p>由于我的SQL比较特殊 </p>
<p>里面有3个  #{latitude} 1个 #{mallId}</p>
<p>PageHelper  根据 参数类型 Long 匹配后 将  latitude = 39   而 mallId 这个变量没有赋值</p>
<p>导致了以上问题</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个问题是由于特殊情况产生的</p>
<p>SQL 中有多个需要传递的参数</p>
<p>但方法个只声明了一个参数</p>
<p>导致 PageHelper  判断错误</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Mybatis</tag>
        <tag>PageHelper</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle 11g 数组下标越界</title>
    <url>/2021/11/26/2021-11-26%20oracle%2011g%20%E6%95%B0%E7%BB%84%E4%B8%8B%E8%A1%A8%E8%B6%8A%E7%95%8C/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>SQL 查询 时携带了超过8个参数以后 一直提示下标越界</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>我用的 Oracle11g JDBC 驱动是网上随便下的 oracle 11.1.0.7.0-Produc tion 的 ojdbc6.jar 自己丢到本地Maven上</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//oracle.jdbc.driver.OracleSql 第579行</span></span><br><span class="line"><span class="keyword">case</span> <span class="number">13</span>: &#123;</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.parameterList == OracleSql.EMPTY_LIST) &#123;</span><br><span class="line">            <span class="keyword">this</span>.parameterList = <span class="keyword">new</span> String[<span class="number">8</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.parameterList.length &lt;= <span class="keyword">this</span>.parameterCount) &#123;</span><br><span class="line">            <span class="keyword">final</span> String[] parameterList = <span class="keyword">new</span> String[<span class="keyword">this</span>.parameterList.length * <span class="number">4</span>];</span><br><span class="line">            System.arraycopy(<span class="keyword">this</span>.parameterList, <span class="number">0</span>, parameterList, <span class="number">0</span>, <span class="keyword">this</span>.parameterList.length);</span><br><span class="line">            <span class="keyword">this</span>.parameterList = parameterList;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.parameterList[<span class="keyword">this</span>.parameterCount] = <span class="keyword">new</span> String(<span class="keyword">this</span>.currentParameter, <span class="number">0</span>, count).intern();</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        ++<span class="keyword">this</span>.parameterCount;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更换为Maven 仓库中的最新版</p>
<blockquote>
<dependency>
    <groupId>com.oracle.database.jdbc</groupId>
    <artifactId>ojdbc6</artifactId>
    <version>11.2.0.4</version>
</dependency>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//oracle.jdbc.driver.OracleSql 第633行</span></span><br><span class="line"><span class="keyword">case</span> <span class="number">16</span>: &#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.parameterList == OracleSql.EMPTY_LIST) &#123;</span><br><span class="line">        <span class="keyword">this</span>.parameterList = <span class="keyword">new</span> String[Math.max(<span class="number">8</span>, <span class="keyword">this</span>.parameterCount * <span class="number">4</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.parameterList.length &lt;= <span class="keyword">this</span>.parameterCount) &#123;</span><br><span class="line">        <span class="keyword">final</span> String[] parameterList = <span class="keyword">new</span> String[<span class="keyword">this</span>.parameterList.length * <span class="number">4</span>];</span><br><span class="line">        System.arraycopy(<span class="keyword">this</span>.parameterList, <span class="number">0</span>, parameterList, <span class="number">0</span>, <span class="keyword">this</span>.parameterList.length);</span><br><span class="line">        <span class="keyword">this</span>.parameterList = parameterList;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.parameterList[<span class="keyword">this</span>.parameterCount] = <span class="keyword">new</span> String(<span class="keyword">this</span>.currentParameter, <span class="number">0</span>, count).intern();</span><br><span class="line">    count = <span class="number">0</span>;</span><br><span class="line">    ++<span class="keyword">this</span>.parameterCount;</span><br><span class="line">    <span class="keyword">if</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">        ++<span class="keyword">this</span>.returningIntoParameterCount;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//旧版</span></span><br><span class="line"><span class="keyword">this</span>.parameterList = <span class="keyword">new</span> String[<span class="number">8</span>];</span><br><span class="line"><span class="comment">//新版</span></span><br><span class="line"><span class="keyword">this</span>.parameterList = <span class="keyword">new</span> String[Math.max(<span class="number">8</span>, <span class="keyword">this</span>.parameterCount * <span class="number">4</span>)];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Oracle Jdbc 驱动竟然还会有这么明显的BUG… emm</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>驱动老老实实用最新的</p>
]]></content>
      <categories>
        <category>DateBase</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Oracle 11g</tag>
      </tags>
  </entry>
  <entry>
    <title>Seata NullPointerException</title>
    <url>/2021/12/16/2021-12-16%20%20Seata%20NullPointerException/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">17:29:59.697 [Gateway.89c2f32d] [DubboServerHandler-172.17.0.1:20881-thread-199] INFO </span><br><span class="line">				com.mysd.common.dubbo.filter.DubboProviderFilter -</span><br><span class="line">				DubboProvider Start(insertByPurOrder)</span><br><span class="line">17:29:59.704 [Gateway.89c2f32d] [DubboServerHandler-172.17.0.1:20881-thread-199] INFO </span><br><span class="line">				com.mysd.common.MysdApplication -</span><br><span class="line">				QueryCount(1) SqlTime(1) SqlStr(SELECT a.scaling_factor , a.purchase_price , b.material_name, b.material_specification, a.barcode , a.auxiliary_unit, b.is_need_sncode FROM pub_material_detail_71 a left join pub_material_71 b on a.material_id &#x3D; b.material_id WHERE a.md_id &#x3D; &#x2F;*mdId*&#x2F;34 AND a.material_id &#x3D; &#x2F;*materialId*&#x2F;23 AND a.group_id &#x3D; &#x2F;*groupId*&#x2F;71 AND a.platform_id &#x3D;&#x2F;*platformId*&#x2F;71)</span><br><span class="line">17:29:59.712 [Gateway.89c2f32d] [DubboServerHandler-172.17.0.1:20881-thread-199] INFO </span><br><span class="line">				com.mysd.common.MysdApplication -</span><br><span class="line">				SqlResult(1) SqlTime(6) SqlStr(INSERT INTO rep_order_material_71 ( order_num, material_id, md_id, material_warehouse, auxiliary_quantity, scattered_quantity, material_quantity, unit_price, discount_price, total_amount, gift_flag, order_type, platform_id, group_id, create_by, material_name, material_specification, auxiliary_unit, create_time ) VALUES ( &#x2F;*orderNum*&#x2F;&#39;37&#39;, &#x2F;*materialId*&#x2F;23, &#x2F;*mdId*&#x2F;34, &#x2F;*materialWarehouse*&#x2F;1, &#x2F;*auxiliaryQuantity*&#x2F;200, &#x2F;*scatteredQuantity*&#x2F;0, &#x2F;*materialQuantity*&#x2F;1200, &#x2F;*unitPrice*&#x2F;1000, &#x2F;*discountPrice*&#x2F;1000, &#x2F;*totalAmount*&#x2F;200000.00, &#x2F;*giftFlag*&#x2F;&#39;0&#39;, &#x2F;*orderType*&#x2F;&#39;201&#39;, &#x2F;*platformId*&#x2F;71, &#x2F;*groupId*&#x2F;71, &#x2F;*createBy*&#x2F;&#39;admin&#39;, &#x2F;*materialName*&#x2F;&#39;魔鬼梅洛红葡萄酒&#39;, &#x2F;*materialSpecification*&#x2F;&#39;500ml&#39;, &#x2F;*auxiliaryUnit*&#x2F;&#39;件&#39;, sysdate() ))</span><br><span class="line">17:29:59.714 [Gateway.89c2f32d] [DubboServerHandler-172.17.0.1:20881-thread-199] ERROR</span><br><span class="line">				com.mysd.common.dubbo.filter.DubboExceptionFilter -</span><br><span class="line">				Dubbo 出现错误!</span><br><span class="line">org.springframework.jdbc.UncategorizedSQLException: </span><br><span class="line">### Error updating database.  Cause: java.sql.SQLException: java.lang.NullPointerException</span><br><span class="line">### The error may involve com.mysd.stock.storage.mapper.RepOrderMaterialMapper.insertOrderMaterial-Inline</span><br><span class="line">### The error occurred while setting parameters</span><br><span class="line">### SQL: INSERT INTO rep_order_material_71 ( order_num, material_id, md_id, material_warehouse, auxiliary_quantity, scattered_quantity, material_quantity, unit_price, discount_price, total_amount, gift_flag, order_type, platform_id, group_id, create_by, material_name, material_specification, auxiliary_unit, create_time ) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, sysdate() )</span><br><span class="line">### Cause: java.sql.SQLException: java.lang.NullPointerException</span><br><span class="line">; uncategorized SQLException; SQL state [null]; error code [0]; java.lang.NullPointerException; nested exception is java.sql.SQLException: java.lang.NullPointerException</span><br><span class="line">	at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:89)</span><br><span class="line">	at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:81)</span><br><span class="line">	at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:81)</span><br><span class="line">	at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:73)</span><br><span class="line">	at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:446)</span><br><span class="line">	at com.sun.proxy.$Proxy171.insert(Unknown Source)</span><br><span class="line">	at org.mybatis.spring.SqlSessionTemplate.insert(SqlSessionTemplate.java:278)</span><br><span class="line">	at org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:58)</span><br><span class="line">	at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:59)</span><br><span class="line">	at com.sun.proxy.$Proxy184.insertOrderMaterial(Unknown Source)</span><br><span class="line">	at com.mysd.stock.storage.service.RepOrderMaterialServiceImpl.insertOrderMaterialList(RepOrderMaterialServiceImpl.java:1947)</span><br><span class="line">	at com.mysd.stock.storage.service.RepOrderMaterialServiceImpl.insertByPurOrder(RepOrderMaterialServiceImpl.java:951)</span><br><span class="line">	at com.mysd.stock.storage.service.RepOrderMaterialServiceImpl$$FastClassBySpringCGLIB$$66cf9a15.invoke(&lt;generated&gt;)</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:771)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:749)</span><br><span class="line">	at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed(MethodInvocationProceedingJoinPoint.java:88)</span><br><span class="line">	at com.mysd.stock.storage.aspect.ToeknAspect.around(ToeknAspect.java:39)</span><br><span class="line">	at jdk.internal.reflect.GeneratedMethodAccessor404.invoke(Unknown Source)</span><br><span class="line">	at java.base&#x2F;jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.base&#x2F;java.lang.reflect.Method.invoke(Method.java:564)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs(AbstractAspectJAdvice.java:644)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod(AbstractAspectJAdvice.java:633)</span><br><span class="line">	at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke(AspectJAroundAdvice.java:70)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:749)</span><br><span class="line">	at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:367)</span><br><span class="line">	at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:118)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:175)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:749)</span><br><span class="line">	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:95)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:749)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:691)</span><br><span class="line">	at com.mysd.stock.storage.service.RepOrderMaterialServiceImpl$$EnhancerBySpringCGLIB$$c50246e6.insertByPurOrder(&lt;generated&gt;)</span><br><span class="line">	at org.apache.dubbo.common.bytecode.Wrapper13.invokeMethod(Wrapper13.java)</span><br><span class="line">	at org.apache.dubbo.rpc.proxy.javassist.JavassistProxyFactory$1.doInvoke(JavassistProxyFactory.java:47)</span><br><span class="line">	at org.apache.dubbo.rpc.proxy.AbstractProxyInvoker.invoke(AbstractProxyInvoker.java:84)</span><br><span class="line">	at org.apache.dubbo.config.invoker.DelegateProviderMetaDataInvoker.invoke(DelegateProviderMetaDataInvoker.java:56)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.InvokerWrapper.invoke(InvokerWrapper.java:56)</span><br><span class="line">	at com.alibaba.dubbo.rpc.Invoker$CompatibleInvoker.invoke(Invoker.java:55)</span><br><span class="line">	at io.seata.integration.dubbo.alibaba.AlibabaDubboTransactionPropagationFilter.invoke(AlibabaDubboTransactionPropagationFilter.java:45)</span><br><span class="line">	at com.alibaba.dubbo.rpc.Filter.invoke(Filter.java:29)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at io.seata.integration.dubbo.ApacheDubboTransactionPropagationFilter.invoke(ApacheDubboTransactionPropagationFilter.java:69)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at com.mysd.common.dubbo.filter.DubboExceptionFilter.invoke(e:44)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at org.apache.dubbo.monitor.support.MonitorFilter.invoke(MonitorFilter.java:89)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at org.apache.dubbo.rpc.filter.TimeoutFilter.invoke(TimeoutFilter.java:46)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.dubbo.filter.TraceFilter.invoke(TraceFilter.java:77)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at com.mysd.common.dubbo.filter.DubboProviderFilter.invoke(g:145)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at org.apache.dubbo.rpc.filter.ContextFilter.invoke(ContextFilter.java:129)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at org.apache.dubbo.rpc.filter.GenericFilter.invoke(GenericFilter.java:152)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at org.apache.dubbo.rpc.filter.ClassLoaderFilter.invoke(ClassLoaderFilter.java:38)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at org.apache.dubbo.rpc.filter.EchoFilter.invoke(EchoFilter.java:41)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:83)</span><br><span class="line">	at org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol$1.reply(DubboProtocol.java:145)</span><br><span class="line">	at org.apache.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.handleRequest(HeaderExchangeHandler.java:100)</span><br><span class="line">	at org.apache.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.received(HeaderExchangeHandler.java:175)</span><br><span class="line">	at org.apache.dubbo.remoting.transport.DecodeHandler.received(DecodeHandler.java:51)</span><br><span class="line">	at org.apache.dubbo.remoting.transport.dispatcher.ChannelEventRunnable.run(ChannelEventRunnable.java:57)</span><br><span class="line">	at java.base&#x2F;java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)</span><br><span class="line">	at java.base&#x2F;java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630)</span><br><span class="line">	at java.base&#x2F;java.lang.Thread.run(Thread.java:832)</span><br><span class="line">Caused by: java.sql.SQLException: java.lang.NullPointerException</span><br><span class="line">	at io.seata.rm.datasource.exec.ExecuteTemplate.execute(ExecuteTemplate.java:115)</span><br><span class="line">	at io.seata.rm.datasource.exec.ExecuteTemplate.execute(ExecuteTemplate.java:50)</span><br><span class="line">	at io.seata.rm.datasource.PreparedStatementProxy.execute(PreparedStatementProxy.java:55)</span><br><span class="line">	at io.seata.rm.datasource.PreparedStatementProxy.lambda$execute$0(PreparedStatementProxy.java:55)</span><br><span class="line">	at io.seata.rm.datasource.exec.AbstractDMLBaseExecutor.executeAutoCommitFalse(AbstractDMLBaseExecutor.java:100)</span><br><span class="line">	at io.seata.rm.datasource.exec.AbstractDMLBaseExecutor.doExecute(AbstractDMLBaseExecutor.java:84)</span><br><span class="line">	at io.seata.rm.datasource.exec.BaseTransactionalExecutor.execute(BaseTransactionalExecutor.java:113)</span><br><span class="line">	at io.seata.rm.datasource.exec.ExecuteTemplate.execute(ExecuteTemplate.java:111)</span><br><span class="line">	at io.seata.rm.datasource.exec.ExecuteTemplate.execute(ExecuteTemplate.java:50)</span><br><span class="line">	at io.seata.rm.datasource.PreparedStatementProxy.execute(PreparedStatementProxy.java:55)</span><br><span class="line">	at jdk.internal.reflect.GeneratedMethodAccessor391.invoke(Unknown Source)</span><br><span class="line">	at java.base&#x2F;jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.base&#x2F;java.lang.reflect.Method.invoke(Method.java:564)</span><br><span class="line">	at org.apache.ibatis.logging.jdbc.PreparedStatementLogger.invoke(PreparedStatementLogger.java:59)</span><br><span class="line">	at com.sun.proxy.$Proxy243.execute(Unknown Source)</span><br><span class="line">	at org.apache.ibatis.executor.statement.PreparedStatementHandler.update(PreparedStatementHandler.java:46)</span><br><span class="line">	at org.apache.ibatis.executor.statement.RoutingStatementHandler.update(RoutingStatementHandler.java:74)</span><br><span class="line">	at jdk.internal.reflect.GeneratedMethodAccessor567.invoke(Unknown Source)</span><br><span class="line">	at java.base&#x2F;jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.base&#x2F;java.lang.reflect.Method.invoke(Method.java:564)</span><br><span class="line">	at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:63)</span><br><span class="line">	at com.sun.proxy.$Proxy241.update(Unknown Source)</span><br><span class="line">	at jdk.internal.reflect.GeneratedMethodAccessor567.invoke(Unknown Source)</span><br><span class="line">	at java.base&#x2F;jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.base&#x2F;java.lang.reflect.Method.invoke(Method.java:564)</span><br><span class="line">	at org.apache.ibatis.plugin.Invocation.proceed(Invocation.java:49)</span><br><span class="line">	at com.mysd.common.mybatis.SqlPrintInterceptor.intercept(ea:50)</span><br><span class="line">	at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:61)</span><br><span class="line">	at com.sun.proxy.$Proxy241.update(Unknown Source)</span><br><span class="line">	at org.apache.ibatis.executor.SimpleExecutor.doUpdate(SimpleExecutor.java:50)</span><br><span class="line">	at org.apache.ibatis.executor.BaseExecutor.update(BaseExecutor.java:117)</span><br><span class="line">	at org.apache.ibatis.executor.CachingExecutor.update(CachingExecutor.java:76)</span><br><span class="line">	at jdk.internal.reflect.GeneratedMethodAccessor639.invoke(Unknown Source)</span><br><span class="line">	at java.base&#x2F;jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.base&#x2F;java.lang.reflect.Method.invoke(Method.java:564)</span><br><span class="line">	at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:63)</span><br><span class="line">	at com.sun.proxy.$Proxy240.update(Unknown Source)</span><br><span class="line">	at org.apache.ibatis.session.defaults.DefaultSqlSession.update(DefaultSqlSession.java:198)</span><br><span class="line">	at org.apache.ibatis.session.defaults.DefaultSqlSession.insert(DefaultSqlSession.java:185)</span><br><span class="line">	at jdk.internal.reflect.GeneratedMethodAccessor650.invoke(Unknown Source)</span><br><span class="line">	at java.base&#x2F;jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.base&#x2F;java.lang.reflect.Method.invoke(Method.java:564)</span><br><span class="line">	at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:433)</span><br><span class="line">	... 68 common frames omitted</span><br><span class="line">Caused by: java.lang.NullPointerException: null</span><br><span class="line">	at io.seata.rm.datasource.sql.struct.TableRecords.buildRecords(TableRecords.java:195)</span><br><span class="line">	at io.seata.rm.datasource.exec.BaseTransactionalExecutor.buildTableRecords(BaseTransactionalExecutor.java:402)</span><br><span class="line">	at io.seata.rm.datasource.exec.BaseInsertExecutor.afterImage(BaseInsertExecutor.java:77)</span><br><span class="line">	at io.seata.rm.datasource.exec.AbstractDMLBaseExecutor.executeAutoCommitFalse(AbstractDMLBaseExecutor.java:101)</span><br><span class="line">	at io.seata.rm.datasource.exec.AbstractDMLBaseExecutor.doExecute(AbstractDMLBaseExecutor.java:84)</span><br><span class="line">	at io.seata.rm.datasource.exec.BaseTransactionalExecutor.execute(BaseTransactionalExecutor.java:113)</span><br><span class="line">	at io.seata.rm.datasource.exec.ExecuteTemplate.execute(ExecuteTemplate.java:111)</span><br><span class="line">	... 110 common frames omitted</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>好多次都碰到</p>
<p>明明 insert 成功 返回插入成功1行</p>
<p>但是 Seata 报错 回滚</p>
<p>还是 NullPointerException</p>
<p>还不能复现出来</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String colName = resultSetMetaData.getColumnName(i);</span><br><span class="line">ColumnMeta col = tmeta.getColumnMeta(colName);</span><br><span class="line"><span class="keyword">int</span> dataType = col.getDataType();</span><br></pre></td></tr></table></figure>

<p>数据库在使用过程中修改过表结构 添加或删除了字段 </p>
<p>Seata 的 tableMeta 没有更新 到 seata的更新时间后就没问题了</p>
<p>坑… 特别是 这些都是同事修改的数据库字段 自己没动</p>
<h1 id="再次出现"><a href="#再次出现" class="headerlink" title="再次出现"></a>再次出现</h1><p>直接写原因</p>
<p>数据库 有一列 仓库名称 列名 同事直接写成 name </p>
<p>Mybatis XML SQL 自动把 name 修改为 NAME </p>
<p>getColumnMeta(colName);  获取时是 根据列名获取</p>
<p>用 ‘NAME’ 肯定获取不到 </p>
<p>Seata 的 Map 存储的是小写 ‘name’</p>
<p>不确定项目里面还有没有其它的大小写问题</p>
<p>直接修改 Seata 源码</p>
<p>io.seata.rm.datasource.sql.struct.TableMeta</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key: column name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, ColumnMeta&gt; allColumns = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key: index name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IndexMeta&gt; allIndexes = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改为</span></span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key: column name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, ColumnMeta&gt; allColumns = <span class="keyword">new</span> LinkedCaseInsensitiveMap&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key: index name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IndexMeta&gt; allIndexes = <span class="keyword">new</span> LinkedCaseInsensitiveMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改成不区分大小写的 Map</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Seata</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring参数绑定 适应多种提交方式(二)</title>
    <url>/2022/01/24/2022-01-24%20Spring%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9A(%E4%BA%8C)/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>一点点补充之前没有考虑到的细节</p>
<h1 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h1><p>自定义参数注入 会导致 Validation 失效</p>
<p>获得到对象后 手动调用 validate(obj);</p>
<p>如下 validate方法</p>
<h1 id="List"><a href="#List" class="headerlink" title="List"></a>List</h1><p>上次写的逻辑 对简单参数做了处理</p>
<p>但是 如果前端传递的是List就无法处理了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">请求参数 JSON</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    &quot;resultCode&quot;:&quot;b&quot;,</span></span><br><span class="line"><span class="comment">    &quot;orders&quot;: [</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            &quot;sequence&quot;: &quot;4&quot;,</span></span><br><span class="line"><span class="comment">            &quot;superviseBankXh&quot;: &quot;10000222&quot;</span></span><br><span class="line"><span class="comment">        &#125;,</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            &quot;sequence&quot;: &quot;3&quot;,</span></span><br><span class="line"><span class="comment">            &quot;superviseBankXh&quot;: &quot;10000223&quot;</span></span><br><span class="line"><span class="comment">        &#125;,</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            &quot;sequence&quot;: &quot;2&quot;,</span></span><br><span class="line"><span class="comment">            &quot;superviseBankXh&quot;: &quot;10000224&quot;</span></span><br><span class="line"><span class="comment">        &#125;,</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            &quot;sequence&quot;: &quot;1&quot;,</span></span><br><span class="line"><span class="comment">            &quot;superviseBankXh&quot;: &quot;10000225&quot;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    ]</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="meta">@PostMapping(&quot;/jgzhyxjsz&quot;)</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> R <span class="title">jgzhyxjsz</span><span class="params">(List&lt;JgzhyxjszDTO&gt; orders)</span></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> R.data(merchantMngmtService.jgzhyxjsz(orders));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>后台如果不想用 @RequestBody 并且封装一个对象去接收的话</p>
<p>而是这样直接就能获取到 那就必须实现一个 List 的自定义参数转换器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerArrayResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	 <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Validator validator;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Collection.class.isAssignableFrom(parameter.getParameterType());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer container,</span></span></span><br><span class="line"><span class="function"><span class="params">			NativeWebRequest nativeWebRequest, WebDataBinderFactory factory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		ContentCachingRequestWrapper request = nativeWebRequest.getNativeRequest(ContentCachingRequestWrapper.class);</span><br><span class="line">		Object result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//获取 List&lt;?&gt; 的泛型信息</span></span><br><span class="line">		ParameterizedType genericSuperclass = (ParameterizedType) parameter.getMethod().getGenericParameterTypes()[parameter.getParameterIndex()];</span><br><span class="line">		Type type = genericSuperclass.getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">		</span><br><span class="line">		String contentType = request.getHeader(HttpHeaders.CONTENT_TYPE);</span><br><span class="line">		<span class="keyword">if</span>(request.getBodySize() &gt; <span class="number">0</span> &amp;&amp; (request.isRewiteBody() || contentType == <span class="keyword">null</span> || contentType.startsWith(MediaType.APPLICATION_JSON_VALUE))) &#123;</span><br><span class="line">			String queryBody = request.getQueryBody();</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">if</span>(queryBody.strip().startsWith(<span class="string">&quot;[&quot;</span>)) &#123;</span><br><span class="line">					result = JSONObject.parseArray(queryBody,Class.forName(type.getTypeName()));</span><br><span class="line">				&#125;<span class="comment">//支持多个对象嵌套</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(queryBody.indexOf(<span class="string">&quot;\&quot;&quot;</span> + parameter.getParameterName() + <span class="string">&quot;\&quot;&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">					String tempStr = JSONObject.parseObject(queryBody).getString(parameter.getParameterName());</span><br><span class="line">					result = JSONObject.parseArray(tempStr,Class.forName(type.getTypeName()));</span><br><span class="line">				&#125; </span><br><span class="line">			&#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				log.error(<span class="string">&quot;参数注入增强-JSON转换失败&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="comment">//if</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> validate(parameter,result);</span><br><span class="line">	&#125;<span class="comment">//method</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> Object <span class="title">validate</span><span class="params">(MethodParameter parameter,Object obj)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//无需校验</span></span><br><span class="line">		<span class="keyword">if</span>(parameter.getParameterAnnotation(Validated.class) == <span class="keyword">null</span> &amp;&amp; parameter.getParameterAnnotation(Valid.class) == <span class="keyword">null</span>) <span class="keyword">return</span> obj;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(obj == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;参数不能为null&quot;</span>, <span class="number">500</span>);</span><br><span class="line">		</span><br><span class="line">		Set&lt;ConstraintViolation&lt;Object&gt;&gt; validateResult = validator.validate(obj);</span><br><span class="line">        <span class="keyword">if</span>(validateResult.size() &gt; <span class="number">0</span>)</span><br><span class="line">        	<span class="keyword">throw</span> <span class="keyword">new</span> MysdException(validateResult.iterator().next().getPropertyPath() +<span class="string">&quot;:&quot;</span>+ validateResult.iterator().next().getMessage(), <span class="number">500</span>);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="comment">//class</span></span><br></pre></td></tr></table></figure>





<h1 id="参数没有放在QueryBody-中"><a href="#参数没有放在QueryBody-中" class="headerlink" title="参数没有放在QueryBody 中"></a>参数没有放在QueryBody 中</h1><p>之前考虑的都是 参数放到QueryBody 如果对方把请求参数写在 QueryParam中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Order(Ordered.HIGHEST_PRECEDENCE + 1)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceFilter</span> <span class="keyword">extends</span> <span class="title">ActionFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">filter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">		Long startTime = System.nanoTime();</span><br><span class="line">		</span><br><span class="line">		String contentType = request.getContentType();</span><br><span class="line">		log.info(<span class="string">&quot;QueryStart_Url(&quot;</span> + request.getRequestURI() + <span class="string">&quot;)_Method(&quot;</span>+request.getMethod()+<span class="string">&quot;)_Type(&quot;</span>+getContentType(contentType)+<span class="string">&quot;)_Ip(&quot;</span>+getIpAddress(request)+<span class="string">&quot;)&quot;</span>+getDevInfo(request.getHeader(HttpHeaders.USER_AGENT)));</span><br><span class="line">		ContentCachingRequestWrapper requestWrapper = <span class="keyword">new</span> ContentCachingRequestWrapper(request);</span><br><span class="line">		log.info(<span class="string">&quot;QueryString:&quot;</span> + requestWrapper.getQueryString());</span><br><span class="line">		log.info(<span class="string">&quot;QueryParameter:&quot;</span> + (requestWrapper.getParameterMap().size() !=<span class="number">0</span> ? JSON.toJSONString(requestWrapper.getParameterMap()):<span class="string">&quot;&quot;</span>));</span><br><span class="line">		<span class="keyword">if</span> (requestWrapper.hasFile() &amp;&amp; requestWrapper.getBodySize() != <span class="number">0</span>) &#123;</span><br><span class="line">			log.info(<span class="string">&quot;QueryBody: 内容是个文件&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			String queryBody = requestWrapper.getQueryBody();</span><br><span class="line">			String fmqb = queryBody.replaceAll(<span class="string">&quot;\\s+&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">			log.info(<span class="string">&quot;QueryBody:&quot;</span> + fmqb);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//支持 前端用 get 但是数据传递在body中</span></span><br><span class="line">			<span class="keyword">if</span>(HttpMethod.GET.matches(request.getMethod()) &amp;&amp; requestWrapper.getBodySize() != <span class="number">0</span>) &#123;</span><br><span class="line">				queryBody = URLDecoder.decode(queryBody, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(queryBody != <span class="keyword">null</span> &amp;&amp; queryBody.length() &gt; <span class="number">3</span> &amp;&amp; queryBody.length() &lt; <span class="number">999</span>) &#123;</span><br><span class="line">				<span class="comment">//支持 前端用 JSON 时 后端用 @RequestParam 接收参数</span></span><br><span class="line">				<span class="keyword">if</span>((contentType == <span class="keyword">null</span> || contentType.startsWith(MediaType.APPLICATION_JSON_VALUE)) </span><br><span class="line">						<span class="comment">//JSON 必须 没有数组</span></span><br><span class="line">						&amp;&amp; fmqb.indexOf(<span class="string">&quot;[&quot;</span>) == -<span class="number">1</span> ) &#123;</span><br><span class="line">					<span class="comment">//对简单的 RquestBody JSON 数据  放入 RequestParam 封装</span></span><br><span class="line">					JSONObject json = JSONObject.parseObject(queryBody);</span><br><span class="line">					<span class="keyword">for</span>(String key : json.keySet()) &#123;</span><br><span class="line">						String value = json.getString(key);</span><br><span class="line">						<span class="keyword">if</span>(StringUtils.isNotEmpty(value) &amp;&amp; !value.startsWith(<span class="string">&quot;&#123;&quot;</span>) &amp;&amp; !value.startsWith(<span class="string">&quot;[&quot;</span>))</span><br><span class="line">							requestWrapper.put(key, value);</span><br><span class="line">					&#125;<span class="comment">//for</span></span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">//支持 前端用 x-www 后端用 参数 或者 JavaBean 接收</span></span><br><span class="line">				<span class="keyword">if</span>(contentType == <span class="keyword">null</span> || contentType.startsWith(MediaType.APPLICATION_FORM_URLENCODED_VALUE)) &#123;</span><br><span class="line">					String[] params = queryBody.split(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">					<span class="keyword">for</span>(String param : params) &#123;</span><br><span class="line">						String[] par = param.split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">						<span class="keyword">if</span>(par.length != <span class="number">2</span>) <span class="keyword">break</span>;</span><br><span class="line">						requestWrapper.put(par[<span class="number">0</span>], par[<span class="number">1</span>]);</span><br><span class="line">					&#125;<span class="comment">//for</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="comment">//if</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">//支持 前端用 x-www 或 form-data 时 后端用 JavaBean 接收</span></span><br><span class="line">			<span class="comment">//或者 body 没有数据时 param有数据 把 param内容放到 body 中</span></span><br><span class="line">			<span class="keyword">if</span>((requestWrapper.getBodySize() == <span class="number">0</span> || HttpMethod.GET.matches(request.getMethod())) &amp;&amp; </span><br><span class="line">					(contentType == <span class="keyword">null</span> || </span><br><span class="line">					contentType.startsWith(MediaType.APPLICATION_FORM_URLENCODED_VALUE) </span><br><span class="line">							|| contentType.startsWith(MediaType.MULTIPART_FORM_DATA_VALUE) </span><br><span class="line">							|| contentType.startsWith(MediaType.APPLICATION_JSON_VALUE))) &#123;</span><br><span class="line">				Map&lt;String,String&gt; map = requestWrapper.getParameterMapEx();</span><br><span class="line">				<span class="keyword">if</span>(!map.isEmpty()) &#123;</span><br><span class="line">					String mapJson = JSON.toJSONString(map)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\&quot;\\&#123;&quot;</span>,<span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\\&#125;\&quot;&quot;</span>, <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\&quot;\\[&quot;</span>,<span class="string">&quot;[&quot;</span>)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\\]\&quot;&quot;</span>, <span class="string">&quot;]&quot;</span>)</span><br><span class="line">							.replaceAll(<span class="string">&quot;\\\\\&quot;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">					requestWrapper.rewriteBody(mapJson);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="comment">//else</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//劫持返回信息</span></span><br><span class="line">		<span class="keyword">boolean</span> isMeHook = <span class="keyword">false</span>;</span><br><span class="line">		ResponseWrapper proxyResponse;</span><br><span class="line">		<span class="keyword">if</span> (response <span class="keyword">instanceof</span> ResponseWrapper)</span><br><span class="line">			proxyResponse = (ResponseWrapper) response;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			proxyResponse = <span class="keyword">new</span> ResponseWrapper(response);</span><br><span class="line">			isMeHook = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		chain.doFilter(requestWrapper, proxyResponse);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(response != <span class="keyword">null</span> &amp;&amp; (response.getContentType() == <span class="keyword">null</span> || response.getContentType().startsWith(MediaType.APPLICATION_JSON_VALUE)))</span><br><span class="line">			log.info(<span class="string">&quot;ResponseBody Secret(&#123;&#125;) Detail(&#123;&#125;)&quot;</span>, response <span class="keyword">instanceof</span> CryptoHttpServletResponse, <span class="keyword">new</span> String(proxyResponse.getContent()));</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			log.info(<span class="string">&quot;ResponseBody Detail(&#123;&#125;)&quot;</span>, <span class="string">&quot;内容未知 type:&quot;</span> + response.getContentType());</span><br><span class="line">		</span><br><span class="line">		Long elapsedTime = DateUtil.nanosToMillis(DateUtil.spendNt(startTime));</span><br><span class="line">		log.info(<span class="string">&quot;QueryEnd-Url:&quot;</span> + request.getRequestURI() + <span class="string">&quot; elapsedTime(&quot;</span> + elapsedTime + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(isMeHook)</span><br><span class="line">			proxyResponse.finish();</span><br><span class="line">	&#125;<span class="comment">// method</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getContentType</span><span class="params">(String contentType)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.isEmpty(contentType))</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;NONE&quot;</span>;</span><br><span class="line">		<span class="keyword">if</span>(contentType.indexOf(<span class="string">&quot;;&quot;</span>) != -<span class="number">1</span>) </span><br><span class="line">			contentType = contentType.split(<span class="string">&quot;;&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">if</span>(contentType.indexOf(<span class="string">&quot;/&quot;</span>) != -<span class="number">1</span>)</span><br><span class="line">			contentType = contentType.split(<span class="string">&quot;/&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">return</span> contentType;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDevInfo</span><span class="params">(String agent)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getIpAddress</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="comment">// class</span></span><br></pre></td></tr></table></figure>

<p>手动把 queryString的参数放到 requestBody 中去</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>很多人会搞不明白 content-type 的区别</p>
<p>明明说了 用 JSON 请求 参数却放在 param 中</p>
<p>或者需要放在 param 中的参数 放到 body 中 或者参数放到 url 中</p>
<p>如果后端不区分这些 不论 param url body 全部都处理 都可以自由接收</p>
<p>那将极大的降低对接口的工作量</p>
<p>只是有太多情况需要考虑 一点点完善吧~</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>RequestBody</tag>
        <tag>RequestParam</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义排序</title>
    <url>/2022/01/27/2022-01-27%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%92%E5%BA%8F/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>新增功能时发现 修改个 栏目 修改了2秒多 速度很慢</p>
<p>查找了下代码 原来是 自定义 栏目排序的 order</p>
<p>同事写的逻辑 </p>
<p>查出所有的 栏目 再一个个 Update 数量一多就会慢的要死</p>
<p>借鉴下网上其他人的思路</p>
<h1 id="偏代码角度描述方案-link"><a href="#偏代码角度描述方案-link" class="headerlink" title="偏代码角度描述方案(link)"></a>偏代码角度描述方案(<a href="https://www.jianshu.com/p/9ee708e43ebf">link</a>)</h1><h2 id="方法一-全量更新元素位置法"><a href="#方法一-全量更新元素位置法" class="headerlink" title="方法一 全量更新元素位置法"></a>方法一 全量更新元素位置法</h2><p>适用场景：排序元素数量较少</p>
<p>原理：每个元素拥有一个字段，表示元素当前排序的位置。通过前端排序，将排好的元素位置，一次性发送到后端。然后，后端统一更新所有元素的位置。</p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>实体设计：增加排序字段 <code>sort</code>，表示元素当前的位置。例如，<code>sort = 1</code>，则表示元素处于第一位。</p>
<p>接口设计：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 排序接口</span></span><br><span class="line">POST /courses/sorting</span><br><span class="line"></span><br><span class="line"><span class="comment">// 格式：JSON</span></span><br><span class="line"><span class="comment">// 数组中为元素的ID</span></span><br><span class="line"><span class="comment">// 元素在数组中的序号，表示了元素的位置</span></span><br><span class="line"><span class="comment">// 例如，ID为3的元素，排序为 1，ID为2的元素，排序为2</span></span><br><span class="line">[<span class="meta">3, 2, 4, 1</span>]</span><br></pre></td></tr></table></figure>

<p>前端逻辑：当前端排序后，或删除元素后，将剩余元素ID，以数组的形式发送给后端。数组的索引序号，则表示元素当前的排序。</p>
<p>后端实现逻辑：</p>
<ul>
<li>删除不存在前端数组中的ID。将前端 <code>ids</code>，与服务器端的 <code>ids</code> 进行对比。删除服务器端存在但前端不存在的 <code>ids</code>。</li>
<li>按照数组的排序，更新所有元素排序。</li>
</ul>
<p>总结，此方法仅适用于排序元素较少（例如，总元素为5~15个）的场景。对于大量数据排序并不适用，适合首页轮播图管理、任务卡片管理。<a href="https://links.jianshu.com/go?to=https://www.leangoo.com/">leangoo 的看板卡片管理就是采用这种方式。</a></p>
<h2 id="方法二-取中值法（推荐）"><a href="#方法二-取中值法（推荐）" class="headerlink" title="方法二 取中值法（推荐）"></a>方法二 取中值法（推荐）</h2><p>原理与实现步骤：</p>
<ol>
<li>创建元素时给元素赋默认位置（<code>pos</code>字段记录该值）。赋值规则为，当创建第一个元素时，默认位置赋值为65536，第二个元素为 <code>2 * 65536 = 13172</code>，增加第N个元素时，位置赋值为N*65536。</li>
<li>当拖拽改变元素位置时，更新 <code>pos</code>。更新规则如下：</li>
</ol>
<ul>
<li>调整一个元素到两个元素中间时，<code>(pre_item.pos + after_item.pos）/ 2 = pos</code></li>
<li>调整一个元素到第一个元素时， <code>old_first_item.pos / 2 = pos</code></li>
<li>调整一个元素到最后一个元素时， <code>old_last_item.post + 65536 = pos</code></li>
</ul>
<ol>
<li>当前后两个元素的数值，不满足整数时，更新所有元素的排序。依次给每个元素的 <code>pos</code>赋新值。例如，第一位赋值65536，第二位为<code>2 * 65536</code>，第N位赋值N*65536。</li>
</ol>
<p>通过取中值的方法，改变元素的位置。当需要按序获取时，只需要对 <code>pos</code>进行排序，就可以获取元素的位置。</p>
<p>关于中值重排的问题，解决方法有多种。例如，我们可以使用浮点数储存 <code>pos</code>，但是需要考虑数据库存储的精度问题。而且，数值过小，会在前端丢失精度，元素排序会出现问题。当然，如果在接口层，当检测到中值过小，则对所有元素进行重排，接口相应速度会存在问题（如果是后端管理系统就不用考虑性能问题了）。</p>
<p>有人提出，利用定时任务每天对所有元素定时重排，来解决单次接口的性能问题。个人觉得这个方法，还是存在问题。若定时任务不及时，那么排序由于精度问题，发生了排序错乱的问题。那么，定时重排已经无意义。</p>
<h2 id="方法三-单表单列"><a href="#方法三-单表单列" class="headerlink" title="方法三 单表单列"></a>方法三 单表单列</h2><p>每个元素，都有一个字段<code>index</code>，表示元素的排序信息。<br>规定元素从0开始递增。<br>基本操作如下：</p>
<ul>
<li>增加数据。 新增元素时，序号为当前元素数据总量值。</li>
<li>删除元素。删除元素时，将大于该元素的序号，都减1。</li>
<li>修改元素排序。当元素从 x 移动到 y 时，<ul>
<li>若 x &lt; y 时，则将(x, y)范围内的元素都减1</li>
<li>若 x &gt; y 时，则将(y, x)范围内的元素都加1</li>
</ul>
</li>
<li>查询元素。展示列表时，按照 <code>index</code> 字段进行排序即可。若需要查第n位元素时，元素位置为 <code>index = n - 1</code>。</li>
</ul>
<p>这种方式优点是，查询快，修改慢。而且，修改接口的逻辑较重，处理起来比较麻烦。我们很多项目都是采用这种模式。在接口设计方面，我们让前端传给后端是一个偏移值（<code>offset</code>），<code>offset = y - x。当元素向排序大的方向移动时，</code>offset<code>的为正值；若往排序小的方向移动时，</code>offset`为负值。</p>
<h1 id="偏数据库角度描述方案-link"><a href="#偏数据库角度描述方案-link" class="headerlink" title="偏数据库角度描述方案(link)"></a>偏数据库角度描述方案(<a href="https://www.cnblogs.com/kesimin/p/9441448.html">link</a>)</h1><h4 id="1-单表单列结构（数组结构）"><a href="#1-单表单列结构（数组结构）" class="headerlink" title="1. 单表单列结构（数组结构）"></a>1. 单表单列结构（数组结构）</h4><p>此设计是使用一个表中的一列来表示数据的序号，通常我们使用的方法就是这种。</p>
<p>数据表tb_data(n)：</p>
<table>
<thead>
<tr>
<th>data</th>
<th>index</th>
</tr>
</thead>
<tbody><tr>
<td>···</td>
<td>0</td>
</tr>
<tr>
<td>···</td>
<td>1</td>
</tr>
<tr>
<td>···</td>
<td>2</td>
</tr>
</tbody></table>
<p>这里规定序号从0开始递增。</p>
<p>其基本数据操作如下：</p>
<ul>
<li>增 → 当增加一个数据时，定义data的序号为数据总数量值。</li>
<li>删 → 当删除一个数据时，将大于该序号的数据的序号都减1。</li>
<li>改 → 当修改位置将数据a从x移动到y时，若x小于y，则将(x,y]范围内的数据序号都减1；若x大于y，则将[y,x)范围内的数据序号都加1（注：修改数据库时，要先将a的序号x修改为未被使用的序号z，然后再修改范围内的数据，最后再将z修改为y，顺序不能乱）。</li>
<li>查 → 当查找数据时添加 order by index 即可得到自定义排列的数据，查找第n个数据时查找条件为 index=n-1 即可。</li>
</ul>
<p>总结：此方法查找速度最快，修改速度最慢。</p>
<h4 id="2-单表双列结构（链表结构）"><a href="#2-单表双列结构（链表结构）" class="headerlink" title="2.单表双列结构（链表结构）"></a>2.单表双列结构（链表结构）</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">此设计是使用一个表中的两列来表示数据的序号，一列表示该数据的前置id，一列表示该数据的后置序id（id为数据表本身的自增序号），即相当于我们经常使用的双向链表。</span><br></pre></td></tr></table></figure>

<p>数据表tb_data(n)：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>data</th>
<th>pre_no</th>
<th>next_no</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>···</td>
<td>-1</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>···</td>
<td>0</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>···</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>3</td>
<td>···</td>
<td>2</td>
<td>-1</td>
</tr>
</tbody></table>
<p>这里规定第一个数据的pre_no为-1，最后一个数据的next_no为-1。</p>
<p>其基本数据操作如下：</p>
<ul>
<li>增 → 当增加一个数据a时，先查找出最后一个数据b的id号，a的pre_no定义为b的id号（若此数据为第一个则定义为-1），next_no定义为-1，再将b的next_no定义为a的id号。</li>
<li>删 → 当删除一个数据a时，取出a的pre_no和next_no，将pre_no对应的id的数据的next_no修改为a的next_no，将next_no对应的id的数据的pre_no修改为a的pre_no。</li>
<li>改 → 令位置x-1、x+1数据分别为b、c，位置y-1、y、y+1的数据分别为d、e、f，现修改位置将数据a从x移动到y时，<br>当x小于y时，修改b的next_no为c的id，修改c的pre_no为b的id，修改e的next_no为a的id，修改f的pre_no为a的id，最后修改a的pre_no为e的id，next_no为f的id；<br>当x大于y时，修改b的next_no为c的id，修改c的pre_no为b的id，修改d的next_no为a的id，修改e的pre_no为a的id，最后修改a的pre_no为d的id，next_no为e的id。</li>
<li>查 → 当查找第n个数据时，需要先查找出第一个数据，在根据第一个数据逐个往后查找数据的next_no，查找n次后得到第n个数据。</li>
</ul>
<p>总结：此方法查找速度最慢，修改速度最快。</p>
<h4 id="3-双表双列结构（分页结构）"><a href="#3-双表双列结构（分页结构）" class="headerlink" title="3.双表双列结构（分页结构）"></a>3.双表双列结构（分页结构）</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">此设计是使用一个页码表记录全部页码和页码的序号范围，另一个数据表来记录基本数据、自身序号和页码，通过在一个表中给数据设置不同的序号和页码来达到分页排序的效果。</span><br></pre></td></tr></table></figure>

<p>页码表tb_page：</p>
<table>
<thead>
<tr>
<th>tb_name</th>
<th>page</th>
<th>start_index</th>
<th>end_index</th>
</tr>
</thead>
<tbody><tr>
<td>tb_data0</td>
<td>0</td>
<td>1</td>
<td>1000</td>
</tr>
<tr>
<td>tb_data0</td>
<td>1</td>
<td>1</td>
<td>1000</td>
</tr>
<tr>
<td>tb_data0</td>
<td>2</td>
<td>1</td>
<td>120</td>
</tr>
<tr>
<td>tb_data1</td>
<td>0</td>
<td>1</td>
<td>1000</td>
</tr>
<tr>
<td>tb_data1</td>
<td>1</td>
<td>1</td>
<td>130</td>
</tr>
</tbody></table>
<p>table_name为一个基本数据表的表名，对于每一个table_name，其对应的page都从0开始递增且不能重复，每个page有一定的数据范围（这里设定为一页有1000条数据），则每个数据表对应的数据总量即可计算出来。</p>
<p>基本数据表tb_data(n)：</p>
<table>
<thead>
<tr>
<th>data</th>
<th>page</th>
<th>index</th>
</tr>
</thead>
<tbody><tr>
<td>···</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>···</td>
<td>0</td>
<td>···</td>
</tr>
<tr>
<td>···</td>
<td>0</td>
<td>1000</td>
</tr>
<tr>
<td>···</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>···</td>
<td>1</td>
<td>···</td>
</tr>
<tr>
<td>···</td>
<td>1</td>
<td>1000</td>
</tr>
<tr>
<td>···</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>···</td>
<td>2</td>
<td>···</td>
</tr>
<tr>
<td>···</td>
<td>2</td>
<td>120</td>
</tr>
</tbody></table>
<p>data为数据域，记录基本数据，对于每一个不相同的data都有对应的page和index，通过page、index和每一页的数据范围即可计算出对应的全局序号。</p>
<p>其基本数据操作如下：</p>
<ul>
<li>增 → 当增加一个数据时，先从页码表中查找出最后的page及其对应的start_index和end_index，若end_index-start_index+1没有数据超出范围，则插入数据的page不变，index为end_index+1，若超出范围，则需在页码表中新建一页，插入数据的page自加一，index赋值初始值。</li>
<li>删 → 当删除一个数据时，因为需要保证除末页以外的页码的数据范围都为规定值，所以需要对删除数据对应的页码及以上页码的数据进行调整，对于删除数据的页码，可以通过对比该数据在页码中的相对位置来调整较小数据量的一方数据执行加减1，对于大于其的页码，可以将每一页的首数据调整为上一页的末数据（末页数量为0即可将末页删除）。</li>
<li>改 → 当修改位置将数据a从x移动到y，计算x、y对应的页码，当x、y的页码相同时，只需调整该页数据，可通过对比x到y的数量和页码数量来决定调整x、y范围内还是范围外的数据信息；当x、y页码不同时，可通过对x、y在页码中的相对位置来调整较小数据量的一方数据执行加减1，若x小于y，(x,y]范围内的页的首数据调整为上一页的末数据，若x大于y，[y,x)范围内的页的末数据调整为下一页的首数据。</li>
<li>查 → 当查找数据总量时，可以通过查找页码表计算得出；当查找序号为n的数据时，可以通过页码表计算得到对应的page和index，然后再通过查找数据表取得数据（由于页码表的数据会经常使用，所以最好从数据库取出一次后保存在内存中再进行使用即可提高速度）。</li>
</ul>
<p>总结：此方法查找速度和修改速度比较均衡，适合大多数情况使用。</p>
<h1 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h1><p>手动控制加数值or减数值 +1/-1   +10/-10</p>
<p>按照数值大小排序</p>
<p>和指定 数值 差不多的逻辑</p>
]]></content>
      <categories>
        <category>编程</category>
      </categories>
      <tags>
        <tag>排序</tag>
        <tag>转载</tag>
      </tags>
  </entry>
  <entry>
    <title>Dubbo ExceedPayloadLimitException</title>
    <url>/2022/03/08/2022-03-08%20Dubbo%20Data%20length%20too%20large/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="Data-length-too-large"><a href="#Data-length-too-large" class="headerlink" title="Data length too large"></a>Data length too large</h1><p>这个异常的详细堆栈信息如下所示：</p>
<blockquote>
<p>Caused by: org.apache.dubbo.remoting.transport.ExceedPayloadLimitException: Data length too large: 11557979, max payload: 11557050, channel: NettyChannel [channel=[id: 0x59059885, L:/172.30.0.3:50822 - R:/172.30.0.3:20880]]</p>
</blockquote>
<p>已经从8388608 改到 11557979 依旧报错</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ProviderConfig <span class="title">providerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ProviderConfig config = <span class="keyword">new</span> ProviderConfig();</span><br><span class="line">    config.setRetries(<span class="number">0</span>);</span><br><span class="line">    config.setTimeout(<span class="number">60000</span>);</span><br><span class="line">    config.setPayload(<span class="number">11557979</span>);</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本来想从 11557979  直接改到 104857600 100兆</p>
<p>仔细想想不对</p>
<p>这里是 请求或者响应的报文体长度超过了8k </p>
<p>我请求的内容应该没有这么长</p>
<p>检查了下</p>
<p>原来是之前写的 SpringCloud 整合 Dubbo (<a href="/2021/04/23/2021-04-23%20%20SpringCloud%20%E6%95%B4%E5%90%88%20Dubbo/">Link</a>) <strong>#### 封装 dubbo 隐式传递</strong></p>
<p>中写了一个 日志收集</p>
<p>这个调用时 同步数据 同步了一个多小时 产生了超过8兆的日志</p>
<p>而我为了日志追踪 把日志放在 dubbo 的请求参数中 导致了长度超过dubbo的限制</p>
<p>还有个类似 <a href="https://github.com/apache/dubbo/issues/111">dubbo 抛不出自定义的异常</a> 的问题</p>
<p>这个我已经自己写了一个异常过滤器(SpringCloud 整合 Dubbo <strong># 异常传递</strong>) 但是偶尔还是有自定义异常 被认定为 Rpc 异常的问题</p>
<p>大概是我封装的依赖包 有时 几个微服务依赖的依赖包版本不相同 加密出来的jar包逻辑不同导致</p>
<p>有空再研究下</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Dubbo</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
        <tag>Dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>SSL/TSL SNI</title>
    <url>/2022/03/15/2022-03-15%20%20SNI/</url>
    <content><![CDATA[<span id="more"></span>

<h1 id="SNI-Server-Name-Indication-是什么"><a href="#SNI-Server-Name-Indication-是什么" class="headerlink" title="SNI(Server Name Indication)是什么"></a>SNI(Server Name Indication)是什么</h1><blockquote>
<p>在使用TLS的时候，http server希望根据HTTP请求中HOST的不同，来决定使用不同的证书。</p>
</blockquote>
<p>在使用没有使用 TLS时 服务器可以通过 http 请求中的 Host 区分用户请求的是哪个网站</p>
<p>但是通过 TLS 请求握手时 并不知道 Host 早期的服务器是直接返回第一个证书</p>
<p>就导致了 1个ip 只能绑定一个 域名的 https</p>
<blockquote>
<p>这个问题是早期 SSL2.0 时就引入的一个问题，由此 SNI 协议就诞生了。SNI 协议允许客户端在发起 SSL 握手请求时，就提交请求的 Host 信息，使服务器能够切换到正确的域并返回相应的证书。</p>
<p>SNI（Server Name Indication）是为了解决一个服务器使用多个域名和证书的 SSL/TLS 扩展。一句话简述它的工作原理就是，在连接到服务器建立 SSL 连接之前先发送要访问站点的域名（Hostname），这样服务器根据这个域名返回一个合适的证书。目前，大多数操作系统和浏览器都已经很好地支持 SNI 扩展，OpenSSL 0.9.8 已经内置这一功能。</p>
</blockquote>
<h1 id="SNI阻断"><a href="#SNI阻断" class="headerlink" title="SNI阻断"></a>SNI阻断</h1><p>以下内容摘自《SNI阻断与解决方案》：</p>
<blockquote>
<p>在建立新的TLS连接时，客户端（如浏览器）发出的第一个握手包（称为Client Hello）中，包含了想要访问的域名信息（称为SNI，Server Name Indication）。<br>某些服务器会同时支持多个域名。在加密传输之前，它需要知道客户端访问的是哪个域名。于是SNI必须以明文的方式传输。并且由于浏览器并不知道服务器是否需要SNI，浏览器会对所有的TLS握手都加入SNI。<br>于是，根据黑名单，某些防火墙可以根据明文SNI信息，对TLS连接进行精确阻断。</p>
</blockquote>
<h1 id="解决SNI阻断"><a href="#解决SNI阻断" class="headerlink" title="解决SNI阻断"></a>解决SNI阻断</h1><h2 id="1-去除SNI"><a href="#1-去除SNI" class="headerlink" title="1.去除SNI"></a>1.去除SNI</h2><p>大部分解决SNI阻断的工具基本就是 去除掉 SNI 让服务端 以旧版本SSL的逻辑 提供默认证书</p>
<p>这需要 GFW 没有把这些网站的IP封锁 只阻断 SNI </p>
<h2 id="2-域前置-Domain-Fronting"><a href="#2-域前置-Domain-Fronting" class="headerlink" title="2.域前置(Domain Fronting)"></a>2.域前置(Domain Fronting)</h2><p>也是去除SNI或者说是替换掉SNI</p>
<p>SNI 写访问A网站 但是http host填写的是B 网站</p>
<p>cloudflare CDN就有这个功能</p>
<p>我自己弄的使用 cloudflare 搭建的 免翻墙 <a href="https://ancient-mud-95e3.lqs1848.workers.dev/">Pronhub</a> </p>
<p>(原先是域前置 现在应该变成纯粹的 CDN 了Host给的也是 CDN的加速域名)</p>
<p>Domain Fronting的工作原理:</p>
<blockquote>
<ul>
<li>用户用合法的域名<code>allow.com</code>向DNS请求CDN的IP，然后向CDN发起请求，这一步自然是没有任何问题的</li>
<li>因为在处理HTTPS请求时，CDN会首先将它解密，并根据HTTP Host的值做请求转发，所以用户想要访问一个非法网站<code>forbidden.com</code>，可以使用一个CDN上的合法的域名<code>allow.com</code>作为SNI，然后使用<code>forbidden.com</code>作为HTTP Host与CDN进行HTTPS通信</li>
<li>由于HTTP Host只能被转发看到，而审查者是看不到的，故CDN会放过这条请求，并将HTTP请求根据HTTP Host重新封装，发往<code>forbidden.com</code>的服务器</li>
<li>这种情况下，客户端实际通信的对象是<code>forbidden.com</code>，但在流量监控设备看来，客户端是在与<code>allow.com</code>通信，即客户端将流量成功伪装成了与<code>allow.com</code>通信的流量</li>
</ul>
</blockquote>
<h1 id="ESNI（Encrypted-SNI）"><a href="#ESNI（Encrypted-SNI）" class="headerlink" title="ESNI（Encrypted SNI）"></a>ESNI（Encrypted SNI）</h1><p>SNI 是明文的 会被 GFW 识别阻断 并且SPI 或任何中间代理 都可以获取到 SSL请求中的SNI 从而记录你访问的内容</p>
<p>ESNI 就是为了解决该问题而诞生的</p>
<blockquote>
<p>ESNI（Encrypted SNI）正如其名，其设计的目标就是为了加密 SNI，是最先为解决这一问题提出的一个 TLS 拓展。虽然这一方案即将被废弃，但对于了解其后继者 ECH 有着极大的帮助。</p>
<p>ESNI 为了能够让客户端获得密钥发送密文，依赖于另一个服务 DNS 来分发密钥。客户端在使用 ESNI 连接服务器之前，会在常规的请求网站 IP 的 A/AAAA 请求上再进行一次 TXT 的请求以获得 ESNI 的公钥</p>
</blockquote>
<p>将加密的公钥放到 记录到DNS当中 DNS必须采用 DoH（DNS over HTTPS）</p>
<p>DNS把公钥给到客户端后 客户端使用 公钥加密 SNI 得到 ESNI</p>
<h1 id="ECH（Encrypted-Client-Hello）"><a href="#ECH（Encrypted-Client-Hello）" class="headerlink" title="ECH（Encrypted Client Hello）"></a>ECH（Encrypted Client Hello）</h1><p>相比 ESNI 只加密了 SNI </p>
<p>ECH 把 SSL中的  Client Hello 消息 整个加密了</p>
<h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>有点圆环套圆环的感觉</p>
<p>SSL 通过证书信任建立了安全通信</p>
<p>但为了一个IP能部署多个域名 使用多个证书</p>
<p>SSL 引入了 SNI 来识别本次加密使用的证书</p>
<p>又为了加密 SNI 让 DNS 使用 DoH 加密通信 再提供一个公钥</p>
<p>保护本次 SSL 的 握手请求</p>
<p>最终 DNS 的 DoH 其实还是只能有一个证书</p>
<p>ESNI和ECH的普及 必定会导致 GFW 升级</p>
<p>一刀切把所有加密请求 和 黑名单网站的所有IP都拦截</p>
]]></content>
      <categories>
        <category>NetWork</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
        <tag>HTTPS</tag>
        <tag>GFW</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring参数绑定(三)</title>
    <url>/2022/05/12/2022-05-12%20%20Spring%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9A(%E4%B8%89)/</url>
    <content><![CDATA[<span id="more"></span>

<p>之前写的能接受所有Content-Type参数的方法</p>
<h1 id="可能会导致的问题"><a href="#可能会导致的问题" class="headerlink" title="可能会导致的问题"></a>可能会导致的问题</h1><p>最近面前端 经常问面试者 有没有碰到过跨域然后怎么处理</p>
<p>突然想到一点</p>
<p>跨域这件事 都是浏览器在控制</p>
<p>如果 后端的所有参数都可以随意传递</p>
<p>那么原本是需要判断 跨域的复杂请求</p>
<p>就可以被前端以简单请求的方式去请求到</p>
<h1 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h1><p>后端一个接口 </p>
<p>只接收 JSON 参数 Content-Type 为 application/json</p>
<p>但是由于后端一般不会去写限制 Content-Type 的逻辑</p>
<p>一般就区分个 Get Post</p>
<p>JSON 参数 的接口 是复杂请求接口 </p>
<p>本来如果被浏览器调用时需要判断跨域的</p>
<p>但是如果参数可以随意携带 后端也能获取到的话</p>
<p>前端可以用 multipart/form-data 或 application/x-www-http-urlencoded</p>
<p>将请求变成 简单请求 浏览器就不会发出 预检请求(OPTIONS请求)</p>
<h1 id="怎么解决"><a href="#怎么解决" class="headerlink" title="怎么解决"></a>怎么解决</h1><p>如果可以的话 判断请求的 referer 必须是自己的网站就好了</p>
<h1 id="end"><a href="#end" class="headerlink" title="end"></a>end</h1><p>大概这也就是 Spring 要区分 @RquestParam @RquestBody 的部分原因吧</p>
<p>不过如果是提供 API 给其它后端调用就无所谓了</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Spring</tag>
        <tag>RequestBody</tag>
        <tag>RequestParam</tag>
      </tags>
  </entry>
  <entry>
    <title>MyBatisPlusJoin单表Join多次</title>
    <url>/2022/08/25/2022-08-25%20%20MyBatisPlusJoin%E5%8D%95%E8%A1%A8Join%E5%A4%9A%E6%AC%A1/</url>
    <content><![CDATA[<span id="more"></span>

<p>MyBatis Plus Join<br>用的是 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.yulichang&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis-plus-join&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.2.4&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>


<h1 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h1><p>大概是 一个轨迹逻辑信息表 需要关联多个点位的名称<br>点位表 需要被 轨迹信息关联多次<br>而 我使用的这个 MyBatisPlusJoin 无法关联单表多次 (特指 Lambda 形式)</p>
<h1 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h1><p>研究源码发现<br>无法链接单表多次的主要原因是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * 关联的表</span><br><span class="line">    *&#x2F;</span><br><span class="line">   protected Map&lt;Class&lt;?&gt;, Integer&gt; subTable &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 表序号</span><br><span class="line"> *&#x2F;</span><br><span class="line">private int tableIndex &#x3D; 1;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>框架用于记录本次查询的SQL 使用了<br>Class 作为 Key<br>tableIndex 作为 Value<br>导致 同一张表 Join 多次 生成出来的SQL<br>都会是最后一次JOIN的那个表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">join.leftJoin(FwServicePoint.class, FwServicePoint::getServicePointId, FwTrackDistance::getSpBeginId);</span><br><span class="line">join.leftJoin(FwServicePoint.class, FwServicePoint::getServicePointId, FwTrackDistance::getSpEndId);</span><br></pre></td></tr></table></figure>
<p>同样的 FwServicePoint.class 给到的 TABLE_ALIAS 会是一样的<br>生成出来的SQL会是<br>JOIN FW_SERVICE_POINT t2 on(xx=xx)<br>JOIN FW_SERVICE_POINT t2 on(xx=xx)</p>
<p>这样就有两种方式去解决</p>
<p>一种是<br>    将 FwServicePoint 这张表 建立多个映射的 javabean<br>如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">join.leftJoin(FwServicePointStart.class, FwServicePointStart::getServicePointId, FwTrackDistance::getSpBeginId);</span><br><span class="line">join.leftJoin(FwServicePointEnd.class, FwServicePointEnd::getServicePointId, FwTrackDistance::getSpEndId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@TableName(&quot;FW_SERVICE_POINT&quot;)</span><br><span class="line">public class FwServicePoint &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line">@TableName(&quot;FW_SERVICE_POINT&quot;)</span><br><span class="line">public class FwServicePointStart &#123;</span><br><span class="line">	&#x2F;&#x2F;复制出来只用于 join的映射对象</span><br><span class="line">&#125;</span><br><span class="line">@TableName(&quot;FW_SERVICE_POINT&quot;)</span><br><span class="line">public class FwServicePointEnd &#123;</span><br><span class="line">	&#x2F;&#x2F;复制出来只用于 join的映射对象</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>另一种就是修改框架了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 别名对应表名</span><br><span class="line"> *&#x2F;</span><br><span class="line">   protected Map&lt;String, Integer&gt; tableAliasMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">&#x2F;*</span><br><span class="line">大概逻辑就是 leftjoin 时携带一个 表别名 然后记录 当前表 join 时的 tableIndex</span><br><span class="line">生成 join条件时 从 tableAliasMap 去获取 tableIndex 而不是 subTable</span><br><span class="line"></span><br><span class="line">修改 MPJLambdaWrapper 中的 SelectColumn 添加 tableAlias 字段</span><br><span class="line">在 leftJoin 方法中添加 tableAlias 参数</span><br><span class="line">*&#x2F;</span><br></pre></td></tr></table></figure>
<p>修改源码如下</p>
<p>JoinWrapper = MPJLambdaWrapper</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Objects;</span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line">import java.util.function.Predicate;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.conditions.SharedString;</span><br><span class="line">import com.baomidou.mybatisplus.core.conditions.segments.MergeSegments;</span><br><span class="line">import com.baomidou.mybatisplus.core.metadata.TableFieldInfo;</span><br><span class="line">import com.baomidou.mybatisplus.core.metadata.TableInfo;</span><br><span class="line">import com.baomidou.mybatisplus.core.metadata.TableInfoHelper;</span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.ArrayUtils;</span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.Assert;</span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;</span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.StringUtils;</span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.support.SFunction;</span><br><span class="line">import com.github.yulichang.toolkit.Constant;</span><br><span class="line">import com.github.yulichang.toolkit.LambdaUtils;</span><br><span class="line">import com.github.yulichang.wrapper.enums.BaseFuncEnum;</span><br><span class="line">import com.github.yulichang.wrapper.interfaces.Query;</span><br><span class="line">import com.mysd.framework.mybatis.wrapper.interfaces.QuickJoinFunction;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line">import lombok.Getter;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 魔改 mybatis-plus-join</span><br><span class="line"> * </span><br><span class="line"> * </span><br><span class="line"> * 允许两张表 允许同时 join 多次</span><br><span class="line"> * selectAll 忽略 select &#x3D; false 的字段</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class JoinWrapper&lt;T&gt; extends JoinAbstractLambdaWrapper&lt;T, JoinWrapper&lt;T&gt;&gt;</span><br><span class="line">		implements Query&lt;JoinWrapper&lt;T&gt;&gt;, LambdaJoin&lt;JoinWrapper&lt;T&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * </span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private static final long serialVersionUID &#x3D; 1L;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 查询字段 sql</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private SharedString sqlSelect &#x3D; new SharedString();</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 查询表</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private final SharedString from &#x3D; new SharedString();</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 主表别名</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private final SharedString alias &#x3D; new SharedString(Constant.TABLE_ALIAS);</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 查询的字段</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private final List&lt;SelectColumn&gt; selectColumns &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 忽略查询的字段</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private final List&lt;SelectColumn&gt; ignoreColumns &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 是否 select distinct</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private boolean selectDistinct &#x3D; false;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 表序号</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private int tableIndex &#x3D; 1;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * ON sql wrapper集合</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private final List&lt;JoinWrapper&lt;?&gt;&gt; onWrappers &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 连表关键字 on 条件 func 使用</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	@Getter</span><br><span class="line">	private String keyWord;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 连表实体类 on 条件 func 使用</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	@Getter</span><br><span class="line">	private Class&lt;?&gt; joinClass;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 连表别名</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	@Getter</span><br><span class="line">	private String tableAlias;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 不建议直接 new 该实例，使用 JoinWrapper.&lt;UserDO&gt;lambdaQuery()</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	public JoinWrapper() &#123;</span><br><span class="line">		super.initNeed();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 不建议直接 new 该实例，使用 JoinWrapper.&lt;UserDO&gt;lambdaQuery()</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	JoinWrapper(T entity, Class&lt;T&gt; entityClass, SharedString sqlSelect, AtomicInteger paramNameSeq,</span><br><span class="line">			Map&lt;String, Object&gt; paramNameValuePairs, MergeSegments mergeSegments, SharedString lastSql,</span><br><span class="line">			SharedString sqlComment, SharedString sqlFirst, Map&lt;Class&lt;?&gt;, Integer&gt; subTable, String keyWord,</span><br><span class="line">			Class&lt;?&gt; joinClass, String tableAlias) &#123;</span><br><span class="line">		super.setEntity(entity);</span><br><span class="line">		super.setEntityClass(entityClass);</span><br><span class="line">		this.paramNameSeq &#x3D; paramNameSeq;</span><br><span class="line">		this.paramNameValuePairs &#x3D; paramNameValuePairs;</span><br><span class="line">		this.expression &#x3D; mergeSegments;</span><br><span class="line">		this.sqlSelect &#x3D; sqlSelect;</span><br><span class="line">		this.lastSql &#x3D; lastSql;</span><br><span class="line">		this.sqlComment &#x3D; sqlComment;</span><br><span class="line">		this.sqlFirst &#x3D; sqlFirst;</span><br><span class="line">		this.subTable &#x3D; subTable;</span><br><span class="line">		this.keyWord &#x3D; keyWord;</span><br><span class="line">		this.joinClass &#x3D; joinClass;</span><br><span class="line">		this.tableAlias &#x3D; tableAlias;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * sql去重 select distinct</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	public JoinWrapper&lt;T&gt; distinct() &#123;</span><br><span class="line">		this.selectDistinct &#x3D; true;</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	@SafeVarargs</span><br><span class="line">	public final &lt;S&gt; JoinWrapper&lt;T&gt; select(SFunction&lt;S, ?&gt;... columns) &#123;</span><br><span class="line">		if (ArrayUtils.isNotEmpty(columns)) &#123;</span><br><span class="line">			for (SFunction&lt;S, ?&gt; s : columns) &#123;</span><br><span class="line">				selectColumns.add(SelectColumn.of(LambdaUtils.getEntityClass(s), getCache(s).getColumn()));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public &lt;E&gt; JoinWrapper&lt;T&gt; select(Class&lt;E&gt; entityClass, Predicate&lt;TableFieldInfo&gt; predicate) &#123;</span><br><span class="line">		TableInfo info &#x3D; TableInfoHelper.getTableInfo(entityClass);</span><br><span class="line">		Assert.notNull(info, &quot;table can not be find&quot;);</span><br><span class="line">		info.getFieldList().stream().filter(predicate).collect(Collectors.toList())</span><br><span class="line">				.forEach(i -&gt; selectColumns.add(SelectColumn.of(entityClass, i.getColumn())));</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public &lt;S, X&gt; JoinWrapper&lt;T&gt; selectAs(String tableAlias, SFunction&lt;S, ?&gt; column, SFunction&lt;X, ?&gt; alias) &#123;</span><br><span class="line">		selectColumns.add(SelectColumn.of(LambdaUtils.getEntityClass(column), getCache(column).getColumn(),</span><br><span class="line">				LambdaUtils.getName(alias), tableAlias));</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public &lt;S&gt; JoinWrapper&lt;T&gt; selectAs(SFunction&lt;S, ?&gt; column, String alias) &#123;</span><br><span class="line">		selectColumns.add(SelectColumn.of(LambdaUtils.getEntityClass(column), getCache(column).getColumn(), alias));</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public &lt;S&gt; JoinWrapper&lt;T&gt; selectFunc(boolean condition, BaseFuncEnum funcEnum, SFunction&lt;S, ?&gt; column,</span><br><span class="line">			String alias) &#123;</span><br><span class="line">		if (condition) &#123;</span><br><span class="line">			selectColumns.add(</span><br><span class="line">					SelectColumn.of(LambdaUtils.getEntityClass(column), getCache(column).getColumn(), alias, funcEnum));</span><br><span class="line">		&#125;</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public JoinWrapper&lt;T&gt; selectFunc(boolean condition, BaseFuncEnum funcEnum, Object column, String alias) &#123;</span><br><span class="line">		if (condition) &#123;</span><br><span class="line">			selectColumns.add(SelectColumn.of(null, column.toString(), alias, funcEnum));</span><br><span class="line">		&#125;</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public final JoinWrapper&lt;T&gt; selectAll(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">		TableInfo info &#x3D; TableInfoHelper.getTableInfo(clazz);</span><br><span class="line">		Assert.notNull(info, &quot;table can not be find -&gt; %s&quot;, clazz);</span><br><span class="line">		if (info.havePK()) &#123;</span><br><span class="line">			selectColumns.add(SelectColumn.of(clazz, info.getKeyColumn()));</span><br><span class="line">		&#125;</span><br><span class="line">		info.getFieldList().forEach(c -&gt; &#123;</span><br><span class="line">			if (c.isSelect())</span><br><span class="line">				selectColumns.add(SelectColumn.of(clazz, c.getColumn()));</span><br><span class="line">		&#125;);</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	@SafeVarargs</span><br><span class="line">	public final &lt;S&gt; JoinWrapper&lt;T&gt; selectIgnore(SFunction&lt;S, ?&gt;... columns) &#123;</span><br><span class="line">		if (ArrayUtils.isNotEmpty(columns)) &#123;</span><br><span class="line">			for (SFunction&lt;S, ?&gt; s : columns) &#123;</span><br><span class="line">				ignoreColumns.add(SelectColumn.of(LambdaUtils.getEntityClass(s), getCache(s).getColumn()));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 查询条件 SQL 片段</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	@Override</span><br><span class="line">	public String getSqlSelect() &#123;</span><br><span class="line">		if (StringUtils.isBlank(sqlSelect.getStringValue())) &#123;</span><br><span class="line">			if (CollectionUtils.isNotEmpty(ignoreColumns)) &#123;</span><br><span class="line">				selectColumns.removeIf(c -&gt; c.getFuncEnum() &#x3D;&#x3D; null &amp;&amp; ignoreColumns.stream().anyMatch(</span><br><span class="line">						i -&gt; i.getClazz() &#x3D;&#x3D; c.getClazz() &amp;&amp; Objects.equals(c.getColumnName(), i.getColumnName())));</span><br><span class="line">			&#125;</span><br><span class="line">			String s &#x3D; selectColumns.stream().map(i -&gt; &#123;</span><br><span class="line">				String str &#x3D; Constant.TABLE_ALIAS + getDefault(</span><br><span class="line">						i.getTableAlias() !&#x3D; null ? tableAliasMap.get(i.getTableAlias()) : subTable.get(i.getClazz()))</span><br><span class="line">						+ StringPool.DOT + i.getColumnName();</span><br><span class="line">				return (i.getFuncEnum() &#x3D;&#x3D; null ? str : String.format(i.getFuncEnum().getSql(), str))</span><br><span class="line">						+ (StringUtils.isBlank(i.getAlias()) ? StringPool.EMPTY : (Constant.AS + i.getAlias()));</span><br><span class="line">			&#125;).collect(Collectors.joining(StringPool.COMMA));</span><br><span class="line">			sqlSelect.setStringValue(s);</span><br><span class="line">		&#125;</span><br><span class="line">		return sqlSelect.getStringValue();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 获取连表部分语句</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	public String getFrom() &#123;</span><br><span class="line">		if (StringUtils.isBlank(from.getStringValue())) &#123;</span><br><span class="line">			StringBuilder value &#x3D; new StringBuilder();</span><br><span class="line">			for (JoinWrapper&lt;?&gt; wrapper : onWrappers) &#123;</span><br><span class="line">				String tableName &#x3D; TableInfoHelper.getTableInfo(wrapper.getJoinClass()).getTableName();</span><br><span class="line"></span><br><span class="line">				String tableNameDefAlias &#x3D; Constant.TABLE_ALIAS + subTable.get(wrapper.getJoinClass());</span><br><span class="line">				String tableNameAlias &#x3D; Constant.TABLE_ALIAS</span><br><span class="line">						+ (wrapper.getTableAlias() !&#x3D; null ? tableAliasMap.get(wrapper.getTableAlias())</span><br><span class="line">								: subTable.get(wrapper.getJoinClass()));</span><br><span class="line"></span><br><span class="line">				String whereSql &#x3D; wrapper.getExpression().getNormal().getSqlSegment();</span><br><span class="line">				&#x2F;&#x2F; 为了实现 多次关联的表 可以写在 左边 也可以写在 右边 使用 replace 进行补救</span><br><span class="line">				if (!tableNameDefAlias.equals(tableNameAlias))</span><br><span class="line">					whereSql &#x3D; whereSql.replaceAll(tableNameDefAlias + StringPool.BACK_SLASH + StringPool.DOT,</span><br><span class="line">							tableNameAlias + StringPool.BACK_SLASH + StringPool.DOT);</span><br><span class="line"></span><br><span class="line">				value.append(wrapper.getKeyWord()).append(tableName).append(StringPool.SPACE).append(tableNameAlias)</span><br><span class="line">						.append(Constant.ON).append(whereSql);</span><br><span class="line">			&#125;</span><br><span class="line">			from.setStringValue(value.toString());</span><br><span class="line">		&#125;</span><br><span class="line">		return from.getStringValue();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getAlias() &#123;</span><br><span class="line">		return alias.getStringValue();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public boolean getSelectDistinct() &#123;</span><br><span class="line">		return selectDistinct;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 用于生成嵌套 sql</span><br><span class="line">	 * &lt;p&gt;</span><br><span class="line">	 * 故 sqlSelect 不向下传递</span><br><span class="line">	 * &lt;&#x2F;p&gt;</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	@Override</span><br><span class="line">	protected JoinWrapper&lt;T&gt; instance() &#123;</span><br><span class="line">		return instance(null, null, null);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	protected JoinWrapper&lt;T&gt; instance(String keyWord, Class&lt;?&gt; joinClass, String tableAlias) &#123;</span><br><span class="line">		return new JoinWrapper&lt;&gt;(getEntity(), getEntityClass(), null, paramNameSeq, paramNameValuePairs,</span><br><span class="line">				new MergeSegments(), SharedString.emptyString(), SharedString.emptyString(), SharedString.emptyString(),</span><br><span class="line">				this.subTable, keyWord, joinClass, tableAlias);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void clear() &#123;</span><br><span class="line">		super.clear();</span><br><span class="line">		sqlSelect.toNull();</span><br><span class="line">		from.toNull();</span><br><span class="line">		selectColumns.clear();</span><br><span class="line">		ignoreColumns.clear();</span><br><span class="line">		subTable.clear();</span><br><span class="line">		tableAliasMap.clear();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public &lt;R&gt; JoinWrapper&lt;T&gt; join(String keyWord, boolean condition, Class&lt;R&gt; clazz, QuickJoinFunction function,</span><br><span class="line">			String tableAlias) &#123;</span><br><span class="line">		if (condition) &#123;</span><br><span class="line">			JoinWrapper&lt;?&gt; apply &#x3D; function.apply(instance(keyWord, clazz, tableAlias));</span><br><span class="line">			onWrappers.add(apply);</span><br><span class="line">			subTable.put(clazz, tableIndex);</span><br><span class="line">			if (tableAlias !&#x3D; null)</span><br><span class="line">				tableAliasMap.put(tableAlias, tableIndex);</span><br><span class="line">			tableIndex++;</span><br><span class="line">		&#125;</span><br><span class="line">		return typedThis;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public JoinWrapper&lt;T&gt; limit(Integer num)&#123;</span><br><span class="line">		return last(&quot;limit &quot; + num);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * select字段</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	@Data</span><br><span class="line">	private static class SelectColumn &#123;</span><br><span class="line"></span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * 字段实体类</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		private Class&lt;?&gt; clazz;</span><br><span class="line"></span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * 表 别名</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		private String tableAlias;</span><br><span class="line"></span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * 数据库字段名</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		private String columnName;</span><br><span class="line"></span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * 字段别名</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		private String alias;</span><br><span class="line"></span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * 字段函数</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		private BaseFuncEnum funcEnum;</span><br><span class="line"></span><br><span class="line">		&#x2F;**</span><br><span class="line">		 * 自定义函数填充参数</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		private List&lt;SFunction&lt;?, ?&gt;&gt; funcArgs;</span><br><span class="line"></span><br><span class="line">		private SelectColumn(Class&lt;?&gt; clazz, String columnName, String alias, String tableAlias,</span><br><span class="line">				BaseFuncEnum funcEnum) &#123;</span><br><span class="line">			this.clazz &#x3D; clazz;</span><br><span class="line">			this.columnName &#x3D; columnName;</span><br><span class="line">			this.alias &#x3D; alias;</span><br><span class="line">			this.tableAlias &#x3D; tableAlias;</span><br><span class="line">			this.funcEnum &#x3D; funcEnum;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		public static SelectColumn of(Class&lt;?&gt; clazz, String columnName) &#123;</span><br><span class="line">			return new SelectColumn(clazz, columnName, null, null, null);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		public static SelectColumn of(Class&lt;?&gt; clazz, String columnName, String alias) &#123;</span><br><span class="line">			return new SelectColumn(clazz, columnName, alias, null, null);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		public static SelectColumn of(Class&lt;?&gt; clazz, String columnName, String alias, BaseFuncEnum funcEnum) &#123;</span><br><span class="line">			return new SelectColumn(clazz, columnName, alias, null, funcEnum);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		public static SelectColumn of(Class&lt;?&gt; clazz, String columnName, String alias, String tableAlias) &#123;</span><br><span class="line">			return new SelectColumn(clazz, columnName, alias, tableAlias, null);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JoinAbstractLambdaWrapper = MPJAbstractLambdaWrapper</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.support.ColumnCache;</span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.support.SFunction;</span><br><span class="line">import com.github.yulichang.toolkit.Constant;</span><br><span class="line">import com.github.yulichang.toolkit.LambdaUtils;</span><br><span class="line">import com.github.yulichang.wrapper.MPJAbstractWrapper;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Objects;</span><br><span class="line"></span><br><span class="line">import static java.util.stream.Collectors.joining;</span><br><span class="line"></span><br><span class="line">public abstract class JoinAbstractLambdaWrapper&lt;T, Children extends JoinAbstractLambdaWrapper&lt;T, Children&gt;&gt;</span><br><span class="line">        extends MPJAbstractWrapper&lt;T, Children&gt; &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 关联的表</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected Map&lt;Class&lt;?&gt;, Integer&gt; subTable &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">	 * 别名对应表名</span><br><span class="line">	 *&#x2F;</span><br><span class="line">    protected Map&lt;String, Integer&gt; tableAliasMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 缓存字段</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected Map&lt;Class&lt;?&gt;, Map&lt;String, ColumnCache&gt;&gt; columnMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected &lt;X&gt; String columnToString(X column) &#123;</span><br><span class="line">        return columnToString((SFunction&lt;?, ?&gt;) column);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    @SafeVarargs</span><br><span class="line">    protected final &lt;X&gt; String columnsToString(X... columns) &#123;</span><br><span class="line">        return Arrays.stream(columns).map(i -&gt; columnToString((SFunction&lt;?, ?&gt;) i)).collect(joining(StringPool.COMMA));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected String columnToString(SFunction&lt;?, ?&gt; column) &#123;</span><br><span class="line">        return Constant.TABLE_ALIAS + getDefault(subTable.get(LambdaUtils.getEntityClass(column))) + StringPool.DOT +</span><br><span class="line">                getCache(column).getColumn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected ColumnCache getCache(SFunction&lt;?, ?&gt; fn) &#123;</span><br><span class="line">        Class&lt;?&gt; aClass &#x3D; LambdaUtils.getEntityClass(fn);</span><br><span class="line">        Map&lt;String, ColumnCache&gt; cacheMap &#x3D; columnMap.get(aClass);</span><br><span class="line">        if (cacheMap &#x3D;&#x3D; null) &#123;</span><br><span class="line">            cacheMap &#x3D; LambdaUtils.getColumnMap(aClass);</span><br><span class="line">            columnMap.put(aClass, cacheMap);</span><br><span class="line">        &#125;</span><br><span class="line">        return cacheMap.get(LambdaUtils.formatKey(LambdaUtils.getName(fn)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected String getDefault(Integer i) &#123;</span><br><span class="line">        if (Objects.nonNull(i)) &#123;</span><br><span class="line">            return i.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        return StringPool.EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>LambdaJoin</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import com.baomidou.mybatisplus.core.toolkit.support.SFunction;</span><br><span class="line">import com.github.yulichang.interfaces.MPJBaseJoin;</span><br><span class="line">import com.github.yulichang.toolkit.Constant;</span><br><span class="line">import com.mysd.framework.mybatis.wrapper.interfaces.QuickJoinFunction;</span><br><span class="line"></span><br><span class="line">public interface LambdaJoin&lt;Children&gt; extends MPJBaseJoin &#123;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * left join</span><br><span class="line">	 *</span><br><span class="line">	 * @param clazz 关联的实体类</span><br><span class="line">	 * @param left  条件</span><br><span class="line">	 * @param right 条件</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T, X&gt; Children leftJoin(Class&lt;T&gt; clazz, SFunction&lt;T, ?&gt; left, SFunction&lt;X, ?&gt; right) &#123;</span><br><span class="line">		return leftJoin(true, clazz, left, right, null);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	default &lt;T, X&gt; Children leftJoin(Class&lt;T&gt; clazz, SFunction&lt;T, ?&gt; left, SFunction&lt;X, ?&gt; right, String tableAlias) &#123;</span><br><span class="line">		return leftJoin(true, clazz, left, right, tableAlias);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * left join</span><br><span class="line">	 * &lt;p&gt;</span><br><span class="line">	 * 例 leftJoin(UserDO.class, on -&gt;</span><br><span class="line">	 * on.eq(UserDO::getId,UserAddressDO::getUserId).le().gt()...)</span><br><span class="line">	 *</span><br><span class="line">	 * @param clazz    关联的实体类</span><br><span class="line">	 * @param function 条件</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T&gt; Children leftJoin(Class&lt;T&gt; clazz, QuickJoinFunction function) &#123;</span><br><span class="line">		return leftJoin(true, clazz, function, null);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	default &lt;T&gt; Children leftJoin(Class&lt;T&gt; clazz, QuickJoinFunction function, String tableAlias) &#123;</span><br><span class="line">		return leftJoin(true, clazz, function, tableAlias);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * left join</span><br><span class="line">	 *</span><br><span class="line">	 * @param condition 是否执行</span><br><span class="line">	 * @param clazz     关联的实体类</span><br><span class="line">	 * @param left      条件</span><br><span class="line">	 * @param right     条件</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T, X&gt; Children leftJoin(boolean condition, Class&lt;T&gt; clazz, SFunction&lt;T, ?&gt; left, SFunction&lt;X, ?&gt; right,</span><br><span class="line">			String tableAlias) &#123;</span><br><span class="line">		return leftJoin(condition, clazz, on -&gt; &#123;</span><br><span class="line">			return on.eq(left, right);</span><br><span class="line">		&#125;, tableAlias);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * left join</span><br><span class="line">	 * &lt;p&gt;</span><br><span class="line">	 * 例 leftJoin(UserDO.class, on -&gt;</span><br><span class="line">	 * on.eq(UserDO::getId,UserAddressDO::getUserId).le().gt()...)</span><br><span class="line">	 *</span><br><span class="line">	 * @param condition 是否执行</span><br><span class="line">	 * @param clazz     关联实体类</span><br><span class="line">	 * @param function  条件</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T&gt; Children leftJoin(boolean condition, Class&lt;T&gt; clazz, QuickJoinFunction function, String tableAlias) &#123;</span><br><span class="line">		return join(Constant.LEFT_JOIN, condition, clazz, function, tableAlias);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * ignore 参考 left join</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T, X&gt; Children rightJoin(Class&lt;T&gt; clazz, SFunction&lt;T, ?&gt; left, SFunction&lt;X, ?&gt; right) &#123;</span><br><span class="line">		return rightJoin(true, clazz, left, right);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * ignore 参考 left join</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T&gt; Children rightJoin(Class&lt;T&gt; clazz, QuickJoinFunction function) &#123;</span><br><span class="line">		return rightJoin(true, clazz, function);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * ignore 参考 left join</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T, X&gt; Children rightJoin(boolean condition, Class&lt;T&gt; clazz, SFunction&lt;T, ?&gt; left, SFunction&lt;X, ?&gt; right) &#123;</span><br><span class="line">		return rightJoin(condition, clazz, on -&gt; on.eq(left, right));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * ignore 参考 left join</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T&gt; Children rightJoin(boolean condition, Class&lt;T&gt; clazz, QuickJoinFunction function) &#123;</span><br><span class="line">		return join(Constant.RIGHT_JOIN, condition, clazz, function, null);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * ignore 参考 left join</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T, X&gt; Children innerJoin(Class&lt;T&gt; clazz, SFunction&lt;T, ?&gt; left, SFunction&lt;X, ?&gt; right) &#123;</span><br><span class="line">		return innerJoin(true, clazz, left, right);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * ignore 参考 left join</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T&gt; Children innerJoin(Class&lt;T&gt; clazz, QuickJoinFunction function) &#123;</span><br><span class="line">		return innerJoin(true, clazz, function);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * ignore 参考 left join</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T, X&gt; Children innerJoin(boolean condition, Class&lt;T&gt; clazz, SFunction&lt;T, ?&gt; left, SFunction&lt;X, ?&gt; right) &#123;</span><br><span class="line">		return innerJoin(condition, clazz, on -&gt; on.eq(left, right));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * ignore 参考 left join</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	default &lt;T&gt; Children innerJoin(boolean condition, Class&lt;T&gt; clazz, QuickJoinFunction function) &#123;</span><br><span class="line">		return join(Constant.INNER_JOIN, condition, clazz, function, null);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * 查询基类 可以直接调用此方法实现以上所有功能</span><br><span class="line">	 *</span><br><span class="line">	 * @param keyWord   连表关键字</span><br><span class="line">	 * @param condition 是否执行</span><br><span class="line">	 * @param clazz     连表实体类</span><br><span class="line">	 * @param function  关联条件</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	&lt;T&gt; Children join(String keyWord, boolean condition, Class&lt;T&gt; clazz, QuickJoinFunction function, String tableAlias);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Java</category>
        <category>MyBatis</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>MyBatis</tag>
        <tag>MyBatis Plus</tag>
        <tag>MyBatis Plus Join</tag>
      </tags>
  </entry>
</search>
